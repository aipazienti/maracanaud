<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MARACA ‚Ä¢ Maxi Studio (01‚Üí05)</title>
<meta name="theme-color" content="#000000"/>
<style>
  :root{
    --bg:#06070b;
    --panel:#0d1118;
    --panel2:#111826;
    --txt:#eaf0ff;
    --muted:#91a0b8;
    --accent:#00ff88;
    --cyan:#00d4ff;
    --warn:#ffaa00;
    --bad:#ff5f6d;
    --line:1px solid rgba(255,255,255,.10);
    --r:16px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  body{overflow:hidden}
  .topbar{
    position:fixed;left:0;right:0;top:0;z-index:50;
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    padding:10px 12px;
    background:linear-gradient(180deg,rgba(0,0,0,.92),rgba(0,0,0,.55));
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
  }
  .brand{font-weight:900;letter-spacing:.12em;font-size:12px;color:var(--accent);}
  .btn{
    border:var(--line);
    background:rgba(255,255,255,.05);
    color:var(--txt);
    padding:9px 12px;border-radius:999px;
    cursor:pointer;font-weight:800;font-size:12px;
    display:inline-flex;align-items:center;gap:8px;
    transition:transform .08s ease, background .12s ease;
    user-select:none;
  }
  .btn:hover{background:rgba(255,255,255,.10)}
  .btn:active{transform:scale(.98)}
  .btn.primary{border-color:rgba(0,255,136,.55);background:rgba(0,255,136,.10);}
  .btn.cyan{border-color:rgba(0,212,255,.5);background:rgba(0,212,255,.09);}
  .btn.warn{border-color:rgba(255,170,0,.45);background:rgba(255,170,0,.08);}
  .btn.bad{border-color:rgba(255,95,109,.45);background:rgba(255,95,109,.09);}
  .spacer{flex:1}
  .pill{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);
    color:var(--muted);
    padding:7px 10px;border-radius:999px;
    font-size:12px;font-weight:700;display:inline-flex;gap:8px;align-items:center;
    white-space:nowrap;
  }
  .dot{width:8px;height:8px;border-radius:99px;background:#333;display:inline-block}
  .dot.on{background:var(--accent); box-shadow:0 0 10px rgba(0,255,136,.65);}
  .dot.mic{background:var(--bad); box-shadow:0 0 12px rgba(255,95,109,.6);}
  .dot.mic.on{background:var(--bad);}
  .main{
    position:fixed;inset:54px 0 0 0;
    padding:14px;
    overflow:auto;
  }
  .grid{
    max-width:1200px;margin:0 auto;
    display:grid;grid-template-columns:1fr;gap:12px;
  }
  .card{
    background:linear-gradient(160deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.10);
    border-radius:var(--r);
    padding:14px;
    box-shadow:0 18px 60px rgba(0,0,0,.45);
  }
  .card h2{font-size:14px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
  .mixer-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
  .mx{min-width:220px;flex:1;}
  .mx label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);font-weight:800;margin-bottom:6px;}
  .mx input[type=range]{width:100%;accent-color:var(--accent);}
  .small{font-size:12px;color:var(--muted);line-height:1.45;}
  .modal{
    position:fixed;inset:0;display:none;z-index:100;
    background:rgba(0,0,0,.72);
    padding:14px;
    align-items:center;justify-content:center;
  }
  .modal.show{display:flex;}
  .modalCard{
    width:min(1400px,96vw);
    height:min(860px,92vh);
    border-radius:22px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(10,12,16,.85);
    backdrop-filter: blur(16px);
    box-shadow:0 30px 120px rgba(0,0,0,.65);
    overflow:hidden;
    display:flex;flex-direction:column;
  }
  .modalHdr{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.25));
  }
  .modalHdr b{letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--txt);}
  .modalHdr .hint{font-size:12px;color:var(--muted);}
  .modalBody{flex:1;position:relative;background:#000;}
  iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:#000;}
  .toast{
    position:fixed;left:12px;bottom:12px;z-index:200;
    max-width:min(560px,92vw);
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(15,18,24,.85);
    color:var(--txt);
    box-shadow:0 18px 70px rgba(0,0,0,.55);
    display:none;
  }
  .toast.show{display:block;}
  .toast .t{font-weight:900;font-size:12px;letter-spacing:.05em;margin-bottom:4px;}
  .toast .m{font-size:12px;color:var(--muted);line-height:1.35;}
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">MARACA ‚Ä¢ MAXI STUDIO</div>

  <button class="btn primary" onclick="MaracaHost.open('ACC')">01 ‚Ä¢ ACCORDATORE</button>
  <button class="btn cyan" onclick="MaracaHost.open('LOOP')">02 ‚Ä¢ LOOP</button>
  <button class="btn warn" onclick="MaracaHost.open('DJ')">03 ‚Ä¢ DJ</button>
  <button class="btn" onclick="MaracaHost.open('SYNTH')">04 ‚Ä¢ SYNTH</button>
  <button class="btn" onclick="MaracaHost.open('SEQ')">05 ‚Ä¢ SEQUENCER</button>

  <div class="spacer"></div>

  <div class="pill" title="Audio Engine (unico AudioContext)">
    <span class="dot" id="audDot"></span>
    AUDIO <b id="audState">OFF</b>
  </div>
  <div class="pill" title="Microfono (una sola sezione alla volta)">
    <span class="dot mic" id="micDot"></span>
    MIC <b id="micState">LIBERO</b>
  </div>
</div>

<div class="main">
  <div class="grid">
    <div class="card">
      <h2>Output mixer generale</h2>
      <div class="mixer-row">
        <div class="mx">
          <label><span>MASTER</span><span id="masterVal">80%</span></label>
          <input type="range" min="0" max="100" value="80" oninput="MaracaHost.setMaster(this.value)">
        </div>
        <div class="mx">
          <label><span>01 ACCORDATORE</span><span id="gACCVal">100%</span></label>
          <input type="range" min="0" max="100" value="100" oninput="MaracaHost.setSectionGain('ACC', this.value)">
        </div>
        <div class="mx">
          <label><span>02 LOOP</span><span id="gLOOPVal">100%</span></label>
          <input type="range" min="0" max="100" value="100" oninput="MaracaHost.setSectionGain('LOOP', this.value)">
        </div>
        <div class="mx">
          <label><span>03 DJ</span><span id="gDJVal">100%</span></label>
          <input type="range" min="0" max="100" value="100" oninput="MaracaHost.setSectionGain('DJ', this.value)">
        </div>
        <div class="mx">
          <label><span>04 SYNTH</span><span id="gSYNTHVal">100%</span></label>
          <input type="range" min="0" max="100" value="100" oninput="MaracaHost.setSectionGain('SYNTH', this.value)">
        </div>
        <div class="mx">
          <label><span>05 SEQUENCER</span><span id="gSEQVal">100%</span></label>
          <input type="range" min="0" max="100" value="100" oninput="MaracaHost.setSectionGain('SEQ', this.value)">
        </div>

        <button class="btn bad" onclick="MaracaHost.releaseMic()">RILASCIA MIC</button>
        <button class="btn" onclick="MaracaHost.resumeAudio()">SBLOCCA AUDIO</button>
      </div>

      <div class="small" style="margin-top:10px;">
        ‚Ä¢ <b>Input (microfono)</b> √® gestito a priorit√†: <b>01</b> (Accordatore) &gt; <b>02</b> (Loop) &gt; altre.
        Se una sezione sta usando il microfono, le altre verranno silenziate (richiesta negata) finch√© non chiudi la sezione o tocchi ‚ÄúRILASCIA MIC‚Äù.<br/>
        ‚Ä¢ <b>Output</b>: tutte le sezioni condividono un singolo AudioContext + mixer generale, con volume per-sezione e master.
      </div>
    </div>

    <div class="card">
      <h2>Interfaccia</h2>
      <div class="small">
        Apri una sezione dai pulsanti in alto: si apre in <b>popup</b> con <b>Chiudi</b>.
        Le app originali sono mantenute (CSS/JS inclusi) e instradate nel mixer comune.
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modalCard">
    <div class="modalHdr">
      <button class="btn bad" onclick="MaracaHost.close()">CHIUDI</button>
      <b id="modalTitle">‚Äî</b>
      <span class="hint" id="modalHint"></span>
      <div class="spacer"></div>
      <button class="btn" onclick="MaracaHost.reloadActive()">RIAVVIA SEZIONE</button>
    </div>
    <div class="modalBody">
      <iframe id="appFrame" allow="autoplay; microphone"></iframe>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastT">‚Äî</div>
  <div class="m" id="toastM">‚Äî</div>
</div>

<script>
const __SECTION_HTML__ = {
  ACC: `<!DOCTYPE html>
<html lang="it">
<head>
<script>
/* MaxiHost bootstrap for section ACC */
(function(){
  const SECTION_ID = 'ACC';
  // ---- Shared audio routing via parent ----
  function getProxy(){
    const host = window.parent && window.parent.MaracaHost;
    if (!host) return null;
    return host.getAudioProxy(SECTION_ID);
  }
  const proxy = getProxy();
  if (proxy) {
    // Replace constructors used by apps
    window.AudioContext = function(){ return proxy; };
    window.webkitAudioContext = function(){ return proxy; };
  }

  // ---- Mic gating (single-owner) ----
  const md = navigator.mediaDevices;
  if (md && md.getUserMedia) {
    const orig = md.getUserMedia.bind(md);
    md.getUserMedia = function(constraints){
      const host = window.parent && window.parent.MaracaHost;
      if (!host) return orig(constraints);
      return host.requestMic(SECTION_ID, constraints);
    };
  }

  // ---- Resume helper (some apps call ctx.resume on user gesture) ----
  window.addEventListener('pointerdown', () => {
    try {
      const host = window.parent && window.parent.MaracaHost;
      if (host) host.resumeAudio();
    } catch(e){}
  }, {passive:true});
})();
<\/script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>maracanaudio ‚Äì Accordatore</title>

<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
.app{position:fixed;inset:0;display:flex;background:radial-gradient(circle at center,#151515 0%,#000 70%);color:#fff;}
.tuner{flex:1;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;padding:12px;gap:10px;}
.topRow{display:flex;justify-content:space-between;align-items:center;gap:8px;}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);font-weight:900;}
.btn{border:none;cursor:pointer;padding:10px 14px;border-radius:14px;font-weight:900;color:#fff;background:#2a5298;transition:transform .12s ease;user-select:none;}
.btn:active{transform:scale(0.98);}
.btn.secondary{background:rgba(255,255,255,0.12);}
.btn.danger{background:#dc3545;}
.readout{display:flex;flex-direction:column;align-items:center;gap:4px;padding-top:2px;}
.noteLine{font-size:48px;font-weight:1000;text-shadow:0 0 18px rgba(0,255,0,0.35);}
.freqLine{font-size:22px;font-weight:900;}
.deltaLine{font-size:18px;font-weight:900;color:#ffd700;}
.meter{position:relative;flex:1;min-height:140px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.12);overflow:hidden;}
.scale{position:absolute;inset:0;display:flex;justify-content:space-between;padding:0 24px;}
.mark{width:2px;background:rgba(255,255,255,0.2);position:relative;}
.mark.center{width:3px;background:#00ff00;box-shadow:0 0 16px rgba(0,255,0,0.6);}
.label{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:12px;font-weight:900;opacity:0.7;white-space:nowrap;}
.needle{position:absolute;top:10%;height:80%;width:4px;left:50%;transform:translateX(-50%);border-radius:2px;background:#ff3333;box-shadow:0 0 16px rgba(255,0,0,0.6);transition:left .08s ease-out;}
.needle.ok{background:#00ff00;box-shadow:0 0 18px rgba(0,255,0,0.7);}
.status{text-align:center;padding:8px;border-radius:14px;font-weight:1000;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);}
.status.good{background:rgba(0,255,0,0.18);color:#d9ffd9;border-color:rgba(0,255,0,0.25);}
.status.low{background:rgba(255,68,68,0.18);border-color:rgba(255,68,68,0.25);}
.status.high{background:rgba(255,136,0,0.18);border-color:rgba(255,136,0,0.25);}

.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.82);z-index:999;padding:14px;}
.overlayCard{width:min(520px,96vw);background:#fff;color:#111;border-radius:18px;padding:18px;box-shadow:0 18px 70px rgba(0,0,0,0.45);text-align:center;}
.overlayCard h2{font-size:20px;font-weight:1000;margin-bottom:8px;}
.overlayCard p{font-size:14px;font-weight:750;color:#444;line-height:1.4;margin-bottom:14px;}
.overlayRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.overlayRow .btn{min-width:160px;}
.err{display:none;margin-top:12px;color:#b00020;font-weight:900;font-size:13px;white-space:pre-wrap;}

.refModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.72);z-index:1200;padding:14px;}
.refModal.show{display:flex;}
.refCard{width:min(520px,96vw);background:#fff;color:#111;border-radius:18px;padding:18px;text-align:left;box-shadow:0 18px 70px rgba(0,0,0,0.45);}
.refCard h3{font-size:18px;font-weight:1000;margin-bottom:10px;}
.refRow{display:flex;gap:10px;align-items:center;}
.refRow input{flex:1;padding:12px 12px;border-radius:14px;border:2px solid #ddd;font-size:16px;font-weight:900;outline:none;}
.hint{margin-top:10px;font-size:13px;font-weight:800;color:#555;}

@media (orientation:landscape) and (max-height:520px){
  .topRow{display:none;}
  .readout{gap:2px;}
  .noteLine{font-size:30px;}
  .freqLine{font-size:16px;}
  .deltaLine{font-size:14px;}
  .meter{flex:1;min-height:160px;}
  .status{font-size:14px;padding:6px;}
}
</style>
</head>

<body>
<div class="app">
  <div class="tuner" id="tunerRoot">
    <div class="topRow">
      <div class="pill">A4 <span id="refVal">440.0 Hz</span></div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn secondary" id="refBtn">LA (A4)</button>
        <button class="btn danger" id="stopBtn" style="display:none;">STOP</button>
      </div>
    </div>

    <div class="readout">
      <div class="noteLine" id="noteName">‚Äî</div>
      <div class="freqLine" id="freqNow">‚Äî Hz</div>
      <div class="deltaLine" id="deltaNow">0 cents</div>
    </div>

    <div class="meter" id="meter">
      <div class="scale" id="scale"></div>
      <div class="needle" id="needle"></div>
    </div>

    <div class="status" id="status">Tocca AVVIA per iniziare</div>
  </div>
</div>

<div class="overlay" id="startOverlay">
  <div class="overlayCard">
    <h2>Accordatore</h2>
    <p>
      Tocca "AVVIA" per attivare il microfono.<br/>
      LA di riferimento: <b id="overlayRef">440.0 Hz</b>
    </p>
    <div class="overlayRow">
      <button class="btn secondary" id="overlayRefBtn">Cambia LA</button>
      <button class="btn" id="startBtn">AVVIA</button>
    </div>
    <div class="err" id="overlayErr"></div>
  </div>
</div>

<div class="refModal" id="refModal">
  <div class="refCard">
    <h3>Imposta LA (A4) manualmente</h3>
    <div class="refRow">
      <input id="refInput" type="number" min="380" max="520" step="0.1" value="440.0" />
      <button class="btn" id="refApply">Applica</button>
    </div>
    <div class="hint">Suggeriti: 440 (standard), 432, 442.</div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button class="btn secondary" id="refClose">Chiudi</button>
    </div>
  </div>
</div>

<script>
"use strict";

// ‚îÄ‚îÄ‚îÄ ERRORE UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showErr(msg){ overlayErr.style.display="block"; overlayErr.textContent=msg; }
function hideErr(){ overlayErr.style.display="none"; overlayErr.textContent=""; }

// ‚îÄ‚îÄ‚îÄ STATO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioContext, analyser, micSource, streamRef, rafId;
let isRunning = false;
let referenceA4 = 440.0;

// ‚îÄ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const refVal        = document.getElementById('refVal');
const overlayRef    = document.getElementById('overlayRef');
const noteNameEl    = document.getElementById('noteName');
const freqNowEl     = document.getElementById('freqNow');
const deltaNowEl    = document.getElementById('deltaNow');
const statusEl      = document.getElementById('status');
const needleEl      = document.getElementById('needle');
const scaleEl       = document.getElementById('scale');
const stopBtn       = document.getElementById('stopBtn');
const startOverlay  = document.getElementById('startOverlay');
const startBtn      = document.getElementById('startBtn');
const overlayRefBtn = document.getElementById('overlayRefBtn');
const overlayErr    = document.getElementById('overlayErr');
const refBtn        = document.getElementById('refBtn');
const refModal      = document.getElementById('refModal');
const refInput      = document.getElementById('refInput');
const refApply      = document.getElementById('refApply');
const refClose      = document.getElementById('refClose');

// ‚îÄ‚îÄ‚îÄ NOTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NOTE_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTE_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const clamp = (n,a,b) => Math.max(a,Math.min(b,n));

function freqToMidi(f)  { return 69 + 12*Math.log2(f/referenceA4); }
function midiToFreq(m)  { return referenceA4*Math.pow(2,(m-69)/12); }
function midiToName(midi, preferFlats){
  const n=Math.round(midi);
  const octave=Math.floor(n/12)-1;
  const idx=(n%12+12)%12;
  const name=preferFlats?NOTE_FLAT[idx]:NOTE_SHARP[idx];
  return {name,octave};
}
function centsDiff(freq,target){ return 1200*Math.log2(freq/target); }
function formatNameBoth(midi){
  const s=midiToName(midi,false), f=midiToName(midi,true);
  if(s.name!==f.name) return \`${s.name}${s.octave} / ${f.name}${f.octave}\`;
  return \`${s.name}${s.octave}\`;
}

// ‚îÄ‚îÄ‚îÄ SCALA VISIVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getZoomRange(absC){
  if(absC>80)  return 150;
  if(absC>40)  return 80;
  if(absC>20)  return 40;
  if(absC>10)  return 20;
  if(absC>5)   return 10;
  return 5;
}
function drawScale(range){
  scaleEl.innerHTML="";
  let step=10;
  if(range<=20) step=5;
  if(range<=10) step=2;
  if(range<=5)  step=1;
  for(let c=-range;c<=range;c+=step){
    const mark=document.createElement("div");
    mark.className=(c===0)?"mark center":"mark";
    const major=(range>=80)?20:(range>=40?10:(range>=20?10:(range>=10?5:2)));
    if(c===0 || (Math.abs(c)%major===0)){
      const lab=document.createElement("span");
      lab.className="label"; lab.textContent=c;
      mark.appendChild(lab);
    }
    scaleEl.appendChild(mark);
  }
}

// ‚îÄ‚îÄ‚îÄ COSTANTI DI RILEVAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FFT_SIZE = 4096;          // ‚Üë era 2048 ‚Äî pi√π campioni = pi√π risoluzione temporale per note acute
const RMS_MIN  = 0.015;
const CONF_MIN = 0.82;          // ‚Üë soglia pi√π alta per ridurre falsi positivi
const NOTE_HYSTERESIS_CENTS = 22;
const STABLE_FRAMES_REQUIRED = 3;

// Range chitarra standard: E2(82Hz) ‚Äì E5(1319Hz)
const FREQ_MIN = 70;
const FREQ_MAX = 1400;

// ‚îÄ‚îÄ‚îÄ ALGORITMO DI PITCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Usa YIN semplificato + correzione d'ottava via HPS (Harmonic Product Spectrum)
// YIN √® molto pi√π accurato dell'autocorrelazione semplice per note acute

function calcRMS(buf){
  let s=0;
  for(let i=0;i<buf.length;i++) s+=buf[i]*buf[i];
  return Math.sqrt(s/buf.length);
}

// Differenza quadratica media (core di YIN)
function yinDifference(buf, W){
  const d = new Float32Array(W);
  d[0] = 0;
  for(let tau=1;tau<W;tau++){
    let s=0;
    for(let i=0;i<W;i++){
      const diff = buf[i] - buf[i+tau];
      s += diff*diff;
    }
    d[tau] = s;
  }
  return d;
}

// Differenza cumulativa normalizzata
function yinCMND(d){
  const cmnd = new Float32Array(d.length);
  cmnd[0] = 1;
  let runningSum = 0;
  for(let tau=1;tau<d.length;tau++){
    runningSum += d[tau];
    cmnd[tau] = (runningSum === 0) ? 0 : d[tau] * tau / runningSum;
  }
  return cmnd;
}

// Parabolic interpolation per sub-sample precision
function parabolicInterp(arr, x){
  if(x<=0 || x>=arr.length-1) return x;
  const a=arr[x-1], b=arr[x], c=arr[x+1];
  const denom = 2*(a - 2*b + c);
  if(Math.abs(denom)<1e-10) return x;
  return x + (a - c)/denom;
}

// Rilevazione pitch principale con YIN
function detectPitchYIN(buf, sr){
  const rms = calcRMS(buf);
  if(rms < RMS_MIN) return {freq:-1, confidence:0, rms};

  const W = Math.floor(buf.length / 2);
  const d    = yinDifference(buf, W);
  const cmnd = yinCMND(d);

  // Calcola tau_min corrispondente a FREQ_MAX
  // Calcola tau_max corrispondente a FREQ_MIN
  const tauMin = Math.floor(sr / FREQ_MAX);
  const tauMax = Math.min(W-1, Math.ceil(sr / FREQ_MIN));

  const threshold = 0.10; // YIN threshold ‚Äî pi√π basso = pi√π sensibile

  // Cerca il primo minimo sotto la soglia
  let bestTau = -1;
  let bestVal = 1;

  // Prima pass: cerca minimo sotto soglia
  for(let tau=tauMin; tau<=tauMax; tau++){
    if(cmnd[tau] < threshold){
      // Verifica che sia un minimo locale
      while(tau+1<=tauMax && cmnd[tau+1]<cmnd[tau]) tau++;
      bestTau = tau;
      bestVal = cmnd[tau];
      break;
    }
  }

  // Se non trovato sotto soglia, usa il minimo assoluto
  if(bestTau === -1){
    for(let tau=tauMin; tau<=tauMax; tau++){
      if(cmnd[tau] < bestVal){ bestVal=cmnd[tau]; bestTau=tau; }
    }
  }

  if(bestTau === -1 || bestVal > 0.35) return {freq:-1, confidence:0, rms};

  // Sub-sample con interpolazione parabolica
  const tauInterp = parabolicInterp(cmnd, bestTau);
  const freq = sr / tauInterp;

  if(freq < FREQ_MIN || freq > FREQ_MAX) return {freq:-1, confidence:0, rms};

  // Confidence: pi√π basso cmnd = pi√π sicuro; scala invertita
  const confidence = clamp(1 - bestVal, 0, 1) * clamp(rms/0.05, 0.1, 1);

  return {freq, confidence, rms};
}

// ‚îÄ‚îÄ‚îÄ CORREZIONE OTTAVA via HPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Se la nota rilevata √® troppo bassa rispetto al segnale FFT, correggi all'ottava superiore.
// Questo risolve il problema classico di chitarra dove si rileva la fondamentale sbagliata.
function correctOctaveHPS(detectedFreq, fftBuf, sr){
  if(!fftBuf || fftBuf.length === 0) return detectedFreq;

  // Funzione per ottenere ampiezza FFT a una certa frequenza (interpolazione lineare)
  const getAmp = (f) => {
    const bin = f * fftBuf.length / sr;
    const i = Math.floor(bin);
    if(i<0 || i>=fftBuf.length-1) return 0;
    const frac = bin - i;
    // fftBuf contiene dB (da getFloatFrequencyData), normalizza
    const a = Math.pow(10, fftBuf[i]/20);
    const b = Math.pow(10, fftBuf[i+1]/20);
    return a*(1-frac) + b*frac;
  };

  const f1 = detectedFreq;
  const f2 = detectedFreq * 2; // ottava sopra
  if(f2 > FREQ_MAX) return f1;

  const amp1 = getAmp(f1);
  const amp2 = getAmp(f2);

  // Se l'armonica 2x √® significativamente pi√π forte della fondamentale rilevata,
  // √® probabile che la vera fondamentale sia f2 (problema di pitch dimezzato)
  // Per chitarra, le corde acute (B e E) spesso hanno armoniche pi√π forti
  if(amp2 > amp1 * 1.6){
    // Verifica che f2 sia una nota valida di chitarra
    if(f2 >= FREQ_MIN && f2 <= FREQ_MAX) return f2;
  }

  return f1;
}

// ‚îÄ‚îÄ‚îÄ SMOOTHING E STATO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let smoothFreq=null, lastStableMidi=null, stableFrames=0;

function adaptiveAlpha(freq){
  // Per note acute (>500Hz) smoothing pi√π veloce per non perdere stabilit√†
  if(freq > 500) return 0.45;
  if(freq > 250) return 0.32;
  return 0.22;
}

// ‚îÄ‚îÄ‚îÄ UPDATE UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastRange=150;
function setStatus(type,text){
  statusEl.className="status"+(type?(" "+type):"");
  statusEl.textContent=text;
}
function updateUI(freq){
  const midi=freqToMidi(freq);
  const midiR=Math.round(midi);
  const target=midiToFreq(midiR);
  const cents=centsDiff(freq,target);
  const absC=Math.abs(cents);
  const range=getZoomRange(absC);

  if(range!==lastRange){ lastRange=range; drawScale(range); }

  const clamped=clamp(cents,-range,range);
  const maxPct=48;
  const pct=(clamped/range)*maxPct;
  needleEl.style.left=\`calc(50% + ${pct}%)\`;

  if(absC<=3) needleEl.classList.add("ok"); else needleEl.classList.remove("ok");

  noteNameEl.textContent=formatNameBoth(midi);
  freqNowEl.textContent=\`${freq.toFixed(2)} Hz\`;
  deltaNowEl.textContent=\`${cents>=0?"+":""}${Math.round(cents)} cents\`;

  if(absC<=3)      setStatus("good","‚úì Perfetto (¬±3 cents)");
  else if(absC<=8) setStatus(cents<0?"low":"high", cents<0?"‚Üì Alza leggermente":"‚Üë Abbassa leggermente");
  else             setStatus(cents<0?"low":"high", cents<0?"‚Üì Troppo bassa (tira)":"‚Üë Troppo alta (molla)");
}

// ‚îÄ‚îÄ‚îÄ BUFFER FFT SEPARATO per HPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FFT_FREQ_SIZE = 8192; // grande per risoluzione in frequenza
let analyserFreq;
const FREQ_BUF = new Float32Array(FFT_FREQ_SIZE/2);

// ‚îÄ‚îÄ‚îÄ BUFFER PRINCIPALE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BUF = new Float32Array(FFT_SIZE);

// ‚îÄ‚îÄ‚îÄ LOOP PRINCIPALE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick(){
  if(!isRunning) return;

  analyser.getFloatTimeDomainData(BUF);

  // Copia buffer per YIN
  const tmp = new Float32Array(BUF);

  // Pitch detection con YIN
  let {freq, confidence, rms} = detectPitchYIN(tmp, audioContext.sampleRate);

  const valid = (freq > FREQ_MIN && freq < FREQ_MAX && confidence >= CONF_MIN);

  if(!valid){
    stableFrames = 0;
    setStatus("", "Ascolto‚Ä¶ (suona una nota)");
    rafId = requestAnimationFrame(tick);
    return;
  }

  // Correzione ottava con FFT
  if(analyserFreq){
    analyserFreq.getFloatFrequencyData(FREQ_BUF);
    freq = correctOctaveHPS(freq, FREQ_BUF, audioContext.sampleRate);
  }

  // Smoothing adattivo
  const alpha = adaptiveAlpha(freq);
  smoothFreq = (smoothFreq == null) ? freq : (smoothFreq*(1-alpha) + freq*alpha);

  const midiNow = freqToMidi(smoothFreq);
  const midiR   = Math.round(midiNow);

  if(lastStableMidi == null){ lastStableMidi=midiR; stableFrames=1; }
  else{
    const target = midiToFreq(lastStableMidi);
    const centsFrom = centsDiff(smoothFreq, target);
    if(Math.abs(centsFrom) <= NOTE_HYSTERESIS_CENTS){
      stableFrames++;
    } else {
      stableFrames = Math.max(0, stableFrames-1);
      if(stableFrames <= 0){ lastStableMidi=midiR; stableFrames=1; }
    }
  }

  if(stableFrames >= STABLE_FRAMES_REQUIRED) updateUI(smoothFreq);
  else setStatus("", "Stabilizzo‚Ä¶");

  rafId = requestAnimationFrame(tick);
}

// ‚îÄ‚îÄ‚îÄ FULLSCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function enterFullscreen(){
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen({navigationUI:"hide"});
    }
  }catch(e){}
}
async function exitFullscreen(){
  try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){}
}

// ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function start(){
  hideErr();
  if(!window.isSecureContext){
    showErr("ERRORE: microfono richiede HTTPS.\\nApri la pagina su https:// (non file://).");
    return;
  }
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    showErr("ERRORE: getUserMedia non supportato dal browser.");
    return;
  }

  startBtn.disabled=true;
  startBtn.textContent="AVVIO‚Ä¶";

  try{
    streamRef = await navigator.mediaDevices.getUserMedia({
      audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false }
    });

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if(audioContext.state==="suspended") await audioContext.resume();

    // Analyser principale per time-domain (YIN)
    analyser = audioContext.createAnalyser();
    analyser.fftSize = FFT_SIZE;
    analyser.smoothingTimeConstant = 0; // nessuno smoothing interno ‚Äî lo facciamo noi

    // Analyser secondario per frequenze (HPS octave correction)
    analyserFreq = audioContext.createAnalyser();
    analyserFreq.fftSize = FFT_FREQ_SIZE;
    analyserFreq.smoothingTimeConstant = 0.5;

    // Filtro passa-alto: elimina rumori sotto ~70Hz (botti, vibrazioni, AC)
    const hipass = audioContext.createBiquadFilter();
    hipass.type = "highpass";
    hipass.frequency.value = 70;
    hipass.Q.value = 0.7;

    // Filtro passa-basso: elimina frequenze sopra range chitarra (~1400Hz)
    const lopass = audioContext.createBiquadFilter();
    lopass.type = "lowpass";
    lopass.frequency.value = 1400;
    lopass.Q.value = 0.7;

    micSource = audioContext.createMediaStreamSource(streamRef);
    micSource.connect(hipass);
    hipass.connect(lopass);
    lopass.connect(analyser);
    lopass.connect(analyserFreq);

    isRunning = true;
    smoothFreq=null; lastStableMidi=null; stableFrames=0;

    lastRange = 999;
    drawScale(150);
    lastRange = 150;

    setStatus("", "Ascolto‚Ä¶ (suona una nota)");
    stopBtn.style.display="inline-flex";
    startOverlay.style.display="none";

    await enterFullscreen();

    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(tick);

  }catch(err){
    console.error(err);
    const name = err && err.name ? err.name : "";
    let msg = "Permesso microfono negato/non disponibile.\\n";
    if(name==="NotAllowedError"||name==="SecurityError") msg+="Consenti il microfono (lucchetto del browser) e ricarica.";
    else if(name==="NotFoundError") msg+="Nessun microfono rilevato sul dispositivo.";
    else if(name==="NotReadableError") msg+="Microfono occupato da un'altra app. Chiudi altre app e riprova.";
    else msg+="Riprova o cambia browser (Chrome/Edge/Safari).";
    showErr(msg);
    startOverlay.style.display="flex";
  } finally {
    startBtn.disabled=false;
    startBtn.textContent="AVVIA";
  }
}

// ‚îÄ‚îÄ‚îÄ STOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stop(){
  isRunning=false;
  if(rafId) cancelAnimationFrame(rafId);
  rafId=null;

  try{ if(micSource) micSource.disconnect(); }catch(e){}
  try{ if(audioContext) audioContext.close(); }catch(e){}
  if(streamRef){ try{ streamRef.getTracks().forEach(t=>t.stop()); }catch(e){} }

  micSource=null; analyser=null; analyserFreq=null; audioContext=null; streamRef=null;
  smoothFreq=null; lastStableMidi=null; stableFrames=0;

  stopBtn.style.display="none";
  setStatus("", "Fermato");
  noteNameEl.textContent="‚Äî";
  freqNowEl.textContent="‚Äî Hz";
  deltaNowEl.textContent="0 cents";
  needleEl.style.left="50%";
  needleEl.classList.remove("ok");

  startOverlay.style.display="flex";
  exitFullscreen();
}

// ‚îÄ‚îÄ‚îÄ RIFERIMENTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setReference(val){
  referenceA4 = clamp(Number(val||440), 380, 520);
  refVal.textContent  = \`${referenceA4.toFixed(1)} Hz\`;
  overlayRef.textContent = \`${referenceA4.toFixed(1)} Hz\`;
  refInput.value = referenceA4.toFixed(1);
}
setReference(440);

function openRefModal(){ refModal.classList.add("show"); }
function closeRefModal(){ refModal.classList.remove("show"); }

// ‚îÄ‚îÄ‚îÄ EVENTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
startBtn.addEventListener("click", start);
stopBtn.addEventListener("click", stop);
overlayRefBtn.addEventListener("click", openRefModal);
refBtn.addEventListener("click", openRefModal);
refApply.addEventListener("click", ()=>{ setReference(refInput.value); closeRefModal(); });
refClose.addEventListener("click", closeRefModal);
refModal.addEventListener("click", (e)=>{ if(e.target===refModal) closeRefModal(); });
document.addEventListener("visibilitychange", ()=>{ if(document.hidden && isRunning) stop(); });

startOverlay.style.display="flex";
<\/script>
</body>
</html>`,
  LOOP: `<!doctype html>
<html lang="it">
<head>
<script>
/* MaxiHost bootstrap for section LOOP */
(function(){
  const SECTION_ID = 'LOOP';
  // ---- Shared audio routing via parent ----
  function getProxy(){
    const host = window.parent && window.parent.MaracaHost;
    if (!host) return null;
    return host.getAudioProxy(SECTION_ID);
  }
  const proxy = getProxy();
  if (proxy) {
    // Replace constructors used by apps
    window.AudioContext = function(){ return proxy; };
    window.webkitAudioContext = function(){ return proxy; };
  }

  // ---- Mic gating (single-owner) ----
  const md = navigator.mediaDevices;
  if (md && md.getUserMedia) {
    const orig = md.getUserMedia.bind(md);
    md.getUserMedia = function(constraints){
      const host = window.parent && window.parent.MaracaHost;
      if (!host) return orig(constraints);
      return host.requestMic(SECTION_ID, constraints);
    };
  }

  // ---- Resume helper (some apps call ctx.resume on user gesture) ----
  window.addEventListener('pointerdown', () => {
    try {
      const host = window.parent && window.parent.MaracaHost;
      if (host) host.resumeAudio();
    } catch(e){}
  }, {passive:true});
})();
<\/script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maracaloop A ‚Äî 8 Tracce</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;600&display=swap');

    :root{
      --bg:#080b10; --panel:#0e1420; --text:#e8eeff;
      --muted:#6a7899; --red:#ff3a3a; --green:#2dff8f;
      --cyan:#00d4ff; --orange:#ffaa00;
      --stroke:#1e2840; --stroke2:#151c2e; --r:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'DM Sans',sans-serif;
      background:var(--bg);
      background-image:
        radial-gradient(ellipse 800px 400px at 20% 10%,rgba(0,100,255,.07) 0%,transparent 70%),
        radial-gradient(ellipse 600px 400px at 80% 60%,rgba(0,220,100,.05) 0%,transparent 70%);
      color:var(--text); min-height:100vh;
    }
    header{
      max-width:1120px; margin:0 auto; padding:18px 20px 12px;
      display:flex; align-items:center; justify-content:space-between;
      flex-wrap:wrap; gap:12px; border-bottom:1px solid var(--stroke);
    }
    .logo{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;letter-spacing:.15em;}
    .logo span{color:var(--cyan);}
    .top-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    select{
      font:inherit;background:var(--panel);border:1px solid var(--stroke);
      color:var(--text);padding:8px 12px;border-radius:10px;outline:none;cursor:pointer;
    }
    select:focus{border-color:rgba(0,212,255,.4);}
    button{
      font:inherit;cursor:pointer;border:1px solid var(--stroke);
      background:var(--panel);color:var(--text);padding:8px 14px;
      border-radius:10px;transition:background .15s,border-color .15s,transform .06s;
      display:inline-flex;align-items:center;gap:6px;
    }
    button:active{transform:translateY(1px);}
    button:hover{background:rgba(255,255,255,.06);}
    button:disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
    .btn-init{border-color:rgba(0,212,255,.4);color:var(--cyan);}
    .btn-play{border-color:rgba(45,255,143,.4);color:var(--green);}
    .btn-stop{border-color:rgba(255,58,58,.3);color:#ff8080;}

    .statusbar{
      max-width:1120px;margin:0 auto;padding:10px 20px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .badge{
      font-family:'Space Mono',monospace;font-size:11px;
      padding:5px 10px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.3);border-radius:999px;
      display:inline-flex;align-items:center;gap:7px;color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:50%;background:#333;flex-shrink:0;}
    .dot.on{background:var(--green);box-shadow:0 0 6px var(--green);}

    .metro-bar{
      max-width:1120px;margin:0 auto;
      padding:14px 20px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex;align-items:center;gap:14px;flex-wrap:wrap;
    }
    .metro-label{
      font-family:'Space Mono',monospace;font-size:12px;
      color:var(--muted);white-space:nowrap;letter-spacing:.1em;
    }
    .led-strip{
      display:flex;gap:4px;align-items:center;flex:1;min-width:160px;
    }
    .led{
      flex:1;height:20px;border-radius:5px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      transition:background .05s,box-shadow .05s;
      position:relative;
    }
    .led.beat1{border-color:rgba(255,58,58,.2);}
    .led.lit{
      background:rgba(255,58,58,.85);
      box-shadow:0 0 8px rgba(255,58,58,.7);
    }
    .led.beat1.lit{
      background:#ff5555;
      box-shadow:0 0 16px rgba(255,58,58,.9),0 0 4px rgba(255,58,58,.6);
    }
    .led .beat-n{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-family:'Space Mono',monospace;font-size:9px;font-weight:700;
      color:rgba(255,255,255,.25);pointer-events:none;
    }
    .led.lit .beat-n,.led.beat1.lit .beat-n{color:rgba(255,255,255,.8);}

    .led-sep{width:1px;height:20px;background:rgba(255,255,255,.08);flex-shrink:0;}

    .bpm-wrap{display:flex;align-items:center;gap:8px;flex-shrink:0;}
    .bpm-wrap label{font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);}
    input[type="number"]{
      font:inherit;width:70px;background:var(--panel);
      border:1px solid var(--stroke);color:var(--text);
      padding:7px 10px;border-radius:10px;outline:none;text-align:center;
    }
    input[type="number"]:focus{border-color:rgba(255,58,58,.5);}
    .metro-toggle{
      font-family:'Space Mono',monospace;font-size:12px;
      padding:7px 14px;border-radius:10px;
      border:1px solid rgba(255,58,58,.35);color:#ff8080;
      white-space:nowrap;
    }
    .metro-toggle.active{
      background:rgba(255,58,58,.12);
      border-color:rgba(255,58,58,.6);color:var(--red);
    }
    .beat-num{
      font-family:'Space Mono',monospace;font-size:22px;font-weight:700;
      color:rgba(255,255,255,.15);min-width:32px;text-align:center;
      transition:color .05s;
    }
    .beat-num.flash{color:var(--red);}

    main{
      max-width:1120px;margin:0 auto;
      padding:18px 20px 24px;
      display:grid;grid-template-columns:repeat(4,1fr);gap:14px;
    }
    @media(max-width:980px){main{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:520px){main{grid-template-columns:1fr;}}

    .track{
      background:var(--panel);border:1px solid var(--stroke);
      border-radius:var(--r);padding:13px;
      position:relative;overflow:hidden;transition:border-color .2s;
    }
    .track.is-rec{border-color:rgba(255,58,58,.5);}
    .track.is-countin{border-color:rgba(255,170,0,.5);}
    .track.is-play{border-color:rgba(0,212,255,.4);}
    .track.has-buffer{border-color:rgba(45,255,143,.25);}

    .track-glow{
      position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .3s;
      background:radial-gradient(circle at 50% 0%,rgba(255,58,58,.08),transparent 60%);
    }
    .track.is-rec .track-glow{opacity:1;}
    .track.is-countin .track-glow{
      background:radial-gradient(circle at 50% 0%,rgba(255,170,0,.1),transparent 60%);
      opacity:1;
    }
    .track.is-play .track-glow{
      background:radial-gradient(circle at 50% 0%,rgba(0,212,255,.07),transparent 60%);
      opacity:1;
    }
    .track>*:not(.track-glow){position:relative;}

    .track-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
    .track-num{font-family:'Space Mono',monospace;font-size:22px;font-weight:700;color:rgba(255,255,255,.12);line-height:1;}
    .track-state{
      font-size:10px;font-family:'Space Mono',monospace;
      padding:3px 7px;border-radius:999px;border:1px solid var(--stroke2);
      color:var(--muted);background:rgba(0,0,0,.3);letter-spacing:.05em;
    }
    .track-state.s-rec{border-color:rgba(255,58,58,.5);color:#ff8080;}
    .track-state.s-countin{border-color:rgba(255,170,0,.5);color:var(--orange);}
    .track-state.s-play{border-color:rgba(0,212,255,.4);color:var(--cyan);}
    .track-state.s-ready{border-color:rgba(45,255,143,.3);color:var(--green);}

    .track-leds{display:flex;gap:3px;margin-bottom:7px;}
    .t-led{
      flex:1;height:5px;border-radius:3px;
      background:rgba(255,255,255,.05);
      transition:background .06s,box-shadow .06s;
    }
    .t-led.lit{background:var(--orange);box-shadow:0 0 4px var(--orange);}
    .t-led.done{background:var(--red);box-shadow:0 0 4px var(--red);}

    .btn-main-wrap{display:flex;justify-content:center;margin:5px 0 8px;}
    .btn-main{
      width:90px;height:90px;border-radius:50%;
      border:2px solid var(--stroke);background:rgba(0,0,0,.35);
      position:relative;cursor:pointer;
      transition:border-color .2s,transform .1s;
      display:grid;place-items:center;
    }
    .btn-main:hover{transform:scale(1.04);}
    .btn-main:active{transform:scale(.97);}
    .spin-ring{
      position:absolute;inset:-6px;border-radius:50%;
      border:3px solid transparent;
      border-top-color:var(--red);border-right-color:rgba(255,58,58,.3);
      opacity:0;transition:opacity .2s;
    }
    .track.is-rec .spin-ring{opacity:1;animation:spin 1.2s linear infinite;}
    .track.is-countin .spin-ring{
      border-top-color:var(--orange);border-right-color:rgba(255,170,0,.3);
      opacity:1;animation:spin 0.6s linear infinite;
    }
    .track.is-play .spin-ring{
      border-top-color:var(--cyan);border-right-color:rgba(0,212,255,.3);
      opacity:1;animation:spin 2s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .btn-main svg{width:32px;height:32px;}

    .track-info{
      font-size:11px;color:var(--muted);text-align:center;
      min-height:14px;margin-bottom:8px;font-family:'Space Mono',monospace;
    }

    .countin-row{display:flex;align-items:center;gap:5px;margin-bottom:8px;}
    .ci-lbl{font-size:9px;font-family:'Space Mono',monospace;color:var(--muted);white-space:nowrap;}
    .ci-btn{
      font-size:10px;font-family:'Space Mono',monospace;
      padding:4px 6px;border-radius:8px;flex:1;
      justify-content:center;border:1px solid var(--stroke2);
      color:var(--muted);background:rgba(0,0,0,.2);
    }
    .ci-btn.sel{
      border-color:rgba(255,170,0,.5);color:var(--orange);
      background:rgba(255,170,0,.08);
    }

    .vol-row{display:flex;align-items:center;gap:7px;margin-bottom:8px;}
    .vol-label{font-size:9px;font-family:'Space Mono',monospace;color:var(--muted);min-width:24px;}
    input[type="range"]{
      -webkit-appearance:none;appearance:none;
      flex:1;height:4px;border-radius:999px;
      background:rgba(255,255,255,.08);outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;width:13px;height:13px;
      border-radius:50%;background:rgba(255,255,255,.8);
      border:1px solid rgba(0,0,0,.4);cursor:pointer;
    }
    .vol-pct{font-size:9px;font-family:'Space Mono',monospace;color:var(--muted);min-width:28px;text-align:right;}

    .track-btns{display:flex;gap:6px;}
    .track-btns button{flex:1;padding:7px 5px;font-size:11px;justify-content:center;border-radius:10px;}
    .btn-muted{color:#ff8080;border-color:rgba(255,58,58,.35);}

    .waveform{
      width:100%;height:30px;display:block;
      border-radius:7px;background:rgba(0,0,0,.2);margin-bottom:8px;opacity:.75;
    }

    footer{
      max-width:1120px;margin:0 auto;padding:12px 20px 28px;
      font-size:12px;color:var(--muted);line-height:1.7;border-top:1px solid var(--stroke);
    }
    code{background:rgba(0,0,0,.35);padding:2px 6px;border-radius:6px;font-family:'Space Mono',monospace;}

    .error-toast{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:rgba(255,58,58,.15);border:1px solid rgba(255,58,58,.4);
      color:#ffaaaa;padding:11px 20px;border-radius:12px;
      font-size:13px;z-index:999;max-width:90vw;text-align:center;display:none;
    }
  </style>
</head>
<body>

<div class="error-toast" id="toast"></div>

<header>
  <div class="logo">MARACA<span>LOOP</span></div>
  <div class="top-controls">
    <select id="sourceSelect">
      <option value="mic">üéô Microfono</option>
      <option value="screen">üñ• Schermo / Tab</option>
    </select>
    <button class="btn-init" id="btnInit">‚ö° Attiva Audio</button>
    <button class="btn-play" id="btnPlayAll" disabled>‚ñ∂ Play All</button>
    <button class="btn-stop" id="btnStopAll" disabled>‚ñ† Stop All</button>
    <button id="btnClearAll" disabled>‚úï Clear All</button>
  </div>
</header>

<div class="statusbar">
  <span class="badge"><span class="dot" id="dotAudio"></span> AudioContext</span>
  <span class="badge"><span class="dot" id="dotInput"></span> Ingresso</span>
  <span class="badge">Loop: <b id="masterLen">‚Äî</b></span>
  <span class="badge">SR: <b id="sr">‚Äî</b></span>
</div>

<div class="metro-bar">
  <span class="metro-label">METRONOMO</span>

  <div class="led-strip" id="ledStrip"></div>

  <div class="beat-num" id="beatNum">‚Äî</div>

  <div class="bpm-wrap">
    <label for="bpmInput">BPM</label>
    <input type="number" id="bpmInput" min="60" max="180" value="120" step="1"/>
  </div>

  <button class="metro-toggle" id="btnMetro">‚ñ∂ Start</button>
</div>

<main id="grid"></main>

<footer>
  ‚ö† Usa <code>https://</code> o <code>localhost</code> per il microfono. &nbsp;|&nbsp;
  La <b>prima traccia</b> definisce la durata del loop master. &nbsp;|&nbsp;
  <b>Count-in</b>: 8 o 16 battute prima della registrazione. Il metronomo si sincronizza automaticamente.
</footer>

<script>
const LEDS = 16;
let metroRunning = false;
let bpm = 120;
let currentBeat = -1;
let metroIntervalId = null;
let lastBeatTime = 0;

const ledStrip  = document.getElementById("ledStrip");
const bpmInput  = document.getElementById("bpmInput");
const btnMetro  = document.getElementById("btnMetro");
const beatNum   = document.getElementById("beatNum");

const ledEls = [];
for(let i=0; i<LEDS; i++){
  if(i>0 && i%4===0){
    const sep=document.createElement("div");
    sep.className="led-sep";
    ledStrip.appendChild(sep);
  }
  const d=document.createElement("div");
  const isAccent = (i%4===0);
  d.className="led"+(isAccent?" beat1":"");
  // Show beat number inside accent LEDs
  if(isAccent){
    const n=document.createElement("div");
    n.className="beat-n";
    n.textContent=(i/4+1);
    d.appendChild(n);
  }
  ledStrip.appendChild(d);
  ledEls.push(d);
}

function setLed(beat){
  ledEls.forEach((l,i)=>{
    const was = l.classList.contains("lit");
    l.classList.toggle("lit", i===beat);
  });
  if(beat>=0){
    beatNum.textContent = (beat+1);
    beatNum.classList.add("flash");
    clearTimeout(beatNum._ft);
    beatNum._ft = setTimeout(()=>beatNum.classList.remove("flash"), 80);
  } else {
    beatNum.textContent="‚Äî";
    beatNum.classList.remove("flash");
  }
}

function metroTick(){
  currentBeat = (currentBeat+1) % LEDS;
  setLed(currentBeat);
  notifyTracksBeat(currentBeat);
}

function startMetro(){
  if(metroRunning) return;
  metroRunning=true;
  currentBeat=-1;
  const ms = 60000/bpm;
  // Fire immediately then repeat
  metroTick();
  metroIntervalId = setInterval(metroTick, ms);
  btnMetro.textContent="‚ñ† Stop";
  btnMetro.classList.add("active");
}

function stopMetro(){
  if(!metroRunning) return;
  clearInterval(metroIntervalId);
  metroIntervalId=null;
  metroRunning=false;
  currentBeat=-1;
  setLed(-1);
  btnMetro.textContent="‚ñ∂ Start";
  btnMetro.classList.remove("active");
}

function restartMetro(){
  stopMetro();
  startMetro();
}

bpmInput.addEventListener("change",()=>{
  let v=parseInt(bpmInput.value)||120;
  v=Math.max(60,Math.min(180,v));
  bpmInput.value=v; bpm=v;
  restartMetro();
});
bpmInput.addEventListener("keydown",e=>{ if(e.key==="Enter") bpmInput.blur(); });
btnMetro.addEventListener("click",()=>{ metroRunning?stopMetro():startMetro(); });

function notifyTracksBeat(beat){
  for(const t of tracks){
    if(!t.countinArmed && !t.countinActive) continue;

    // Aspetta beat 0 per partire sincronizzato
    if(t.countinArmed && !t.countinActive){
      if(beat===0){
        t.countinActive=true;
        t.countinRemaining=t.countinBeats;
      } else {
        continue; // non ancora
      }
    }

    if(t.countinActive){
      t.countinRemaining--;
      refreshCountinLeds(t);
      refreshCountinSvg(t);
      if(t.ui.info) t.ui.info.textContent=\`count-in: ${Math.max(0,t.countinRemaining)} beat\`;

      if(t.countinRemaining<=0){
        t.countinArmed=false;
        t.countinActive=false;
        startRecordingNow(t);
      }
    }
  }
}

function refreshCountinLeds(t){
  if(!t.ui.trackLeds) return;
  const total=t.countinBeats;
  const done=total-t.countinRemaining;
  const leds=t.ui.trackLeds;
  const n=leds.length; // 8
  leds.forEach((l,i)=>{
    const thresh=Math.round((i+1)*total/n);
    const prev=Math.round(i*total/n);
    l.classList.remove("lit","done");
    if(done>=thresh) l.classList.add("done");
    else if(done>prev) l.classList.add("lit");
  });
}

function clearCountinLeds(t){
  if(!t.ui.trackLeds) return;
  t.ui.trackLeds.forEach(l=>l.classList.remove("lit","done"));
}

function refreshCountinSvg(t){
  const svg=t.ui.btnMain?.querySelector("svg");
  if(!svg) return;
  const n=Math.max(0,t.countinRemaining);
  svg.innerHTML=\`<text x="17" y="23" text-anchor="middle"
    font-family="Space Mono,monospace" font-size="16" font-weight="700"
    fill="rgba(255,170,0,.95)">${n>0?n:"GO!"}</text>\`;
}

let audioCtx=null, inputStream=null, masterGain=null;
let isInitialized=false, masterLoopSeconds=null;
const TRACKS=8;
const tracks=[];

const grid       = document.getElementById("grid");
const btnInit    = document.getElementById("btnInit");
const btnPlayAll = document.getElementById("btnPlayAll");
const btnStopAll = document.getElementById("btnStopAll");
const btnClearAll= document.getElementById("btnClearAll");
const sourceSelect=document.getElementById("sourceSelect");
const dotAudio   = document.getElementById("dotAudio");
const dotInput   = document.getElementById("dotInput");
const masterLenEl= document.getElementById("masterLen");
const srEl       = document.getElementById("sr");
const toastEl    = document.getElementById("toast");

function showToast(msg,dur=4500){
  toastEl.textContent=msg;toastEl.style.display="block";
  clearTimeout(toastEl._t);
  toastEl._t=setTimeout(()=>{toastEl.style.display="none";},dur);
}
function fmtSec(s){return(s==null||!isFinite(s))?"‚Äî":s<10?s.toFixed(2)+"s":s.toFixed(1)+"s";}
function setDots(){
  dotAudio.className="dot"+(audioCtx&&audioCtx.state==="running"?" on":"");
  dotInput.className="dot"+(inputStream?" on":"");
}
function setMasterLoop(sec){masterLoopSeconds=sec;masterLenEl.textContent=fmtSec(sec);}

function updateGlobalButtons(){
  const anyBuf=tracks.some(t=>!!t.buffer);
  const anyPlay=tracks.some(t=>t.isPlaying);
  btnPlayAll.disabled=!isInitialized||!anyBuf;
  btnStopAll.disabled=!isInitialized||!anyPlay;
  btnClearAll.disabled=!isInitialized||!anyBuf;
}

async function blobToAudioBuffer(blob){
  const ab=await blob.arrayBuffer();
  return await audioCtx.decodeAudioData(ab);
}

function quantizeBuffer(buf){
  if(masterLoopSeconds==null) return buf;
  const sr=buf.sampleRate, target=Math.round(masterLoopSeconds*sr);
  const chs=buf.numberOfChannels;
  const out=audioCtx.createBuffer(chs,target,sr);
  for(let c=0;c<chs;c++){
    const inp=buf.getChannelData(c), outp=out.getChannelData(c);
    if(inp.length>=target) outp.set(inp.subarray(0,target));
    else outp.set(inp);
  }
  return out;
}

function drawWaveform(canvas,audioBuffer){
  const ctx=canvas.getContext("2d");
  const W=canvas.width=canvas.offsetWidth*devicePixelRatio;
  const H=canvas.height=canvas.offsetHeight*devicePixelRatio;
  ctx.clearRect(0,0,W,H);
  if(!audioBuffer) return;
  const data=audioBuffer.getChannelData(0);
  const step=Math.ceil(data.length/W), mid=H/2;
  ctx.strokeStyle="rgba(0,212,255,.7)";ctx.lineWidth=1;ctx.beginPath();
  for(let x=0;x<W;x++){
    let mn=1,mx=-1;
    for(let j=0;j<step;j++){const v=data[x*step+j]||0;if(v<mn)mn=v;if(v>mx)mx=v;}
    ctx.moveTo(x,mid+mn*mid*.9);ctx.lineTo(x,mid+mx*mid*.9);
  }
  ctx.stroke();
}
function stopPlayback(t){
  if(t.source){try{t.source.stop();}catch{}try{t.source.disconnect();}catch{}t.source=null;}
  t.isPlaying=false;updateTrackUI(t);updateGlobalButtons();
}
function startPlayback(t){
  if(!t.buffer||!audioCtx) return;
  stopPlayback(t);
  const src=audioCtx.createBufferSource();
  src.buffer=t.buffer;src.loop=true;src.loopStart=0;src.loopEnd=t.buffer.duration;
  src.connect(t.gainNode);src.start();
  t.source=src;t.isPlaying=true;updateTrackUI(t);updateGlobalButtons();
}
function clearTrack(t){
  stopPlayback(t);abortRecording(t);cancelCountin(t);
  t.buffer=null;drawWaveform(t.ui.canvas,null);updateTrackUI(t);updateGlobalButtons();
}
function abortRecording(t){
  if(t.mediaRec&&t.isRecording){
    t.mediaRec.ondataavailable=null;t.mediaRec.onstop=null;
    try{t.mediaRec.stop();}catch{}
  }
  t.isRecording=false;t.recChunks=[];
}
function cancelCountin(t){
  t.countinArmed=false;t.countinActive=false;t.countinRemaining=0;
  clearCountinLeds(t);
}

function startRecordingNow(t){
  if(!inputStream){showToast("Prima attiva l'audio!");return;}
  const mimes=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg","audio/mp4"];
  const mime=mimes.find(m=>MediaRecorder.isTypeSupported(m))||"";
  try{
    t.recChunks=[];
    const options=mime?{mimeType:mime}:{};
    t.mediaRec=new MediaRecorder(inputStream,options);
    t.mediaRec.ondataavailable=(e)=>{if(e.data&&e.data.size>0)t.recChunks.push(e.data);};
    t.mediaRec.onstop=async()=>{
      t.isRecording=false;
      if(!t.recChunks.length){showToast("Registrazione vuota.");updateTrackUI(t);updateGlobalButtons();return;}
      try{
        const blob=new Blob(t.recChunks,{type:mime||"audio/webm"});
        t.recChunks=[];
        let buf=await blobToAudioBuffer(blob);
        if(buf.duration<0.05){showToast("Troppo breve.");updateTrackUI(t);updateGlobalButtons();return;}
        if(masterLoopSeconds==null){setMasterLoop(buf.duration);t.buffer=buf;}
        else{t.buffer=quantizeBuffer(buf);}
        drawWaveform(t.ui.canvas,t.buffer);
      }catch(err){console.error(err);showToast("Errore decodifica: "+err.message);}
      updateTrackUI(t);updateGlobalButtons();
    };
    t.mediaRec.onerror=(e)=>{
      showToast("Errore MediaRecorder: "+(e.error?.message||e));
      t.isRecording=false;updateTrackUI(t);updateGlobalButtons();
    };
    t.mediaRec.start(100);
    t.isRecording=true;
    clearCountinLeds(t);
    updateTrackUI(t);updateGlobalButtons();
  }catch(err){showToast("Impossibile registrare: "+err.message);}
}
function stopRecording(t){
  if(!t.mediaRec||!t.isRecording) return;
  try{t.mediaRec.stop();}
  catch(err){t.isRecording=false;updateTrackUI(t);}
}

function toggleMainButton(t){
  if(!isInitialized){showToast("Prima clicca ‚ö° Attiva Audio");return;}
  const inCountin=t.countinArmed||t.countinActive;
  if(inCountin){cancelCountin(t);updateTrackUI(t);return;}

  if(!t.buffer){
    if(!t.isRecording){
      if(t.countinBeats>0){
        // Avvia metronomo se non gira
        if(!metroRunning) startMetro();
        else restartMetro(); // repart da beat 0
        t.countinArmed=true;t.countinActive=false;
        t.countinRemaining=t.countinBeats;
        updateTrackUI(t);updateGlobalButtons();
      } else {
        startRecordingNow(t);
      }
    } else {
      stopRecording(t);
    }
  } else {
    if(!t.isPlaying) startPlayback(t);
    else stopPlayback(t);
  }
}

function updateTrackUI(t){
  const{el,btnMain,stateTag,info,clearBtn}=t.ui;
  const inCountin=t.countinArmed||t.countinActive;

  el.classList.toggle("is-rec",t.isRecording);
  el.classList.toggle("is-countin",inCountin&&!t.isRecording);
  el.classList.toggle("is-play",t.isPlaying&&!t.isRecording&&!inCountin);
  el.classList.toggle("has-buffer",!!t.buffer&&!t.isPlaying&&!t.isRecording&&!inCountin);

  if(inCountin){
    stateTag.textContent="COUNT‚Ä¶";stateTag.className="track-state s-countin";
    const rem=Math.max(0,t.countinRemaining);
    info.textContent=t.countinArmed&&!t.countinActive
      ? \`in attesa battuta 1‚Ä¶\`
      : \`count-in: ${rem} beat\`;
  } else if(t.isRecording){
    stateTag.textContent="‚óè REC";stateTag.className="track-state s-rec";
    info.textContent="registrazione‚Ä¶";
  } else if(t.isPlaying){
    stateTag.textContent="‚ñ∂ PLAY";stateTag.className="track-state s-play";
    info.textContent=fmtSec(t.buffer?.duration);
  } else if(t.buffer){
    stateTag.textContent="‚ñ† READY";stateTag.className="track-state s-ready";
    info.textContent=fmtSec(t.buffer.duration);
  } else {
    stateTag.textContent="IDLE";stateTag.className="track-state";
    info.textContent="premi per registrare";
  }

  // SVG icon
  const svg=btnMain.querySelector("svg");
  if(inCountin){
    const n=t.countinArmed&&!t.countinActive?"?":Math.max(0,t.countinRemaining);
    svg.innerHTML=\`<text x="17" y="23" text-anchor="middle"
      font-family="Space Mono,monospace" font-size="16" font-weight="700"
      fill="rgba(255,170,0,.95)">${n}</text>\`;
  } else if(!t.buffer){
    if(t.isRecording)
      svg.innerHTML=\`<rect x="8" y="8" width="18" height="18" rx="3" fill="rgba(255,58,58,.9)" stroke="none"/>\`;
    else
      svg.innerHTML=\`<circle cx="17" cy="17" r="9" fill="rgba(255,58,58,.85)" stroke="none"/>\`;
  } else {
    if(t.isPlaying)
      svg.innerHTML=\`<rect x="8" y="8" width="7" height="18" rx="2" fill="rgba(0,212,255,.9)" stroke="none"/>
                     <rect x="19" y="8" width="7" height="18" rx="2" fill="rgba(0,212,255,.9)" stroke="none"/>\`;
    else
      svg.innerHTML=\`<polygon points="10,8 28,17 10,26" fill="rgba(45,255,143,.9)" stroke="none"/>\`;
  }

  clearBtn.disabled=!t.buffer&&!t.isRecording&&!inCountin;
  // update count-in button styles
  updateCiBtns(t);
}

function updateCiBtns(t){
  if(!t.ui.ciOff) return;
  const dis=t.isRecording||t.countinArmed||t.countinActive;
  [t.ui.ciOff,t.ui.ci8,t.ui.ci16].forEach(b=>b.disabled=dis);
  t.ui.ciOff.classList.toggle("sel",t.countinBeats===0);
  t.ui.ci8.classList.toggle("sel",t.countinBeats===8);
  t.ui.ci16.classList.toggle("sel",t.countinBeats===16);
}

function createTrack(i){
  return{
    index:i,buffer:null,source:null,gainNode:null,
    mediaRec:null,recChunks:[],
    isRecording:false,isPlaying:false,isMuted:false,_prevVol:0.85,
    countinBeats:0,countinArmed:false,countinActive:false,countinRemaining:0,
    ui:{}
  };
}

function buildTrackCard(t){
  const el=document.createElement("section");
  el.className="track";
  const ledsHtml=Array.from({length:8},()=>\`<div class="t-led"></div>\`).join("");
  el.innerHTML=\`
    <div class="track-glow"></div>
    <div class="track-head">
      <div class="track-num">${String(t.index+1).padStart(2,"0")}</div>
      <span class="track-state" id="st">IDLE</span>
    </div>
    <div class="track-leds" id="tls">${ledsHtml}</div>
    <canvas class="waveform" id="cvs" width="200" height="30"></canvas>
    <div class="btn-main-wrap">
      <button class="btn-main" id="bm" aria-label="Record/Play">
        <div class="spin-ring"></div>
        <svg viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg">
          <circle cx="17" cy="17" r="9" fill="rgba(255,58,58,.85)" stroke="none"/>
        </svg>
      </button>
    </div>
    <div class="track-info" id="inf">premi per registrare</div>
    <div class="countin-row">
      <span class="ci-lbl">COUNT-IN</span>
      <button class="ci-btn sel" id="ciOff">OFF</button>
      <button class="ci-btn" id="ci8">8</button>
      <button class="ci-btn" id="ci16">16</button>
    </div>
    <div class="vol-row">
      <span class="vol-label">VOL</span>
      <input type="range" id="vol" min="0" max="1" step="0.01" value="0.85"/>
      <span class="vol-pct" id="vp">85%</span>
    </div>
    <div class="track-btns">
      <button id="muteBtn">Mute</button>
      <button id="clearBtn" disabled>Clear</button>
    </div>
  \`;
  const btnMain=el.querySelector("#bm");
  const stateTag=el.querySelector("#st");
  const info=el.querySelector("#inf");
  const vol=el.querySelector("#vol");
  const volpct=el.querySelector("#vp");
  const muteBtn=el.querySelector("#muteBtn");
  const clearBtn=el.querySelector("#clearBtn");
  const canvas=el.querySelector("#cvs");
  const ciOff=el.querySelector("#ciOff");
  const ci8=el.querySelector("#ci8");
  const ci16=el.querySelector("#ci16");
  const trackLeds=Array.from(el.querySelector("#tls").querySelectorAll(".t-led"));

  t.ui={el,btnMain,stateTag,info,vol,volpct,muteBtn,clearBtn,canvas,ciOff,ci8,ci16,trackLeds};

  btnMain.addEventListener("click",()=>toggleMainButton(t));
  btnMain.addEventListener("keydown",e=>{if(e.key==="Enter"||e.key===" "){e.preventDefault();btnMain.click();}});

  ciOff.addEventListener("click",()=>{t.countinBeats=0;updateCiBtns(t);});
  ci8.addEventListener("click",()=>{t.countinBeats=8;updateCiBtns(t);});
  ci16.addEventListener("click",()=>{t.countinBeats=16;updateCiBtns(t);});

  vol.addEventListener("input",()=>{
    const v=parseFloat(vol.value);
    volpct.textContent=Math.round(v*100)+"%";
    if(t.gainNode) t.gainNode.gain.setTargetAtTime(v,audioCtx.currentTime,.01);
    if(v>0.001) t.isMuted=false;
  });

  muteBtn.addEventListener("click",()=>{
    if(!t.gainNode) return;
    if(!t.isMuted){
      t._prevVol=parseFloat(vol.value);
      t.gainNode.gain.setTargetAtTime(0,audioCtx.currentTime,.01);
      vol.value="0";volpct.textContent="0%";
      t.isMuted=true;muteBtn.className="btn-muted";muteBtn.textContent="Unmute";
    } else {
      const pv=t._prevVol||0.85;
      t.gainNode.gain.setTargetAtTime(pv,audioCtx.currentTime,.01);
      vol.value=String(pv);volpct.textContent=Math.round(pv*100)+"%";
      t.isMuted=false;muteBtn.className="";muteBtn.textContent="Mute";
    }
  });

  clearBtn.addEventListener("click",()=>clearTrack(t));
  updateTrackUI(t);
  return el;
}

function buildUI(){
  grid.innerHTML="";tracks.length=0;
  for(let i=0;i<TRACKS;i++){
    const t=createTrack(i);
    tracks.push(t);
    grid.appendChild(buildTrackCard(t));
  }
  updateGlobalButtons();
}

async function initAudio(){
  if(isInitialized) return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  srEl.textContent=audioCtx.sampleRate+" Hz";
  masterGain=audioCtx.createGain();
  masterGain.gain.value=0.9;
  masterGain.connect(audioCtx.destination);
  const mode=sourceSelect.value;
  if(mode==="mic"){
    inputStream=await navigator.mediaDevices.getUserMedia({
      audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false},video:false});
  } else {
    inputStream=await navigator.mediaDevices.getDisplayMedia({audio:true,video:true});
  }
  for(const t of tracks){
    t.gainNode=audioCtx.createGain();
    t.gainNode.gain.value=parseFloat(t.ui.vol.value);
    t.gainNode.connect(masterGain);
  }
  await audioCtx.resume();
  isInitialized=true;setDots();
  btnInit.textContent="‚úì Audio attivo";btnInit.disabled=true;
  updateGlobalButtons();
}

btnInit.addEventListener("click",async()=>{
  try{btnInit.textContent="‚Ä¶";btnInit.disabled=true;await initAudio();}
  catch(e){console.error(e);btnInit.disabled=false;btnInit.textContent="‚ö° Attiva Audio";showToast("Errore: "+(e?.message||e));}
  finally{setDots();}
});
btnPlayAll.addEventListener("click",()=>{for(const t of tracks)if(t.buffer&&!t.isPlaying)startPlayback(t);updateGlobalButtons();});
btnStopAll.addEventListener("click",()=>{for(const t of tracks){if(t.isPlaying)stopPlayback(t);if(t.isRecording)stopRecording(t);cancelCountin(t);}updateGlobalButtons();});
btnClearAll.addEventListener("click",()=>{
  if(!confirm("Cancellare tutte le tracce?")) return;
  for(const t of tracks) clearTrack(t);
  masterLoopSeconds=null;masterLenEl.textContent="‚Äî";updateGlobalButtons();
});
sourceSelect.addEventListener("change",()=>{if(isInitialized)showToast("Ricarica la pagina per cambiare sorgente.");});
setInterval(setDots,600);
window.addEventListener("resize",()=>{for(const t of tracks)if(t.buffer)drawWaveform(t.ui.canvas,t.buffer);});

buildUI();
<\/script>
</body>
</html>`,
  DJ: `<!DOCTYPE html>
<html lang="it">
<head>
<script>
/* MaxiHost bootstrap for section DJ */
(function(){
  const SECTION_ID = 'DJ';
  // ---- Shared audio routing via parent ----
  function getProxy(){
    const host = window.parent && window.parent.MaracaHost;
    if (!host) return null;
    return host.getAudioProxy(SECTION_ID);
  }
  const proxy = getProxy();
  if (proxy) {
    // Replace constructors used by apps
    window.AudioContext = function(){ return proxy; };
    window.webkitAudioContext = function(){ return proxy; };
  }

  // ---- Mic gating (single-owner) ----
  const md = navigator.mediaDevices;
  if (md && md.getUserMedia) {
    const orig = md.getUserMedia.bind(md);
    md.getUserMedia = function(constraints){
      const host = window.parent && window.parent.MaracaHost;
      if (!host) return orig(constraints);
      return host.requestMic(SECTION_ID, constraints);
    };
  }

  // ---- Resume helper (some apps call ctx.resume on user gesture) ----
  window.addEventListener('pointerdown', () => {
    try {
      const host = window.parent && window.parent.MaracaHost;
      if (host) host.resumeAudio();
    } catch(e){}
  }, {passive:true});
})();
<\/script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MARACA-DJ ‚Ä¢ TRUE KEY LOCK ‚Ä¢ LOOP LIBERO</title>
<style>
:root {
  --bg: #0a0c0e;
  --deck-bg: #15181b;
  --panel: #1e2226;
  --accent: #2ef0d0;
  --warn: #ffb347;
  --danger: #ff5f6d;
  --text: #f0f2f4;
  --sub: #9aa6b2;
  --border: #2f353b;
  --beat: rgba(46, 240, 208, 0.4);
  --beat-down: rgba(255, 95, 109, 0.8);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 16px;
}

h1 {
  text-align: center;
  letter-spacing: 4px;
  font-size: 1.2rem;
  font-weight: 400;
  color: var(--accent);
  padding: 8px 0 20px;
  text-transform: uppercase;
  word-spacing: 6px;
}

.console {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  max-width: 1800px;
  margin: 0 auto;
}

/* DECK */
.deck {
  background: var(--deck-bg);
  border: 2px solid var(--border);
  border-radius: 14px;
  padding: 14px 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  transition: border 0.2s, box-shadow 0.2s;
  box-shadow: 0 6px 12px rgba(0,0,0,0.5);
}

.deck.active {
  border-color: var(--accent);
}

.deck.master {
  border-color: var(--warn);
  box-shadow: 0 0 16px rgba(255, 180, 70, 0.3);
}

.deck.playing .dtitle {
  color: #90ffc0;
  text-shadow: 0 0 5px #2ef0d0;
}

/* HEADER */
.deck-hdr {
  display: flex;
  align-items: center;
  gap: 6px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

.dtitle {
  font-weight: 600;
  color: var(--accent);
  font-size: 1rem;
  flex: 1;
  letter-spacing: 1px;
}

.mbadge {
  font-size: 0.6rem;
  background: var(--warn);
  color: #000;
  padding: 3px 7px;
  border-radius: 20px;
  font-weight: 700;
  display: none;
  text-transform: uppercase;
}

.deck.master .mbadge {
  display: inline-block;
}

.bpm-box {
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 1.1rem;
  background: #0f1114;
  color: var(--accent);
  padding: 3px 9px;
  border-radius: 30px;
  border: 1px solid #3a4048;
  font-weight: 600;
}

.key-box {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  background: #0f1114;
  color: #cfaaff;
  padding: 3px 8px;
  border-radius: 30px;
  border: 1px solid #4a3f60;
  min-width: 48px;
  text-align: center;
  font-weight: 600;
}

.tname {
  font-size: 0.75rem;
  color: #ccc;
  background: #1a1e23;
  padding: 6px 10px;
  border-radius: 30px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  border: 1px solid #2a2f36;
}

/* WAVEFORM CONTAINER */
.ww {
  position: relative;
  height: 80px;
  background: #0c0f12;
  border-radius: 10px;
  overflow: hidden;
  cursor: crosshair;
  border: 1px solid #2c323a;
  box-shadow: inset 0 2px 4px #00000055;
}

canvas {
  display: block;
  width: 100%;
  height: 100%;
}

.bgc {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.ph {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 0 8px white;
  pointer-events: none;
  will-change: left;
  z-index: 10;
}

/* ZOOM CONTROLS */
.zoom-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 2px;
  background: var(--panel);
  padding: 6px 10px;
  border-radius: 30px;
  flex-wrap: wrap;
}

.zoom-row label {
  font-size: 0.75rem;
  color: var(--accent);
  min-width: 35px;
  font-weight: bold;
}

.zoom-row input {
  flex: 2;
  min-width: 100px;
  height: 5px;
  accent-color: var(--accent);
}

.zoom-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  background: #0f1114;
  color: var(--accent);
  padding: 3px 8px;
  border-radius: 20px;
  border: 1px solid #3a4048;
  min-width: 55px;
  text-align: center;
}

.zoom-btns {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.zoom-btn {
  background: #2f353f;
  border: none;
  color: white;
  padding: 4px 8px;
  border-radius: 20px;
  font-size: 0.65rem;
  font-weight: bold;
  cursor: pointer;
  transition: 0.1s;
  min-width: 40px;
}

.zoom-btn:hover {
  background: #404854;
}

.zoom-btn.active {
  background: var(--accent);
  color: #000;
}

/* LOOP CONTROLS - NUOVI */
.loop-section {
  background: var(--panel);
  border-radius: 12px;
  padding: 8px 10px;
}

.loop-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.loop-title span {
  font-size: 0.68rem;
  color: var(--accent);
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.loop-mode-btn {
  background: #2f353f;
  color: #aaa;
  border: none;
  padding: 3px 8px;
  border-radius: 20px;
  font-size: 0.6rem;
  font-weight: bold;
  cursor: pointer;
}

.loop-mode-btn.active {
  background: var(--accent);
  color: #000;
}

.loop-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
  margin-bottom: 6px;
}

.loop-btn {
  background: #2d333b;
  color: #b0c0d0;
  border: none;
  padding: 6px 0;
  border-radius: 20px;
  font-size: 0.65rem;
  font-weight: bold;
  cursor: pointer;
  transition: 0.1s;
}

.loop-btn.on {
  background: #c56bf0;
  color: #fff;
}

.loop-btn.free {
  background: #3a2e4a;
  color: #d0b0ff;
}

.loop-free-controls {
  display: flex;
  gap: 4px;
  margin-top: 6px;
}

.loop-free-btn {
  flex: 1;
  background: #352d42;
  color: #cfaaff;
  border: none;
  padding: 6px 0;
  border-radius: 20px;
  font-size: 0.65rem;
  font-weight: bold;
  cursor: pointer;
  transition: 0.1s;
}

.loop-free-btn:hover {
  background: #4a3a5a;
}

.loop-free-btn.active {
  background: #aa88ff;
  color: #000;
}

.loop-off-btn {
  background: #5a3a3a;
  color: #ddd;
  border: none;
  padding: 6px 0;
  border-radius: 20px;
  font-size: 0.65rem;
  font-weight: bold;
  cursor: pointer;
  width: 100%;
  margin-top: 4px;
}

/* PANELS */
.sub {
  background: var(--panel);
  border-radius: 12px;
  padding: 10px 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sub-title {
  font-size: 0.68rem;
  color: var(--accent);
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
  opacity: 0.9;
}

.row {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* BUTTONS */
button {
  border: none;
  border-radius: 30px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.7rem;
  text-transform: uppercase;
  transition: 0.08s;
  letter-spacing: 0.3px;
}

button:active {
  transform: scale(0.96);
}

.bp {
  background: #2cc56e;
  color: #000;
  padding: 8px;
}

.bs {
  background: var(--danger);
  color: #fff;
  padding: 8px;
}

.bm {
  background: var(--warn);
  color: #000;
  padding: 8px;
}

.bsync {
  background: #3f7ee0;
  color: #fff;
  padding: 8px;
}

.bdef {
  background: #3a404a;
  color: #ddd;
  padding: 5px 10px;
}

.block {
  background: #444c58;
  color: #fff;
  flex: 1;
  padding: 8px;
}

.block.locked {
  background: #ff4444;
  color: #fff;
  box-shadow: 0 0 15px #ff4444;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.8; box-shadow: 0 0 20px #ff4444; }
  100% { opacity: 1; }
}

.bnudge {
  background: #2a2f37;
  color: #aaa;
  padding: 5px 10px;
  font-size: 0.7rem;
}

/* GRIDS */
.g2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

/* SLIDERS */
.sg {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sg label {
  font-size: 0.7rem;
  color: var(--sub);
  display: flex;
  justify-content: space-between;
}

input[type=range] {
  width: 100%;
  cursor: pointer;
  accent-color: var(--accent);
  height: 6px;
}

input[type=number],
input.num {
  background: #0d0f13;
  border: 1px solid #404854;
  color: var(--accent);
  padding: 5px 6px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-family: 'JetBrains Mono', monospace;
  text-align: center;
}

/* STATUS BAR */
.sbar {
  font-size: 0.65rem;
  color: var(--sub);
  text-align: center;
  min-height: 18px;
  background: #1e2328;
  padding: 4px 8px;
  border-radius: 30px;
}

/* ZOOM NAV */
.zoom-nav {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 2px;
  background: #1a1f24;
  padding: 4px 8px;
  border-radius: 20px;
}

.zoom-nav label {
  font-size: 0.6rem;
  color: var(--sub);
}

.zoom-nav input {
  flex: 1;
  height: 4px;
  accent-color: var(--accent);
}

.zoom-pos {
  font-size: 0.6rem;
  color: var(--accent);
  background: #0f1114;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 45px;
  text-align: center;
}

/* MIXER */
.mixer {
  grid-column: 1 / -1;
  background: #141a1f;
  border: 1px solid var(--border);
  border-radius: 40px;
  padding: 18px 22px;
  margin-top: 10px;
}

.mx-title {
  text-align: center;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 3px;
  margin-bottom: 12px;
  text-transform: uppercase;
}

.mx-inner {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
}

.mx-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  min-width: 200px;
}

.cf-lab {
  display: flex;
  justify-content: space-between;
  width: 100%;
  font-size: 0.7rem;
  color: #aaa;
}

/* RESPONSIVE */
@media (max-width: 1200px) {
  .console { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 700px) {
  .console { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<h1>‚ö° MARACA-DJ ¬∑ TRUE KEY LOCK ¬∑ LOOP LIBERO/MANUAL ‚ö°</h1>
<div class="console" id="console"></div>

<script>
(function() {
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC();
  
  // IMPORTANTE: Abilita il time stretching di alta qualit√†
  if (ctx.createMediaElementSource) {
    // Gi√† abilitato di default
  }

  const masterGain = ctx.createGain();
  masterGain.gain.value = 0.8;
  masterGain.connect(ctx.destination);

  let masterIdx = 0;
  let cfVal = 0.5;
  const N = 4;

  // --- Crea deck data con SUPPORTO KEY LOCK VERO ---
  function createDeckData() {
    const gainNode = ctx.createGain();
    gainNode.connect(masterGain);
    
    return {
      buf: null,
      src: null,
      gainNode: gainNode,
      bpm: 120,
      bpmNative: 120,
      key: null,
      keyShift: 0,
      speed: 1.0,
      vol: 1.0,
      playing: false,
      off: 0,
      st: 0,
      beatOffMs: 0,
      
      // Loop settings
      loopBeats: 0,
      loopStart: 0,
      loopMode: 'beat', // 'beat' o 'free'
      freeLoopStart: 0,
      freeLoopEnd: 0,
      
      // TRUE KEY LOCK
      lockKey: false,     // Quando true, pitch rimane costante
      
      peaks: null,
      zoom: 1.0,
      zoomPos: 0.5
    };
  }

  const D = [];
  for (let i = 0; i < N; i++) {
    D.push(createDeckData());
  }

  // --- Utility ---
  const $ = id => document.getElementById(id);
  const status = (i, msg) => { const el = $(\`sb-${i}\`); if (el) el.textContent = msg; };

  const resumeCtx = () => { if (ctx.state === 'suspended') ctx.resume(); };

  // --- Crossfader ---
  function cfGain(idx) {
    return idx === 0 ? 1 - cfVal : idx === 1 ? cfVal : 1.0;
  }

  function applyVolume(i) {
    const d = D[i];
    d.gainNode.gain.setTargetAtTime(d.vol * cfGain(i), ctx.currentTime, 0.015);
  }

  function setVolume(i, v) {
    D[i].vol = +v;
    $(\`vv-${i}\`).textContent = Math.round(+v * 100);
    applyVolume(i);
  }

  function setMasterVol(v) {
    masterGain.gain.setTargetAtTime(+v, ctx.currentTime, 0.015);
    $('mvv').textContent = Math.round(+v * 100);
  }

  function setCF(v) {
    cfVal = +v;
    applyVolume(0);
    applyVolume(1);
  }

  // --- Render decks ---
  function renderDecks() {
    const container = document.getElementById('console');
    let html = '';
    const deckNames = ['A', 'B', 'C', 'D'];
    for (let i = 0; i < N; i++) {
      html += \`
        <div class="deck" id="dk-${i}">
          <div class="deck-hdr">
            <span class="dtitle" id="dt-${i}">DECK ${deckNames[i]}</span>
            <span class="mbadge" id="mb-${i}">MASTER</span>
            <span class="key-box" id="kbox-${i}">--</span>
            <span class="bpm-box" id="bb-${i}">--</span>
          </div>
          <input type="file" accept="audio/*" style="font-size:0.75rem; background:#1f252b; border:none; color:#ccc; padding:5px; border-radius:30px;" onchange="window.loadTrack(${i}, this)">
          <div class="tname" id="tn-${i}">Nessuna traccia</div>

          <!-- WAVEFORM + ZOOM -->
          <div class="ww" id="ww-${i}" onclick="window.seekClick(${i}, event)">
            <canvas id="wc-${i}"></canvas>
            <canvas class="bgc" id="gc-${i}"></canvas>
            <div class="ph" id="ph-${i}"></div>
          </div>
          
          <!-- ZOOM CONTROLS -->
          <div class="zoom-row">
            <label>üîç</label>
            <input type="range" id="zoom-${i}" min="1" max="10" step="0.1" value="1" oninput="window.setZoom(${i}, this.value)">
            <span class="zoom-value" id="zoom-val-${i}">1.0x</span>
          </div>
          
          <!-- NAVIGAZIONE ZOOM -->
          <div class="zoom-nav">
            <label>‚è∫Ô∏è</label>
            <input type="range" id="zoom-pos-${i}" min="0" max="1" step="0.001" value="0.5" oninput="window.setZoomPos(${i}, this.value)">
            <span class="zoom-pos" id="zoom-pos-val-${i}">50%</span>
          </div>
          
          <div class="zoom-btns">
            <button class="zoom-btn" onclick="window.setZoom(${i}, 1)">1x</button>
            <button class="zoom-btn" onclick="window.setZoom(${i}, 2)">2x</button>
            <button class="zoom-btn" onclick="window.setZoom(${i}, 4)">4x</button>
            <button class="zoom-btn" onclick="window.setZoom(${i}, 6)">6x</button>
            <button class="zoom-btn" onclick="window.setZoom(${i}, 8)">8x</button>
            <button class="zoom-btn" onclick="window.setZoom(${i}, 10)">10x</button>
          </div>

          <div class="sub">
            <div class="sub-title">‚öôÔ∏è Beat Grid 4/4</div>
            <div class="row">
              <label style="white-space:nowrap">Offset (ms):</label>
              <button class="bnudge" onclick="window.nudge(${i}, -10)">-10</button>
              <button class="bnudge" onclick="window.nudge(${i}, -1)">-1</button>
              <input type="number" class="num" id="boff-${i}" value="0" step="1" style="width:60px" oninput="window.setOffset(${i}, this.value)">
              <button class="bnudge" onclick="window.nudge(${i}, 1)">+1</button>
              <button class="bnudge" onclick="window.nudge(${i}, 10)">+10</button>
            </div>
            <div class="row">
              <label>BPM manuale:</label>
              <input type="number" class="num" id="bm-${i}" step="0.1" min="40" max="250" placeholder="auto" style="width:70px" oninput="window.setManualBPM(${i}, this.value)">
              <button class="bdef" style="padding:5px 10px;" onclick="window.resetBPM(${i})">Auto</button>
            </div>
          </div>

          <div class="sub">
            <div class="sub-title">üéº Tonalit√†</div>
            <div class="row">
              <label>Rilevata:</label>
              <span id="kdet-${i}" style="color:#cfaaff;font-size:0.8rem;min-width:30px">--</span>
              <label>Shift (semi):</label>
              <input type="number" class="num" id="ks-${i}" value="0" step="1" min="-12" max="12" style="width:55px" oninput="window.setKeyShift(${i}, this.value)">
            </div>
          </div>

          <div class="g2">
            <button class="bp" onclick="window.playDeck(${i})">‚ñ∂ Play</button>
            <button class="bs" onclick="window.stopDeck(${i})">‚èπ Stop</button>
            <button class="bm" style="font-size:0.65rem" onclick="window.setMaster(${i})">üëë Master</button>
            <button class="bsync" style="font-size:0.65rem" onclick="window.syncDeck(${i})">üîÅ Sync</button>
          </div>

          <div class="row">
            <label>üîí TRUE KEY LOCK:</label>
            <button class="block" id="lk-${i}" onclick="window.toggleKeyLock(${i})">KEY LOCK OFF</button>
          </div>

          <div class="sg">
            <label>Velocit√†: <span id="rv-${i}">1.000</span>x</label>
            <input type="range" id="rs-${i}" min="0.5" max="2.0" step="0.001" value="1" oninput="window.setSpeed(${i}, this.value)">
          </div>
          <div class="sg">
            <label>Volume: <span id="vv-${i}">100</span>%</label>
            <input type="range" id="vs-${i}" min="0" max="1" step="0.01" value="1" oninput="window.setVolume(${i}, this.value)">
          </div>

          <!-- LOOP SECTION - NUOVA VERSIONE CON LOOP LIBERO -->
          <div class="loop-section">
            <div class="loop-title">
              <span>üîÑ LOOP</span>
              <button class="loop-mode-btn" id="loop-mode-${i}" onclick="window.toggleLoopMode(${i})">MODE: BEAT</button>
            </div>
            
            <!-- BEAT LOOP (basato su battute) -->
            <div class="loop-grid" id="beat-loop-${i}">
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 1)">1</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 2)">2</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 3)">3</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 4)">4</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 5)">5</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 6)">6</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 7)">7</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 8)">8</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 12)">12</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 16)">16</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 24)">24</button>
              <button class="loop-btn" onclick="window.setBeatLoop(${i}, 32)">32</button>
            </div>
            
            <!-- FREE LOOP (manuale) -->
            <div class="loop-free-controls" id="free-loop-${i}" style="display: none;">
              <button class="loop-free-btn" id="loop-in-${i}" onclick="window.setLoopIn(${i})">‚è∫ LOOP IN</button>
              <button class="loop-free-btn" id="loop-out-${i}" onclick="window.setLoopOut(${i})">‚èπ LOOP OUT</button>
              <button class="loop-free-btn" id="clear-free-${i}" onclick="window.clearFreeLoop(${i})">‚ùå CLEAR</button>
            </div>
            
            <button class="loop-off-btn" onclick="window.clearAllLoop(${i})">LOOP OFF</button>
          </div>
          
          <div class="sbar" id="sb-${i}"></div>
        </div>
      \`;
    }
    // Mixer
    html += \`
      <div class="mixer">
        <div class="mx-title">üéö MASTER MIXER</div>
        <div class="mx-inner">
          <div class="mx-item">
            <label>Master Volume: <span id="mvv">80</span>%</label>
            <input type="range" min="0" max="1" step="0.01" value="0.8" oninput="window.setMasterVol(this.value)">
          </div>
          <div class="mx-item">
            <label>Crossfader A ‚áÑ B</label>
            <div class="cf-lab"><span>DECK A</span><span>DECK B</span></div>
            <input type="range" id="cf" min="0" max="1" step="0.001" value="0.5" oninput="window.setCF(this.value)">
          </div>
        </div>
      </div>
    \`;
    container.innerHTML = html;
  }

  renderDecks();

  // --- Esponi funzioni base ---
  window.setVolume = setVolume;
  window.setMasterVol = setMasterVol;
  window.setCF = setCF;

  // --- TRUE KEY LOCK - VERSIONE CORRETTA ---
  window.toggleKeyLock = function(i) {
    const d = D[i];
    d.lockKey = !d.lockKey;
    const btn = $(\`lk-${i}\`);
    btn.classList.toggle('locked', d.lockKey);
    btn.textContent = d.lockKey ? 'üîí KEY LOCKED (pitch fisso)' : 'KEY LOCK OFF';
    
    if (d.lockKey) {
      status(i, '‚úì TRUE KEY LOCK attivo - La velocit√† NON altera il pitch');
    } else {
      status(i, 'Key Lock disattivato');
    }
    
    // Aggiorna immediatamente il playback rate se in riproduzione
    if (d.playing && d.src) {
      // Con key lock attivo: pitch factor = 1 (NON usare keyShift)
      // Senza key lock: pitch factor = 2^(keyShift/12)
      const pitchFactor = d.lockKey ? 1 : Math.pow(2, d.keyShift / 12);
      const targetRate = d.speed * pitchFactor;
      
      // Applica il nuovo rate
      d.src.playbackRate.setTargetAtTime(targetRate, ctx.currentTime, 0.01);
      
      console.log(\`KeyLock ${d.lockKey ? 'ON' : 'OFF'}: speed=${d.speed}, pitchFactor=${pitchFactor}, rate=${targetRate}\`);
    }
  };

  // --- Speed - CORRETTA con rispetto key lock ---
  window.setSpeed = function(i, v) {
    const d = D[i];
    d.speed = +v;
    $(\`rv-${i}\`).textContent = (+v).toFixed(3);
    $(\`rs-${i}\`).value = +v;
    
    // Calcola il rate finale:
    // - Se key lock attivo: pitch factor = 1 (pitch originale)
    // - Se key lock non attivo: pitch factor = 2^(keyShift/12)
    const pitchFactor = d.lockKey ? 1 : Math.pow(2, d.keyShift / 12);
    const totalRate = d.speed * pitchFactor;
    
    if (d.src) {
      d.src.playbackRate.setTargetAtTime(totalRate, ctx.currentTime, 0.01);
      console.log(\`setSpeed: speed=${d.speed}, pitchFactor=${pitchFactor}, rate=${totalRate}, lockKey=${d.lockKey}\`);
    }
    
    // Calcola BPM effettivo (sempre basato sulla velocit√†)
    const effBPM = d.bpmNative * d.speed;
    $(\`bb-${i}\`).textContent = effBPM.toFixed(1);
    
    drawBG(i);
    
    if (d.lockKey) {
      status(i, \`BPM: ${effBPM.toFixed(1)} ¬∑ KEY LOCKED (pitch fisso a ${d.key || '--'})\`);
    } else {
      status(i, \`BPM effettivo: ${effBPM.toFixed(1)}\`);
    }
  };

  // --- Key shift - CORRETTA ---
  window.setKeyShift = function(i, v) {
    const d = D[i];
    d.keyShift = parseInt(v) || 0;
    
    // Applica solo se key lock NON √® attivo
    if (!d.lockKey && d.src) {
      const pitchFactor = Math.pow(2, d.keyShift / 12);
      const totalRate = d.speed * pitchFactor;
      d.src.playbackRate.setTargetAtTime(totalRate, ctx.currentTime, 0.01);
      console.log(\`setKeyShift: shift=${d.keyShift}, rate=${totalRate}\`);
    }
    
    // Aggiorna display tonalit√†
    updateKeyDisplay(i);
  };

  function updateKeyDisplay(i) {
    const d = D[i];
    if (d.key) {
      const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const isMin = d.key.endsWith('m');
      const baseNote = d.key.replace('m', '');
      const idx = notes.indexOf(baseNote);
      if (idx !== -1) {
        const newIdx = (idx + d.keyShift + 120) % 12;
        const newNote = notes[newIdx] + (isMin ? 'm' : '');
        $(\`kbox-${i}\`).textContent = newNote;
        
        if (d.lockKey) {
          status(i, \`Key visual: ${newNote} (pitch originale: ${d.key})\`);
        }
      }
    } else {
      $(\`kbox-${i}\`).textContent = '--';
    }
  }

  // --- Loop Mode Toggle (BEAT / FREE) ---
  window.toggleLoopMode = function(i) {
    const d = D[i];
    d.loopMode = d.loopMode === 'beat' ? 'free' : 'beat';
    const btn = $(\`loop-mode-${i}\`);
    btn.textContent = \`MODE: ${d.loopMode.toUpperCase()}\`;
    
    // Mostra/nascondi controlli appropriati
    const beatDiv = $(\`beat-loop-${i}\`);
    const freeDiv = $(\`free-loop-${i}\`);
    
    if (d.loopMode === 'beat') {
      beatDiv.style.display = 'grid';
      freeDiv.style.display = 'none';
      // Resetta free loop
      d.freeLoopStart = 0;
      d.freeLoopEnd = 0;
    } else {
      beatDiv.style.display = 'none';
      freeDiv.style.display = 'flex';
      // Disabilita beat loop
      d.loopBeats = 0;
      document.querySelectorAll(\`#beat-loop-${i} .loop-btn\`).forEach(b => b.classList.remove('on'));
    }
    
    // Se in riproduzione, riavvia con nuove impostazioni
    if (d.playing) window.playDeck(i);
  };

  // --- Beat Loop (basato su battute) ---
  window.setBeatLoop = function(i, beats) {
    const d = D[i];
    if (d.loopMode !== 'beat') return;
    
    d.loopBeats = beats;
    
    // Calcola loop start sul beat pi√π vicino
    if (d.bpm > 0 && d.buf) {
      const beatSec = 60 / d.bpm;
      const currentPos = d.playing ? ((ctx.currentTime - d.st) * d.speed) % d.buf.duration : d.off;
      
      // Arrotonda al beat pi√π vicino considerando offset
      const offSec = d.beatOffMs / 1000;
      const beatsFromStart = (currentPos - offSec) / beatSec;
      const roundedBeats = Math.round(beatsFromStart);
      d.loopStart = offSec + (roundedBeats * beatSec);
      
      // Assicura che sia dentro i limiti
      if (d.loopStart < 0) d.loopStart = 0;
      if (d.loopStart + (beatSec * beats) > d.buf.duration) {
        d.loopStart = d.buf.duration - (beatSec * beats);
      }
    } else {
      d.loopStart = d.off;
    }
    
    // UI feedback
    document.querySelectorAll(\`#beat-loop-${i} .loop-btn\`).forEach(b => {
      b.classList.toggle('on', b.textContent == beats);
    });
    
    if (d.playing) window.playDeck(i);
    status(i, \`Beat Loop: ${beats} battute\`);
  };

  // --- Free Loop (manuale) ---
  window.setLoopIn = function(i) {
    const d = D[i];
    if (d.loopMode !== 'free' || !d.buf) return;
    
    d.freeLoopStart = d.playing ? ((ctx.currentTime - d.st) * d.speed) % d.buf.duration : d.off;
    
    $(\`loop-in-${i}\`).classList.add('active');
    $(\`loop-out-${i}\`).classList.remove('active');
    
    status(i, \`Loop IN impostato a ${d.freeLoopStart.toFixed(2)}s\`);
  };

  window.setLoopOut = function(i) {
    const d = D[i];
    if (d.loopMode !== 'free' || !d.buf) return;
    
    d.freeLoopEnd = d.playing ? ((ctx.currentTime - d.st) * d.speed) % d.buf.duration : d.off;
    
    // Assicura che start < end
    if (d.freeLoopEnd <= d.freeLoopStart) {
      d.freeLoopEnd = d.freeLoopStart + 1; // Default 1 secondo
    }
    
    $(\`loop-out-${i}\`).classList.add('active');
    
    // Attiva il loop
    if (d.playing) {
      // Riavvia con il loop libero
      const src = d.src;
      if (src) {
        src.loopStart = d.freeLoopStart;
        src.loopEnd = d.freeLoopEnd;
        src.loop = true;
      }
    }
    
    status(i, \`Loop libero: ${d.freeLoopStart.toFixed(2)}s ‚Üí ${d.freeLoopEnd.toFixed(2)}s\`);
  };

  window.clearFreeLoop = function(i) {
    const d = D[i];
    d.freeLoopStart = 0;
    d.freeLoopEnd = 0;
    
    $(\`loop-in-${i}\`).classList.remove('active');
    $(\`loop-out-${i}\`).classList.remove('active');
    
    if (d.playing) {
      // Disabilita loop nel source corrente
      if (d.src) {
        d.src.loop = false;
      }
      // Riavvia senza loop
      window.playDeck(i);
    }
    
    status(i, 'Loop libero cancellato');
  };

  window.clearAllLoop = function(i) {
    const d = D[i];
    d.loopBeats = 0;
    d.freeLoopStart = 0;
    d.freeLoopEnd = 0;
    
    // UI reset
    document.querySelectorAll(\`#beat-loop-${i} .loop-btn\`).forEach(b => b.classList.remove('on'));
    $(\`loop-in-${i}\`)?.classList.remove('active');
    $(\`loop-out-${i}\`)?.classList.remove('active');
    
    if (d.playing) window.playDeck(i);
    status(i, 'Loop OFF');
  };

  // --- Play (RISCRITTO con corretto key lock) ---
  window.playDeck = function(i) {
    const d = D[i];
    if (!d.buf) { alert('Carica un file audio'); return; }
    resumeCtx();
    
    // Ferma sorgente precedente
    if (d.src) { 
      try { d.src.stop(); } catch(e) {} 
      d.src = null; 
    }
    
    const src = ctx.createBufferSource();
    src.buffer = d.buf;
    
    // Calcola il rate: 
    // - Se lockKey = true: pitch factor = 1 (pitch originale)
    // - Se lockKey = false: pitch factor = 2^(keyShift/12)
    const pitchFactor = d.lockKey ? 1 : Math.pow(2, d.keyShift / 12);
    const playbackRate = d.speed * pitchFactor;
    
    src.playbackRate.value = playbackRate;
    console.log(\`playDeck ${i}: speed=${d.speed}, pitchFactor=${pitchFactor}, rate=${playbackRate}, lockKey=${d.lockKey}\`);
    
    src.connect(d.gainNode);

    let offset = Math.max(0, d.off % d.buf.duration);
    
    // Configura loop in base alla modalit√†
    if (d.loopMode === 'beat' && d.loopBeats > 0 && d.bpm > 0) {
      const beatSec = 60 / d.bpm;
      const loopLen = beatSec * d.loopBeats;
      const ls = d.loopStart;
      const le = ls + loopLen;
      if (le <= d.buf.duration) {
        src.loopStart = ls; 
        src.loopEnd = le; 
        src.loop = true;
        offset = ls + ((offset - ls + loopLen) % loopLen);
      } else {
        src.loop = true;
      }
    } 
    else if (d.loopMode === 'free' && d.freeLoopEnd > d.freeLoopStart) {
      src.loopStart = d.freeLoopStart;
      src.loopEnd = d.freeLoopEnd;
      src.loop = true;
      offset = d.freeLoopStart + ((offset - d.freeLoopStart + (d.freeLoopEnd - d.freeLoopStart)) % (d.freeLoopEnd - d.freeLoopStart));
    }
    else {
      src.loop = true; // Loop sull'intera traccia
    }

    src.start(0, offset);
    d.src = src;
    d.st = ctx.currentTime - offset / d.speed;
    d.playing = true;
    $(\`dk-${i}\`).classList.add('playing');
    
    src.onended = () => {
      if (d.src === src) {
        d.playing = false;
        d.src = null;
        $(\`dk-${i}\`).classList.remove('playing');
      }
    };
    
    if (d.lockKey) {
      status(i, \`‚ñ∂ Riproduzione con KEY LOCK - pitch fisso a ${d.key || '--'}\`);
    }
  };

  window.stopDeck = function(i) {
    const d = D[i];
    if (d.playing && d.buf) {
      const elapsed = (ctx.currentTime - d.st) * d.speed;
      d.off = elapsed % d.buf.duration;
    }
    if (d.src) { try { d.src.stop(); } catch(e) {} d.src = null; }
    d.playing = false;
    $(\`dk-${i}\`).classList.remove('playing');
  };

  window.seekClick = function(i, e) {
    const d = D[i];
    if (!d.buf) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const ratio = clickX / rect.width;
    
    const zoom = d.zoom || 1;
    const zoomPos = d.zoomPos !== undefined ? d.zoomPos : 0.5;
    
    const viewSize = 1.0 / zoom;
    let viewStart = zoomPos - viewSize / 2;
    
    if (viewStart < 0) viewStart = 0;
    if (viewStart + viewSize > 1) viewStart = 1 - viewSize;
    
    const normPos = viewStart + ratio * viewSize;
    d.off = Math.max(0, Math.min(1, normPos)) * d.buf.duration;
    
    if (d.playing) window.playDeck(i);
  };

  // --- Load track (aggiornato) ---
  window.loadTrack = async function(i, el) {
    const file = el.files[0];
    if (!file) return;
    resumeCtx();
    $(\`tn-${i}\`).textContent = file.name;
    $(\`bb-${i}\`).textContent = '...';
    $(\`kbox-${i}\`).textContent = '...';
    status(i, 'Caricamento...');
    const d = D[i];
    if (d.playing) window.stopDeck(i);
    const ab = await file.arrayBuffer();
    ctx.decodeAudioData(ab, (buf) => {
      d.buf = buf;
      d.off = 0;
      d.speed = 1.0;
      d.beatOffMs = 0;
      d.loopBeats = 0;
      d.keyShift = 0;
      d.lockKey = false;
      d.zoom = 1.0;
      d.zoomPos = 0.5;
      d.loopMode = 'beat';
      d.freeLoopStart = 0;
      d.freeLoopEnd = 0;
      
      $(\`lk-${i}\`).classList.remove('locked');
      $(\`lk-${i}\`).textContent = 'KEY LOCK OFF';
      $(\`rs-${i}\`).value = 1;
      $(\`rv-${i}\`).textContent = '1.000';
      $(\`boff-${i}\`).value = 0;
      $(\`bm-${i}\`).value = '';
      $(\`ks-${i}\`).value = 0;
      $(\`zoom-${i}\`).value = 1;
      $(\`zoom-val-${i}\`).textContent = '1.0x';
      $(\`zoom-pos-${i}\`).value = 0.5;
      $(\`zoom-pos-val-${i}\`).textContent = '50%';
      $(\`loop-mode-${i}\`).textContent = 'MODE: BEAT';
      
      document.querySelectorAll(\`#beat-loop-${i} .loop-btn\`).forEach(b => b.classList.remove('on'));
      $(\`beat-loop-${i}\`).style.display = 'grid';
      $(\`free-loop-${i}\`).style.display = 'none';
      
      $(\`dk-${i}\`).classList.add('active');
      
      d.peaks = buildPeaks(buf, 1000);
      drawWF(i);
      
      status(i, 'Analisi BPM...');
      const bpm = detectBPM(buf);
      d.bpm = bpm; d.bpmNative = bpm;
      $(\`bb-${i}\`).textContent = bpm.toFixed(1);
      drawBG(i);
      
      status(i, 'Analisi tonalit√†...');
      detectKey(buf, (key) => {
        d.key = key;
        $(\`kdet-${i}\`).textContent = key || '--';
        $(\`kbox-${i}\`).textContent = key || '--';
        status(i, 'Pronto');
      });
    }, (err) => {
      console.error(err);
      status(i, 'Errore caricamento');
    });
  };

  window.setManualBPM = function(i, v) {
    const b = +v;
    if (isNaN(b) || b < 20) return;
    D[i].bpm = b;
    D[i].bpmNative = b;
    $(\`bb-${i}\`).textContent = b.toFixed(1);
    drawBG(i);
  };

  window.resetBPM = function(i) {
    if (!D[i].buf) return;
    const bpm = detectBPM(D[i].buf);
    D[i].bpm = bpm;
    D[i].bpmNative = bpm;
    $(\`bb-${i}\`).textContent = bpm.toFixed(1);
    $(\`bm-${i}\`).value = '';
    drawBG(i);
  };

  window.setOffset = function(i, v) {
    D[i].beatOffMs = +v || 0;
    drawBG(i);
  };

  window.nudge = function(i, delta) {
    D[i].beatOffMs += delta;
    $(\`boff-${i}\`).value = D[i].beatOffMs;
    drawBG(i);
  };

  // --- Zoom funzioni ---
  window.setZoom = function(i, z) {
    const d = D[i];
    d.zoom = Math.max(1, Math.min(10, +z));
    $(\`zoom-${i}\`).value = d.zoom;
    $(\`zoom-val-${i}\`).textContent = d.zoom.toFixed(1) + 'x';
    
    const btns = document.querySelectorAll(\`#dk-${i} .zoom-btn\`);
    btns.forEach(btn => {
      btn.classList.remove('active');
      const btnVal = parseFloat(btn.textContent.replace('x', ''));
      if (Math.abs(btnVal - d.zoom) < 0.1) {
        btn.classList.add('active');
      }
    });
    
    drawWF(i);
    drawBG(i);
  };

  window.setZoomPos = function(i, pos) {
    const d = D[i];
    d.zoomPos = Math.max(0, Math.min(1, +pos));
    $(\`zoom-pos-${i}\`).value = d.zoomPos;
    $(\`zoom-pos-val-${i}\`).textContent = Math.round(d.zoomPos * 100) + '%';
    
    drawWF(i);
    drawBG(i);
  };

  // --- Waveform functions ---
  function buildPeaks(buf, n) {
    const data = buf.getChannelData(0);
    const blockSize = Math.floor(data.length / n);
    const peaks = new Float32Array(n);
    for (let i = 0; i < n; i++) {
      let max = 0;
      const start = i * blockSize;
      for (let j = 0; j < blockSize; j++) {
        const val = Math.abs(data[start + j] || 0);
        if (val > max) max = val;
      }
      peaks[i] = max;
    }
    return peaks;
  }

  function drawWF(i) {
    const d = D[i];
    if (!d.peaks) return;
    const ww = $(\`ww-${i}\`);
    const cv = $(\`wc-${i}\`);
    if (!ww || !cv) return;
    cv.width = ww.clientWidth || 320;
    cv.height = ww.clientHeight || 80;
    const W = cv.width, H = cv.height;
    const c = cv.getContext('2d');
    c.clearRect(0, 0, W, H);
    
    const grad = c.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0, '#102a24');
    grad.addColorStop(1, '#03100d');
    c.fillStyle = grad;
    c.fillRect(0, 0, W, H);

    const zoom = d.zoom || 1;
    const zoomPos = d.zoomPos !== undefined ? d.zoomPos : 0.5;
    const totalPeaks = d.peaks.length;
    
    const viewSize = 1.0 / zoom;
    let viewStart = zoomPos - viewSize / 2;
    let viewEnd = zoomPos + viewSize / 2;
    
    if (viewStart < 0) {
      viewStart = 0;
      viewEnd = viewSize;
    }
    if (viewEnd > 1) {
      viewEnd = 1;
      viewStart = 1 - viewSize;
    }

    c.fillStyle = '#2ef0d0';
    const mid = H / 2;
    
    for (let x = 0; x < W; x++) {
      const normX = x / W;
      const t = viewStart + normX * (viewEnd - viewStart);
      const peakIdx = Math.floor(t * totalPeaks);
      if (peakIdx >= 0 && peakIdx < totalPeaks) {
        const amp = d.peaks[peakIdx] * mid * 0.9;
        c.fillRect(x, mid - amp, 1, amp * 2);
      }
    }
    
    c.strokeStyle = '#457066';
    c.beginPath(); 
    c.moveTo(0, mid); 
    c.lineTo(W, mid); 
    c.stroke();
  }

  function drawBG(i) {
    const d = D[i];
    const ww = $(\`ww-${i}\`);
    const cv = $(\`gc-${i}\`);
    if (!ww || !cv) return;
    cv.width = ww.clientWidth || 320;
    cv.height = ww.clientHeight || 80;
    const W = cv.width, H = cv.height;
    const c = cv.getContext('2d');
    c.clearRect(0, 0, W, H);
    
    if (!d.buf || !d.bpm) return;
    
    const dur = d.buf.duration;
    const beatSec = 60 / d.bpm;
    const offSec = d.beatOffMs / 1000;
    const zoom = d.zoom || 1;
    const zoomPos = d.zoomPos !== undefined ? d.zoomPos : 0.5;
    
    const viewSize = 1.0 / zoom;
    let viewStart = zoomPos - viewSize / 2;
    let viewEnd = zoomPos + viewSize / 2;
    
    if (viewStart < 0) {
      viewStart = 0;
      viewEnd = viewSize;
    }
    if (viewEnd > 1) {
      viewEnd = 1;
      viewStart = 1 - viewSize;
    }

    const tStart = viewStart * dur;
    const tEnd = viewEnd * dur;
    
    let t = offSec % beatSec;
    while (t < tStart - beatSec) t += beatSec;
    
    let beatNum = Math.floor((t - offSec) / beatSec);
    
    while (t <= tEnd + beatSec) {
      if (t >= tStart - beatSec * 0.5 && t <= tEnd + beatSec * 0.5) {
        const x = ((t - tStart) / (tEnd - tStart)) * W;
        if (x >= -5 && x <= W + 5) {
          const isDown = (beatNum % 4 === 0);
          c.beginPath();
          c.strokeStyle = isDown ? 'rgba(255, 100, 100, 0.9)' : 'rgba(46, 240, 208, 0.5)';
          c.lineWidth = isDown ? 2.5 : 1.2;
          c.moveTo(x, isDown ? 0 : H * 0.2);
          c.lineTo(x, H);
          c.stroke();
          
          if (isDown) {
            c.fillStyle = '#ffb0b0';
            c.font = 'bold 8px monospace';
            c.fillText(Math.floor(beatNum / 4) + 1, x + 3, 14);
          }
        }
      }
      t += beatSec;
      beatNum++;
      if (beatNum > 2000) break;
    }
  }

  function updatePlayheadPos(i, pos) {
    const d = D[i];
    if (!d.buf) return;
    
    const zoom = d.zoom || 1;
    const zoomPos = d.zoomPos !== undefined ? d.zoomPos : 0.5;
    
    const viewSize = 1.0 / zoom;
    let viewStart = zoomPos - viewSize / 2;
    let viewEnd = zoomPos + viewSize / 2;
    
    if (viewStart < 0) {
      viewStart = 0;
      viewEnd = viewSize;
    }
    if (viewEnd > 1) {
      viewEnd = 1;
      viewStart = 1 - viewSize;
    }
    
    const normPos = pos / d.buf.duration;
    
    if (normPos >= viewStart && normPos <= viewEnd) {
      const relativePos = (normPos - viewStart) / (viewEnd - viewStart);
      $(\`ph-${i}\`).style.left = (relativePos * 100) + '%';
      $(\`ph-${i}\`).style.opacity = '1';
    } else {
      $(\`ph-${i}\`).style.opacity = '0.3';
      if (normPos < viewStart) {
        $(\`ph-${i}\`).style.left = '0%';
      } else {
        $(\`ph-${i}\`).style.left = '100%';
      }
    }
  }

  // --- BPM detection ---
  function detectBPM(buf) {
    const sr = buf.sampleRate;
    const data = buf.getChannelData(0);
    const maxS = Math.min(data.length, sr * 40);
    const ds = Math.floor(sr / 3000);
    const down = new Float32Array(Math.ceil(maxS / ds));
    for (let i = 0, j = 0; i < maxS; i += ds, j++) down[j] = data[i];
    const dsr = sr / ds;
    const wsz = Math.floor(dsr * 0.025);
    const E = [];
    for (let i = 0; i < down.length; i += wsz) {
      let s = 0;
      for (let j = 0; j < wsz && i + j < down.length; j++) s += down[i + j] * down[i + j];
      E.push(Math.sqrt(s / wsz));
    }
    const onset = new Float32Array(E.length - 1);
    for (let i = 1; i < E.length; i++) { 
      const d = E[i] - E[i - 1]; 
      onset[i - 1] = d > 0 ? d : 0; 
    }
    const efr = dsr / wsz;
    const minP = Math.floor(efr * 60 / 200);
    const maxP = Math.floor(efr * 60 / 60);
    let bestP = minP, bestS = -1;
    for (let p = minP; p <= maxP; p++) {
      let s = 0;
      for (let i = 0; i + p < onset.length; i++) s += onset[i] * onset[i + p];
      if (s > bestS) { bestS = s; bestP = p; }
    }
    let bpm = (efr / bestP) * 60;
    while (bpm < 80) bpm *= 2;
    while (bpm > 180) bpm /= 2;
    if (bpm < 40 || bpm > 240) bpm = 120;
    return Math.round(bpm * 10) / 10;
  }

  // --- Key detection ---
  const KS_MAJ = [6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88];
  const KS_MIN = [6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17];
  const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

  function detectKey(buf, cb) {
    try {
      const sr = buf.sampleRate;
      const len = Math.min(buf.length, sr * 30);
      const data = buf.getChannelData(0).slice(0, len);
      const chroma = new Float32Array(12).fill(0);
      const fft = 4096, hop = 2048;
      let frames = 0;
      for (let start = 0; start + fft < data.length; start += hop) {
        for (let m = 36; m < 96; m++) {
          const freq = 440 * Math.pow(2, (m - 69) / 12);
          const omega = 2 * Math.PI * freq / sr;
          let re = 0, im = 0;
          for (let j = 0; j < fft; j += 3) {
            re += data[start + j] * Math.cos(omega * j);
            im -= data[start + j] * Math.sin(omega * j);
          }
          chroma[m % 12] += Math.sqrt(re * re + im * im);
        }
        frames++;
        if (frames > 20) break;
      }
      const mx = Math.max(...chroma) || 1;
      for (let k = 0; k < 12; k++) chroma[k] /= mx;
      let bestKey = 'C', bestScore = -Infinity;
      for (let r = 0; r < 12; r++) {
        let sm = 0, sn = 0;
        for (let j = 0; j < 12; j++) {
          sm += chroma[j] * KS_MAJ[(j - r + 12) % 12];
          sn += chroma[j] * KS_MIN[(j - r + 12) % 12];
        }
        if (sm > bestScore) { bestScore = sm; bestKey = NOTES[r]; }
        if (sn > bestScore) { bestScore = sn; bestKey = NOTES[r] + 'm'; }
      }
      cb(bestKey);
    } catch (e) {
      cb(null);
    }
  }

  // --- Animation tick ---
  function tick() {
    for (let i = 0; i < N; i++) {
      const d = D[i];
      if (!d.buf || !d.playing) continue;
      
      const elapsed = (ctx.currentTime - d.st) * d.speed;
      let pos;
      
      if (d.loopMode === 'beat' && d.loopBeats > 0 && d.bpm > 0) {
        const ll = (60 / d.bpm) * d.loopBeats;
        const le = d.loopStart + ll;
        pos = (le <= d.buf.duration) ? d.loopStart + (elapsed % ll) : elapsed % d.buf.duration;
      } 
      else if (d.loopMode === 'free' && d.freeLoopEnd > d.freeLoopStart) {
        const loopLen = d.freeLoopEnd - d.freeLoopStart;
        pos = d.freeLoopStart + (elapsed % loopLen);
      }
      else {
        pos = elapsed % d.buf.duration;
      }
      
      updatePlayheadPos(i, pos);
    }
    requestAnimationFrame(tick);
  }

  // --- Resize ---
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      for (let i = 0; i < N; i++) {
        if (D[i].peaks) { drawWF(i); drawBG(i); }
      }
    }, 150);
  });

  window.setMaster = function(i) {
    masterIdx = i;
    for (let j = 0; j < N; j++) {
      $(\`dk-${j}\`).classList.toggle('master', j === i);
    }
  };

  window.syncDeck = function(i) {
    if (i === masterIdx) { status(i, 'Gi√† Master'); return; }
    const mb = D[masterIdx].bpmNative;
    const db = D[i].bpmNative;
    if (!mb || !db) { alert('BPM mancante'); return; }
    const ratio = Math.min(2, Math.max(0.5, mb / db));
    D[i].bpm = mb;
    window.setSpeed(i, ratio);
    status(i, \`Sync ${mb.toFixed(1)} BPM (x${ratio.toFixed(3)})\`);
  };

  // --- Inizializza ---
  window.setMaster(0);
  
  for (let i = 0; i < N; i++) {
    window.setZoom(i, 1);
    window.setZoomPos(i, 0.5);
  }
  
  tick();

})();
<\/script>
</body>
</html>`,
  SYNTH: `<!doctype html>
<html lang="it">
<head>
<script>
/* MaxiHost bootstrap for section SYNTH */
(function(){
  const SECTION_ID = 'SYNTH';
  // ---- Shared audio routing via parent ----
  function getProxy(){
    const host = window.parent && window.parent.MaracaHost;
    if (!host) return null;
    return host.getAudioProxy(SECTION_ID);
  }
  const proxy = getProxy();
  if (proxy) {
    // Replace constructors used by apps
    window.AudioContext = function(){ return proxy; };
    window.webkitAudioContext = function(){ return proxy; };
  }

  // ---- Mic gating (single-owner) ----
  const md = navigator.mediaDevices;
  if (md && md.getUserMedia) {
    const orig = md.getUserMedia.bind(md);
    md.getUserMedia = function(constraints){
      const host = window.parent && window.parent.MaracaHost;
      if (!host) return orig(constraints);
      return host.requestMic(SECTION_ID, constraints);
    };
  }

  // ---- Resume helper (some apps call ctx.resume on user gesture) ----
  window.addEventListener('pointerdown', () => {
    try {
      const host = window.parent && window.parent.MaracaHost;
      if (host) host.resumeAudio();
    } catch(e){}
  }, {passive:true});
})();
<\/script>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MaracaSynth</title>
<style>
:root{
  --bg:#07080d;
  --txt:#e7eefc;
  --muted:#6a82a8;
  --accent:#4ea1ff;
  --accent2:#6af0c2;
  --warn:#ffcc66;
  --bad:#ff5c7a;
  --ok:#4bf08a;
  --purple:#c07aff;
  --br:16px;
  --gap:12px;
  --shadow:0 14px 50px rgba(0,0,0,.55);
  --line:1px solid rgba(255,255,255,.07);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(ellipse 1600px 700px at 20% -5%,rgba(78,161,255,.18) 0%,transparent 60%),
    radial-gradient(ellipse 1000px 600px at 85% 15%,rgba(106,240,194,.13) 0%,transparent 55%),
    radial-gradient(ellipse 900px 500px at 50% 95%,rgba(192,122,255,.12) 0%,transparent 55%),
    var(--bg);
  color:var(--txt);
  overflow-x:hidden;
}
.wrap{max-width:1320px;margin:0 auto;padding:18px 18px 70px}

header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;}
.logo{display:flex;align-items:center;gap:14px;}
.logo-icon{
  width:48px;height:48px;border-radius:15px;
  background:linear-gradient(135deg,#4ea1ff,#6af0c2);
  display:grid;place-items:center;font-size:24px;
  box-shadow:0 0 28px rgba(78,161,255,.55);
}
h1{font-size:22px;font-weight:900;letter-spacing:-.4px;}
h1 em{color:var(--accent2);font-style:normal;}
.sub{color:var(--muted);font-size:12px;margin-top:3px;}

.pill{
  padding:6px 14px;border-radius:999px;font-size:12px;
  border:var(--line);background:rgba(255,255,255,.04);
  color:var(--muted);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
}
.pill b{color:var(--txt)}

@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0;}
.dot.green{background:var(--ok);animation:pulse 1.5s infinite;}
.dot.red{background:var(--bad);}

.card{
  background:linear-gradient(160deg,rgba(255,255,255,.055) 0%,rgba(255,255,255,.018) 100%);
  border:var(--line);border-radius:var(--br);box-shadow:var(--shadow);
}

.top-grid{display:grid;grid-template-columns:1.4fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
@media(max-width:900px){.top-grid{grid-template-columns:1fr}}

.controls{padding:16px;}
.btn-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px;}
.btn{
  appearance:none;border:var(--line);background:rgba(255,255,255,.06);
  color:var(--txt);padding:10px 16px;border-radius:13px;cursor:pointer;
  font-weight:700;font-size:13px;display:inline-flex;align-items:center;
  gap:8px;transition:all .1s ease;user-select:none;white-space:nowrap;
}
.btn:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);}
.btn:active{transform:translateY(1px);}
.btn.primary{border-color:rgba(78,161,255,.6);background:rgba(78,161,255,.18);}
.btn.danger{border-color:rgba(255,92,122,.6);background:rgba(255,92,122,.16);}
.btn.ok{border-color:rgba(75,240,138,.5);background:rgba(75,240,138,.13);}
.btn.warn{border-color:rgba(255,204,102,.5);background:rgba(255,204,102,.12);}
.btn.purple{border-color:rgba(192,122,255,.5);background:rgba(192,122,255,.12);}
.btn.hold-active{
  border-color:rgba(255,204,102,.9)!important;
  background:rgba(255,204,102,.25)!important;
  color:var(--warn)!important;
  box-shadow:0 0 18px rgba(255,204,102,.35);
}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;}
@media(max-width:560px){.g2,.g3{grid-template-columns:1fr}}

.kv{padding:10px;border-radius:12px;border:var(--line);background:rgba(0,0,0,.22);}
.kv label{display:flex;justify-content:space-between;font-size:11.5px;color:var(--muted);margin-bottom:6px;}
.kv label b{color:var(--txt);}
.kv .hint{font-size:10.5px;color:var(--muted);margin-top:4px;}
input[type=range]{width:100%;accent-color:var(--accent);cursor:pointer;}
select,input[type=number]{
  width:100%;padding:8px 10px;border-radius:11px;
  border:var(--line);background:rgba(0,0,0,.32);color:var(--txt);
  font-size:12.5px;outline:none;
}
select:focus,input[type=number]:focus{border-color:rgba(78,161,255,.5);}

.scope-card{padding:14px;display:flex;flex-direction:column;gap:10px;}
.scope-hdr{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
canvas#scope{width:100%;height:160px;border-radius:12px;border:var(--line);background:rgba(0,0,0,.35);display:block;}

.vu-wrap{display:flex;align-items:center;gap:8px;margin-top:2px;}
.vu-bar{flex:1;height:6px;border-radius:3px;background:rgba(0,0,0,.35);border:var(--line);overflow:hidden;}
.vu-fill{height:100%;width:0%;border-radius:3px;transition:width .08s linear;
  background:linear-gradient(90deg,#4bf08a 0%,#ffcc66 65%,#ff5c7a 100%);}

#kbd-card{margin-bottom:var(--gap);}
.kbd-top{
  padding:14px 16px 10px;
  display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
}
.kbd-title{font-weight:800;font-size:15px;display:flex;align-items:center;gap:10px;}
.kbd-opts{
  padding:0 16px 10px;
  display:flex;flex-wrap:wrap;gap:14px;align-items:center;font-size:12px;color:var(--muted);
}
.kbd-opts .opt-group{display:flex;align-items:center;gap:6px;}
.kbd-opts select{width:auto;padding:5px 8px;font-size:11.5px;border-radius:8px;}
.kbd-opts input[type=range]{width:70px;}
.kbd-opts code{
  background:rgba(255,255,255,.08);padding:2px 6px;border-radius:5px;
  font-family:monospace;font-size:10.5px;color:var(--accent2);
}

.kbd-scroll{overflow-x:auto;padding:0 16px 16px;scrollbar-width:thin;}
.keyboard{
  position:relative;display:flex;align-items:flex-start;
  height:140px;min-width:max-content;user-select:none;
}
.kw{
  position:relative;flex-shrink:0;
  width:38px;height:138px;
  background:linear-gradient(180deg,#cdd9ef 0%,#f0f5ff 55%,#e2ecff 100%);
  border:1px solid #9aadcc;border-top:none;
  border-radius:0 0 9px 9px;
  cursor:pointer;z-index:1;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
  padding-bottom:7px;gap:1px;
  transition:background .05s,box-shadow .05s;
}
.kw:hover{background:linear-gradient(180deg,#bdd0ef 0%,#e0ecff 55%,#d2e4ff 100%);}
.kw.pressed{
  background:linear-gradient(180deg,#4ea1ff 0%,#70b8ff 55%,#a0d0ff 100%);
  box-shadow:inset 0 4px 14px rgba(78,161,255,.7), 0 0 20px rgba(78,161,255,.5);
}
.kw .kname{font-size:9.5px;font-weight:800;color:#3a4a6a;letter-spacing:-.2px;}
.kw .kfreq{font-size:7.5px;color:#6a7a9a;font-family:monospace;}
.kw .kpc{
  position:absolute;top:6px;left:0;right:0;text-align:center;
  font-size:8.5px;font-weight:800;color:rgba(60,80,140,.55);
}
.kw.pressed .kname{color:#002244;}
.kw.pressed .kfreq{color:#003366;}
.kw.pressed .kpc{color:rgba(0,30,80,.5);}

.kw.anchor{
  background:linear-gradient(180deg,#e0c8ff 0%,#f5efff 55%,#ecdeff 100%);
  border-color:#b090e0;
}
.kw.anchor:hover{background:linear-gradient(180deg,#d0b8ff 0%,#e8e0ff 55%,#dcceff 100%);}
.kw.anchor.pressed{background:linear-gradient(180deg,#c07aff 0%,#d8a0ff 55%,#e8c8ff 100%);}

.kb{
  position:absolute;top:0;z-index:2;
  width:24px;height:84px;
  background:linear-gradient(180deg,#14182a 0%,#22263c 65%,#2e3450 100%);
  border:1px solid #0a0c18;
  border-radius:0 0 6px 6px;
  cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
  padding-bottom:5px;gap:1px;
  transition:background .05s,box-shadow .05s;
}
.kb:hover{background:linear-gradient(180deg,#1e2240 0%,#2e3254 65%,#3e4468 100%);}
.kb.pressed{
  background:linear-gradient(180deg,#2d6ab8 0%,#3a7ecc 65%,#5090d8 100%);
  box-shadow:inset 0 3px 10px rgba(78,161,255,.6), 0 0 14px rgba(78,161,255,.4);
}
.kb .kname{font-size:8px;font-weight:800;color:rgba(255,255,255,.55);}
.kb .kfreq{font-size:6.5px;color:rgba(255,255,255,.35);font-family:monospace;}
.kb .kpc{
  position:absolute;top:5px;left:0;right:0;text-align:center;
  font-size:7.5px;font-weight:800;color:rgba(200,220,255,.4);
}
.kb.pressed .kname{color:rgba(255,255,255,.9);}
.kb.pressed .kfreq{color:rgba(200,230,255,.8);}

.active-notes{
  padding:8px 16px 12px;
  display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:36px;
}
.note-chip{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 9px;border-radius:999px;font-size:11px;font-weight:700;
  background:rgba(78,161,255,.18);border:1px solid rgba(78,161,255,.4);color:var(--accent);
  animation:chipIn .1s ease;
}
@keyframes chipIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.note-chip .nhz{font-size:9.5px;font-weight:400;color:var(--muted);}

.section-title{
  display:flex;align-items:center;gap:10px;margin-bottom:var(--gap);
  font-size:12px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;
}
.section-title::after{content:'';flex:1;height:1px;background:var(--line);}

.voices{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap);}
@media(max-width:900px){.voices{grid-template-columns:1fr}}

.voice{padding:14px;}
.voice.kbd-active{border-color:rgba(78,161,255,.4);box-shadow:var(--shadow),0 0 20px rgba(78,161,255,.18);}
.vhead{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;}
.vleft{display:flex;align-items:center;gap:10px;}
.badge{
  width:30px;height:30px;border-radius:9px;
  display:grid;place-items:center;border:var(--line);
  background:rgba(255,255,255,.05);font-weight:900;font-size:14px;
}
.vname{font-weight:800;font-size:13px;}
.vinfo{font-size:10.5px;color:var(--muted);font-family:monospace;margin-top:1px;}
.ntag{
  display:inline-block;padding:1px 6px;border-radius:5px;
  font-size:9.5px;font-weight:800;
  background:rgba(78,161,255,.15);color:var(--accent);
  border:1px solid rgba(78,161,255,.28);margin-left:4px;
}
.toggles{display:flex;gap:5px;flex-wrap:wrap;}
.chip{
  border:var(--line);background:rgba(255,255,255,.04);
  color:var(--txt);padding:6px 9px;border-radius:999px;
  font-weight:700;cursor:pointer;user-select:none;
  font-size:11px;transition:all .1s ease;
}
.chip:hover{background:rgba(255,255,255,.1);}
.chip.on{border-color:rgba(106,240,194,.55);background:rgba(106,240,194,.14);color:var(--accent2);}
.chip.mute.on{border-color:rgba(255,92,122,.5);background:rgba(255,92,122,.13);color:var(--bad);}
.chip.solo.on{border-color:rgba(255,204,102,.6);background:rgba(255,204,102,.15);color:var(--warn);}

.mono{font-family:monospace;}
.small{font-size:11.5px;color:var(--muted);}
.footer-note{margin-top:14px;color:var(--muted);font-size:11.5px;line-height:1.55;}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:rgba(0,0,0,.2);}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px;}
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header>
  <div class="logo">
    <div>
      <h1>Maraca<em>Synth</em> <small style="font-size:12px;font-weight:400;color:var(--muted)">v3</small></h1>
      <div class="sub">BEST-SYNTH</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <div class="pill"><span class="dot red" id="sdot"></span><b id="status">STOP</b><span class="mono" id="sr"></span></div>
    <div class="pill">Mix: <b id="mixInfo">‚Äî</b></div>
    <div class="pill">Voci attive: <b id="polyCount">0</b></div>
  </div>
</header>

<!-- TOP GRID -->
<section class="top-grid">

  <!-- CONTROLS -->
  <div class="card controls">
    <div class="btn-row">
      <button class="btn primary" id="btnStart">Start</button>
      <button class="btn danger" id="btnStop" disabled>Stop</button>
      <button class="btn" id="btnPanic">Panic</button>
      <button class="btn warn" id="btnHold">HOLD: OFF</button>
      <button class="btn purple" id="btnAllOff">All Notes Off</button>
    </div>

    <div class="g2">
      <div class="kv">
        <label><span>Master Volume</span><b id="masterVal">0.40</b></label>
        <input id="master" type="range" min="0" max="1" step="0.001" value="0.40">
        <div class="vu-wrap"><span style="font-size:10px;color:var(--muted)">VU</span><div class="vu-bar"><div class="vu-fill" id="vuFill"></div></div></div>
      </div>
      <div class="kv">
        <label><span>Limiter</span><b id="limVal">‚àí6 dB</b></label>
        <input id="limiter" type="range" min="-24" max="-1" step="1" value="-6">
        <div class="hint">DynamicsCompressor anti-clip</div>
      </div>
    </div>

    <div class="g3">
      <div class="kv">
        <label><span>Attack</span><b id="aVal">0.010 s</b></label>
        <input id="atk" type="range" min="0.001" max="2" step="0.001" value="0.010">
      </div>
      <div class="kv">
        <label><span>Decay</span><b id="dVal">0.100 s</b></label>
        <input id="dec" type="range" min="0.001" max="2" step="0.001" value="0.100">
      </div>
      <div class="kv">
        <label><span>Sustain</span><b id="sVal">0.75</b></label>
        <input id="sus" type="range" min="0" max="1" step="0.001" value="0.75">
      </div>
    </div>

    <div class="g3">
      <div class="kv">
        <label><span>Release</span><b id="rVal">0.300 s</b></label>
        <input id="rel" type="range" min="0.001" max="5" step="0.001" value="0.300">
      </div>
      <div class="kv">
        <label><span>Global Detune</span><b id="gDetVal">0 ¬¢</b></label>
        <input id="gDet" type="range" min="-100" max="100" step="1" value="0">
      </div>
      <div class="kv">
        <label><span>Preset</span><b>Quick</b></label>
        <div style="display:flex;gap:8px;">
          <button class="btn" id="presetChord" style="flex:1;padding:8px 6px;font-size:12px;">Chord</button>
          <button class="btn" id="presetHarm" style="flex:1;padding:8px 6px;font-size:12px;">Harm</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card scope-card">
    <div class="scope-hdr">
      <div class="pill">üì° Oscilloscopio</div>
      <div style="display:flex;gap:8px;">
        <div class="pill">FPS <b id="fps">‚Äî</b></div>
        <div class="pill">RMS <b id="rmsVal">‚Äî</b></div>
      </div>
    </div>
    <canvas id="scope" width="900" height="260"></canvas>
    <div class="small">Segnale post-limiter. Forma piatta = clipping ‚Üí abbassa master.</div>
  </div>

</section>

<div class="card" id="kbd-card">
  <div class="kbd-top">
    <div class="kbd-title">üéπ Tastiera Polifonica
      <span class="pill" style="background:rgba(192,122,255,.1);border-color:rgba(192,122,255,.4);color:var(--purple);">A5 = 880 Hz</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn warn" id="btnHold2">üîí HOLD: OFF</button>
      <button class="btn purple" id="btnAllOff2">üîá All Notes Off</button>
    </div>
  </div>

  <div class="kbd-opts">
    <div class="opt-group">
      <span>Forma d'onda:</span>
      <select id="kbdWave">
        <option value="sine">Sine „Äú</option>
        <option value="triangle" selected>Triangle ‚ñ≥</option>
        <option value="sawtooth">Sawtooth /|</option>
        <option value="square">Square ‚ñ≠</option>
      </select>
    </div>
    <div class="opt-group">
      <span>Gain nota:</span>
      <input type="range" id="kbdLevel" min="0.01" max="0.55" step="0.01" value="0.22">
      <b id="kbdLvlVal" style="color:var(--accent2);">0.22</b>
    </div>
    <div class="opt-group">
      <span>Max voci:</span>
      <select id="kbdMaxPoly">
        <option value="8">8</option>
        <option value="16" selected>16</option>
        <option value="32">32</option>
        <option value="64">64</option>
      </select>
    </div>
    <div class="opt-group">
      <span>Tasti PC bianchi: <code>A S D F G H J | K L ; '</code> ‚Äî neri: <code>W E&nbsp; T Y U&nbsp; | O P&nbsp; [</code></span>
    </div>
  </div>

  <div class="kbd-scroll">
    <div class="keyboard" id="keyboard"></div>
  </div>

  <div class="active-notes" id="activeNotes">
    <span class="small" style="color:var(--muted);">Note attive:</span>
    <span class="small" id="noNotes" style="color:var(--muted);">‚Äî</span>
  </div>
</div>

<!-- MANUAL VOICES -->
<div class="section-title">‚ö° Voci Manuali (8 oscillatori fissi)</div>
<section class="voices" id="voices"></section>

<div class="footer-note">
  üí° <b>Polifonia:</b> ogni tasto della tastiera crea un oscillatore WebAudio dedicato (fino al max voci impostato). 
  Le 8 voci sotto sono <em>oscillatori manuali fissi</em> per sound design. 
  <b>HOLD</b> mantiene tutte le note finch√© non lo disattivi o premi "All Notes Off". 
  Il tasto <span style="color:var(--purple);font-weight:700;">viola</span> sulla tastiera √® A5=880Hz.
</div>
</div><!-- /wrap -->

<script>
(()=>{
"use strict";

// ============================================================
// COSTANTI E FREQUENZE
// ============================================================
const NOTE_NAMES  = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTE_WNAMES = ["C", "D", "E", "F", "G", "A", "B"];
const NOTE_BNAMES = ["C#","D#",null,"F#","G#","A#",null]; // null = no black key between E-F and B-C

// A5 = MIDI 81 = 880 Hz (referenza)
// Formula: freq = 440 * 2^((midi-69)/12)
function midiToFreq(midi){ return 440 * Math.pow(2,(midi-69)/12); }
function freqToNoteName(midi){
  const n = ((midi%12)+12)%12;
  const oct = Math.floor(midi/12)-1;
  return NOTE_NAMES[n]+oct;
}

// A5 = MIDI 81. Costruiamo da C2 (MIDI 36) a C8 (MIDI 108)
const MIDI_START = 36; // C2
const MIDI_END   = 108; // C8
const ANCHOR_MIDI = 81; // A5 = 880 Hz

// ============================================================
// PC KEYBOARD MAPPING
// Layout: 2 ottave di tasti visibili nella finestra principale
// bianchi: A S D F G H J | K L ; '  (12 bianchi = 1.7 ottave)
// neri:    W E   T Y U   | O P   [
// ============================================================
const PC_WHITE = ['a','s','d','f','g','h','j','k','l',';',"'",'z','x','c'];
const PC_BLACK = ['w','e','','t','y','u','','o','p','','[','','',''];

// ============================================================
// DOM REFS
// ============================================================
const $= id=>document.getElementById(id);
const statusEl=$("status"), sdot=$("sdot"), srEl=$("sr");
const mixInfoEl=$("mixInfo"), polyCountEl=$("polyCount");
const masterEl=$("master"), masterValEl=$("masterVal");
const limiterEl=$("limiter"), limValEl=$("limVal");
const atkEl=$("atk"), decEl=$("dec"), susEl=$("sus"), relEl=$("rel");
const aValEl=$("aVal"), dValEl=$("dVal"), sValEl=$("sVal"), rValEl=$("rVal");
const gDetEl=$("gDet"), gDetValEl=$("gDetVal");
const btnStart=$("btnStart"), btnStop=$("btnStop"), btnPanic=$("btnPanic");
const btnHold=$("btnHold"), btnHold2=$("btnHold2");
const btnAllOff=$("btnAllOff"), btnAllOff2=$("btnAllOff2");
const presetChord=$("presetChord"), presetHarm=$("presetHarm");
const scopeCanvas=$("scope"), ctx=scopeCanvas.getContext("2d");
const fpsEl=$("fps"), rmsValEl=$("rmsVal"), vuFill=$("vuFill");
const voicesRoot=$("voices");
const kbdEl=$("keyboard");
const kbdWave=$("kbdWave"), kbdLevel=$("kbdLevel"), kbdLvlVal=$("kbdLvlVal");
const kbdMaxPoly=$("kbdMaxPoly");
const activeNotesEl=$("activeNotes"), noNotesEl=$("noNotes");

// ============================================================
// STATO
// ============================================================
let ac=null, masterGain=null, compressor=null, analyser=null;
const state={
  running:false,
  hold:false,
  adsr:{a:.010,d:.100,s:.75,r:.300},
  globalDetune:0
};

// Polifonia tastiera: midi -> {osc, gainNode, panner}
const polyVoices = new Map(); // midi -> voice object

// 8 voci manuali fisse
const fixedVoices = [];
const MAX_FIXED = 8;

// ============================================================
// AUDIO INIT
// ============================================================
function ensureAudio(){
  if(ac) return;
  ac = new (window.AudioContext||window.webkitAudioContext)({latencyHint:"interactive"});
  masterGain = ac.createGain();
  masterGain.gain.value = +masterEl.value;

  compressor = ac.createDynamicsCompressor();
  compressor.threshold.value = +limiterEl.value;
  compressor.knee.value = 16;
  compressor.ratio.value = 10;
  compressor.attack.value = 0.002;
  compressor.release.value = 0.10;

  analyser = ac.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.80;

  compressor.connect(masterGain);
  masterGain.connect(analyser);
  analyser.connect(ac.destination);

  srEl.textContent = \` ¬∑ ${Math.round(ac.sampleRate)} Hz\`;

  // Build 8 fixed voices
  for(let i=0;i<MAX_FIXED;i++){
    const osc = ac.createOscillator();
    osc.type = "sine"; osc.frequency.value=440; osc.detune.value=0;
    const g = ac.createGain(); g.gain.value=0;
    const p = ac.createStereoPanner(); p.pan.value=0;
    osc.connect(g).connect(p).connect(compressor);
    osc.start();
    fixedVoices.push({
      idx:i+1, osc, gain:g, panner:p,
      params:{on:false,solo:false,mute:false,waveform:"sine",freq:440,detune:0,level:0.20,pan:0}
    });
  }
  buildFixedVoiceUI();
  buildKeyboard(); // rebuild with audio ready
  updateMixInfo();
}

// ============================================================
// POLY NOTE ON / OFF
// ============================================================
function polyNoteOn(midi, freq){
  if(!ac) return;
  if(ac.state==="suspended") ac.resume();
  if(polyVoices.has(midi)) return; // gi√† suona

  const maxPoly = +kbdMaxPoly.value;
  // Steal oldest voice if at limit
  if(polyVoices.size >= maxPoly){
    const oldestMidi = polyVoices.keys().next().value;
    polyNoteOff(oldestMidi, true);
  }

  const t = ac.currentTime;
  const {a,d,s} = state.adsr;
  const level = +kbdLevel.value;

  const osc = ac.createOscillator();
  osc.type = kbdWave.value;
  osc.frequency.value = freq;
  osc.detune.value = state.globalDetune;

  const g = ac.createGain();
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(level, t+a);
  g.gain.linearRampToValueAtTime(level*s, t+a+d);

  const pan = ac.createStereoPanner();
  pan.pan.value = 0;

  osc.connect(g).connect(pan).connect(compressor);
  osc.start(t);

  polyVoices.set(midi, {osc, gain:g, panner:pan, freq, startTime:t});

  // Visual
  markKey(midi, true);
  updateActiveNotesUI();
  updatePolyCount();
  updateMixInfo();
}

function polyNoteOff(midi, immediate=false){
  const v = polyVoices.get(midi);
  if(!v) return;

  const t = ac.currentTime;
  const r = immediate ? 0.01 : state.adsr.r;

  v.gain.gain.cancelScheduledValues(t);
  v.gain.gain.setValueAtTime(v.gain.gain.value, t);
  v.gain.gain.linearRampToValueAtTime(0, t+r);

  // Stop and disconnect after release
  const stopTime = t + r + 0.05;
  v.osc.stop(stopTime);
  setTimeout(()=>{
    try{v.gain.disconnect();v.panner.disconnect();}catch(e){}
  }, (r+0.1)*1000);

  polyVoices.delete(midi);
  markKey(midi, false);
  updateActiveNotesUI();
  updatePolyCount();
  updateMixInfo();
}

function allNotesOff(){
  const midiList = [...polyVoices.keys()];
  midiList.forEach(midi => polyNoteOff(midi));
  updateActiveNotesUI();
  updatePolyCount();
}

// ============================================================
// KEYBOARD BUILD
// ============================================================
// Layout: da C2 (MIDI 36) a B7 (MIDI 107)
// Tasti bianchi: ogni C D E F G A B
// Neri: tra i bianchi giusti

const keyEls = new Map(); // midi -> element
let pcKeyToMidi = new Map();

function buildKeyboard(){
  kbdEl.innerHTML = "";
  keyEls.clear();
  pcKeyToMidi.clear();

  // Calcola layout: prima metti i bianchi, poi overlay dei neri
  // Strategia: costruiamo un array di (midi, isBlack, whiteIndex)
  const layout = [];
  let whiteCount = 0;
  for(let midi = MIDI_START; midi <= MIDI_END; midi++){
    const semitone = ((midi%12)+12)%12;
    const isBlack = [1,3,6,8,10].includes(semitone);
    layout.push({midi, isBlack, whiteIndex: isBlack ? -1 : whiteCount});
    if(!isBlack) whiteCount++;
  }

  // Piano container: larghezza totale = whiteCount * (38+2px gap)
  const W = 40; // white key width + gap
  const BW = 24, BH = 84; // black key
  kbdEl.style.width = (whiteCount * W) + "px";
  kbdEl.style.position = "relative";

  // Map di whiteIndex -> x position
  const whiteX = []; // whiteX[i] = pixel x of i-th white key
  for(let i=0;i<whiteCount;i++) whiteX[i] = i*W;

  // White keys first
  layout.filter(k=>!k.isBlack).forEach(k=>{
    const noteName = freqToNoteName(k.midi);
    const freq = midiToFreq(k.midi);
    const isAnchor = (k.midi === ANCHOR_MIDI);

    const div = document.createElement("div");
    div.className = "kw" + (isAnchor?" anchor":"");
    div.style.cssText = \`position:absolute;left:${whiteX[k.whiteIndex]}px;top:0;\`;
    div.dataset.midi = k.midi;
    div.innerHTML = \`
      <div class="kpc" id="kpc_${k.midi}"></div>
      <span class="kname">${noteName}</span>
      <span class="kfreq">${Math.round(freq)}Hz</span>
    \`;
    kbdEl.appendChild(div);
    keyEls.set(k.midi, div);
    bindKeyEl(div, k.midi, freq);
  });

  // Black keys overlay
  // For each white key, check if there's a black key to its right
  // Black key sits at: whiteX[i] + W - BW/2 + 1
  layout.filter(k=>k.isBlack).forEach(k=>{
    // find the white key just below (lower midi)
    const prevWhite = layout.filter(w=>!w.isBlack && w.midi < k.midi).pop();
    if(!prevWhite) return;
    const x = whiteX[prevWhite.whiteIndex] + W - Math.floor(BW/2) + 1;

    const noteName = freqToNoteName(k.midi);
    const freq = midiToFreq(k.midi);

    const div = document.createElement("div");
    div.className = "kb";
    div.style.cssText = \`left:${x}px;\`;
    div.dataset.midi = k.midi;
    div.innerHTML = \`
      <div class="kpc" id="kpc_${k.midi}"></div>
      <span class="kname">${noteName}</span>
      <span class="kfreq">${Math.round(freq)}Hz</span>
    \`;
    kbdEl.appendChild(div);
    keyEls.set(k.midi, div);
    bindKeyEl(div, k.midi, freq);
  });

  // Assign PC key labels ‚Äî center around A5 (MIDI 81)
  // Get white keys near A5
  const anchorWhiteIdx = layout.find(k=>k.midi===ANCHOR_MIDI)?.whiteIndex ?? 0;
  // Map white keys starting ~7 before anchor
  const whiteLayout = layout.filter(k=>!k.isBlack);
  const anchorWhitePos = whiteLayout.findIndex(k=>k.midi===ANCHOR_MIDI);
  const startWhitePos = Math.max(0, anchorWhitePos - 5); // A is the 6th white key in the visible range

  PC_WHITE.forEach((pck, i) => {
    if(!pck) return;
    const wk = whiteLayout[startWhitePos + i];
    if(!wk) return;
    pcKeyToMidi.set(pck, wk.midi);
    const lbl = document.getElementById(\`kpc_${wk.midi}\`);
    if(lbl) lbl.textContent = pck.toUpperCase();
  });

  // Black keys near same range
  const blackLayout = layout.filter(k=>k.isBlack);
  // find black keys that correspond to the white key range
  let bIdx = 0;
  PC_BLACK.forEach((pck, i) => {
    // i-th position matches white key i in range
    if(!pck) return;
    const wk = whiteLayout[startWhitePos + i];
    if(!wk) return;
    // find black key whose prev white is this white
    const bk = layout.find(k=>k.isBlack && k.midi===wk.midi+1 || k.midi===wk.midi+2);
    // More precise: find black key just after this white key
    const bkExact = layout.find(k=> k.isBlack && k.midi > wk.midi && 
      !layout.find(w=>!w.isBlack && w.midi > wk.midi && w.midi < k.midi));
    if(bkExact){
      pcKeyToMidi.set(pck, bkExact.midi);
      const lbl = document.getElementById(\`kpc_${bkExact.midi}\`);
      if(lbl) lbl.textContent = pck.toUpperCase();
    }
  });

  // Auto-scroll to A5
  setTimeout(()=>{
    const anchorEl = keyEls.get(ANCHOR_MIDI);
    if(anchorEl){
      const scrollContainer = document.querySelector(".kbd-scroll");
      const keyLeft = parseInt(anchorEl.style.left||"0");
      const containerW = scrollContainer.clientWidth;
      scrollContainer.scrollLeft = Math.max(0, keyLeft - containerW/2 + 20);
    }
  }, 100);
}

function bindKeyEl(div, midi, freq){
  div.addEventListener("mousedown", e=>{ e.preventDefault(); noteOn(midi,freq); });
  div.addEventListener("mouseenter", e=>{ if(e.buttons===1) noteOn(midi,freq); });
  div.addEventListener("mouseup", ()=>{ if(!state.hold) noteOff(midi); });
  div.addEventListener("mouseleave", ()=>{ if(!state.hold) noteOff(midi); });
  div.addEventListener("touchstart", e=>{ e.preventDefault(); noteOn(midi,freq); },{passive:false});
  div.addEventListener("touchend", ()=>{ if(!state.hold) noteOff(midi); });
  div.addEventListener("touchcancel", ()=>{ if(!state.hold) noteOff(midi); });
}

function noteOn(midi, freq){
  ensureAudio();
  polyNoteOn(midi, freq);
}
function noteOff(midi){
  if(!state.hold) polyNoteOff(midi);
}

function markKey(midi, on){
  const el = keyEls.get(midi);
  if(el) el.classList.toggle("pressed", on);
}

// ============================================================
// PC KEYBOARD
// ============================================================
const pressedPC = new Set();
document.addEventListener("keydown", e=>{
  if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT") return;
  if(e.repeat) return;
  const k = e.key.toLowerCase();
  if(pressedPC.has(k)) return;
  pressedPC.add(k);
  const midi = pcKeyToMidi.get(k);
  if(midi!==undefined){
    const freq = midiToFreq(midi);
    noteOn(midi, freq);
  }
  // Hold toggle = H key (when not in input)
  if(k==="h" && !pcKeyToMidi.has("h")) toggleHold();
});
document.addEventListener("keyup", e=>{
  const k = e.key.toLowerCase();
  pressedPC.delete(k);
  const midi = pcKeyToMidi.get(k);
  if(midi!==undefined && !state.hold) noteOff(midi);
});

// ============================================================
// HOLD
// ============================================================
function toggleHold(forceTo){
  state.hold = (forceTo!==undefined) ? forceTo : !state.hold;
  const label = state.hold ? "üîí HOLD: ON" : "üîí HOLD: OFF";
  btnHold.textContent=label; btnHold2.textContent=label;
  [btnHold, btnHold2].forEach(b=>{
    b.classList.toggle("hold-active", state.hold);
    b.classList.toggle("warn", !state.hold);
  });
  if(!state.hold) allNotesOff();
}
btnHold.addEventListener("click",()=>toggleHold());
btnHold2.addEventListener("click",()=>toggleHold());
btnAllOff.addEventListener("click",()=>allNotesOff());
btnAllOff2.addEventListener("click",()=>allNotesOff());

// ============================================================
// ACTIVE NOTES DISPLAY
// ============================================================
function updateActiveNotesUI(){
  // Remove old chips
  const chips = activeNotesEl.querySelectorAll(".note-chip");
  chips.forEach(c=>c.remove());
  noNotesEl.style.display = polyVoices.size===0 ? "" : "none";

  polyVoices.forEach((v,midi)=>{
    const chip = document.createElement("span");
    chip.className = "note-chip";
    chip.innerHTML = \`${freqToNoteName(midi)} <span class="nhz">${Math.round(v.freq)}Hz</span>\`;
    activeNotesEl.appendChild(chip);
  });
}

function updatePolyCount(){
  polyCountEl.textContent = polyVoices.size;
}

// ============================================================
// MIX INFO
// ============================================================
function updateMixInfo(){
  const anySolo = fixedVoices.some(v=>v.params.solo);
  let sum=0, active=0;
  fixedVoices.forEach(v=>{
    const pass=(!anySolo||v.params.solo)&&v.params.on&&!v.params.mute;
    if(pass){sum+=v.params.level;active++;}
  });
  const polySum = polyVoices.size * (+kbdLevel.value);
  const total = sum + polySum;
  mixInfoEl.textContent = \`fixed ${active}/8 ¬∑ poly ${polyVoices.size} ¬∑ peak‚âà${total.toFixed(2)}\`;
  vuFill.style.width = \`${Math.min(100, total*55)}%\`;
}

// ============================================================
// FIXED VOICE ENVELOPE
// ============================================================
function fixedNow(){ return ac ? ac.currentTime : 0; }

function applyFixedVoice(v){
  v.osc.type = v.params.waveform;
  v.osc.frequency.setValueAtTime(v.params.freq, fixedNow());
  v.osc.detune.setValueAtTime(v.params.detune+state.globalDetune, fixedNow());
  v.panner.pan.setValueAtTime(v.params.pan, fixedNow());
}

function fixedVoiceTarget(v){
  const anySolo = fixedVoices.some(x=>x.params.solo);
  if(anySolo&&!v.params.solo) return 0;
  if(!v.params.on||v.params.mute) return 0;
  return v.params.level;
}

function fixedEnvOn(v){
  const t=fixedNow(), {a,d,s}=state.adsr;
  const tgt=fixedVoiceTarget(v);
  v.gain.gain.cancelScheduledValues(t);
  v.gain.gain.setValueAtTime(v.gain.gain.value,t);
  v.gain.gain.linearRampToValueAtTime(tgt,t+a);
  v.gain.gain.linearRampToValueAtTime(tgt*s,t+a+d);
}
function fixedEnvOff(v){
  const t=fixedNow(), r=state.adsr.r;
  v.gain.gain.cancelScheduledValues(t);
  v.gain.gain.setValueAtTime(v.gain.gain.value,t);
  v.gain.gain.linearRampToValueAtTime(0,t+r);
}
function refreshFixed(){
  if(!ac) return;
  fixedVoices.forEach(v=>{
    applyFixedVoice(v);
    const tgt=fixedVoiceTarget(v);
    const t=fixedNow();
    v.gain.gain.cancelScheduledValues(t);
    v.gain.gain.setValueAtTime(v.gain.gain.value,t);
    v.gain.gain.linearRampToValueAtTime(tgt*state.adsr.s,t+0.03);
  });
  updateMixInfo();
}

// ============================================================
// FIXED VOICE UI
// ============================================================
function noteNameForVoice(v){ return freqToNoteName(Math.round(69+12*Math.log2(v.params.freq/440))); }

function syncFixedUI(v){
  const onBtn=$(\`vOn_${v.idx}\`), muteBtn=$(\`vMute_${v.idx}\`), soloBtn=$(\`vSolo_${v.idx}\`);
  const info=$(\`vInfo_${v.idx}\`), card=$(\`vCard_${v.idx}\`);
  if(onBtn){onBtn.classList.toggle("on",v.params.on);onBtn.textContent=v.params.on?"ON":"OFF";}
  if(muteBtn) muteBtn.classList.toggle("on",v.params.mute);
  if(soloBtn) soloBtn.classList.toggle("on",v.params.solo);
  if(card) card.classList.toggle("kbd-active",v.params.on&&!v.params.mute);
  const nn = noteNameForVoice(v);
  if(info) info.innerHTML = \`${Math.round(v.params.freq)} Hz <span class="ntag">${nn}</span> ¬∑ gain ${v.params.level.toFixed(2)} ¬∑ pan ${v.params.pan.toFixed(2)}\`;
  ['WaveLbl','FreqLbl','LvlLbl','DetLbl','PanLbl'].forEach(id=>{
    const el_=$(\`v${id}_${v.idx}\`);
    if(!el_) return;
    if(id==='WaveLbl') el_.textContent=v.params.waveform;
    if(id==='FreqLbl') el_.textContent=\`${Math.round(v.params.freq)} Hz\`;
    if(id==='LvlLbl') el_.textContent=v.params.level.toFixed(2);
    if(id==='DetLbl') el_.textContent=\`${v.params.detune|0} ¬¢\`;
    if(id==='PanLbl') el_.textContent=v.params.pan.toFixed(2);
  });
  const fr=$(\`vFreqR_${v.idx}\`); if(fr) fr.value=String(Math.min(2000,Math.max(20,v.params.freq)));
  const fn=$(\`vFreqN_${v.idx}\`); if(fn) fn.value=String(Math.round(v.params.freq));
  const ws=$(\`vWave_${v.idx}\`); if(ws) ws.value=v.params.waveform;
  const lr=$(\`vLvl_${v.idx}\`); if(lr) lr.value=String(v.params.level);
}

function buildFixedVoiceUI(){
  voicesRoot.innerHTML="";
  const colors=['#4ea1ff','#6af0c2','#c07aff','#ffcc66','#ff5c7a','#4bf08a','#ff9f43','#54a0ff'];
  fixedVoices.forEach(v=>{
    const c=colors[(v.idx-1)%colors.length];
    const card=document.createElement("div");
    card.className="card voice";
    card.id=\`vCard_${v.idx}\`;
    card.innerHTML=\`
      <div class="vhead">
        <div class="vleft">
          <div class="badge" style="color:${c};border-color:${c}30;">${v.idx}</div>
          <div>
            <div class="vname">Voice ${v.idx}</div>
            <div class="vinfo mono" id="vInfo_${v.idx}">440 Hz <span class="ntag">A4</span> ¬∑ gain 0.20 ¬∑ pan 0</div>
          </div>
        </div>
        <div class="toggles">
          <button class="chip" id="vOn_${v.idx}">OFF</button>
          <button class="chip mute" id="vMute_${v.idx}">MUTE</button>
          <button class="chip solo" id="vSolo_${v.idx}">SOLO</button>
        </div>
      </div>
      <div class="g3" style="margin-bottom:8px;">
        <div class="kv">
          <label><span>Waveform</span><b id="vWaveLbl_${v.idx}">sine</b></label>
          <select id="vWave_${v.idx}">
            <option value="sine">Sine „Äú</option>
            <option value="triangle">Triangle ‚ñ≥</option>
            <option value="sawtooth">Sawtooth /|</option>
            <option value="square">Square ‚ñ≠</option>
          </select>
        </div>
        <div class="kv" style="grid-column:span 2;">
          <label><span>Frequenza</span><b id="vFreqLbl_${v.idx}">440 Hz</b></label>
          <input id="vFreqR_${v.idx}" type="range" min="20" max="2000" step="0.5" value="440">
          <div style="display:flex;gap:8px;margin-top:6px;">
            <input id="vFreqN_${v.idx}" type="number" min="1" max="20000" step="0.5" value="440" style="flex:1;">
            <select id="vNotePreset_${v.idx}" style="flex:1.3;padding:7px 6px;border-radius:10px;border:var(--line);background:rgba(0,0,0,.3);color:var(--txt);font-size:10.5px;outline:none;">
              <option value="">‚Äî Nota ‚Äî</option>
              ${genNoteOpts()}
            </select>
          </div>
        </div>
      </div>
      <div class="g3" style="margin-bottom:8px;">
        <div class="kv">
          <label><span>Livello</span><b id="vLvlLbl_${v.idx}">0.20</b></label>
          <input id="vLvl_${v.idx}" type="range" min="0" max="1" step="0.001" value="0.20">
        </div>
        <div class="kv">
          <label><span>Detune (¬¢)</span><b id="vDetLbl_${v.idx}">0 ¬¢</b></label>
          <input id="vDet_${v.idx}" type="range" min="-1200" max="1200" step="1" value="0">
        </div>
        <div class="kv">
          <label><span>Pan</span><b id="vPanLbl_${v.idx}">0</b></label>
          <input id="vPan_${v.idx}" type="range" min="-1" max="1" step="0.001" value="0">
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn ok" id="vTrig_${v.idx}" style="flex:1;padding:8px;font-size:12px;">üîä Trigger</button>
        <button class="btn danger" id="vOff_${v.idx}" style="flex:1;padding:8px;font-size:12px;">üîá Off</button>
      </div>
    \`;
    voicesRoot.appendChild(card);

    // Bind events
    $(\`vOn_${v.idx}\`).addEventListener("click",()=>{
      v.params.on=!v.params.on; syncFixedUI(v);
      if(ac){applyFixedVoice(v); if(v.params.on) fixedEnvOn(v); else fixedEnvOff(v); refreshFixed();}
    });
    $(\`vMute_${v.idx}\`).addEventListener("click",()=>{v.params.mute=!v.params.mute;syncFixedUI(v);refreshFixed();});
    $(\`vSolo_${v.idx}\`).addEventListener("click",()=>{v.params.solo=!v.params.solo;syncFixedUI(v);refreshFixed();});
    $(\`vWave_${v.idx}\`).addEventListener("change",()=>{v.params.waveform=$(\`vWave_${v.idx}\`).value;syncFixedUI(v);if(ac)applyFixedVoice(v);});

    function setFreq(val){
      v.params.freq=Math.max(1,Math.min(20000,Number(val)||440));
      syncFixedUI(v);
      if(ac) v.osc.frequency.setValueAtTime(v.params.freq,fixedNow());
    }
    $(\`vFreqR_${v.idx}\`).addEventListener("input",e=>setFreq(e.target.value));
    $(\`vFreqN_${v.idx}\`).addEventListener("input",e=>setFreq(e.target.value));
    $(\`vFreqN_${v.idx}\`).addEventListener("change",e=>setFreq(e.target.value));
    $(\`vNotePreset_${v.idx}\`).addEventListener("change",e=>{if(e.target.value){setFreq(e.target.value);e.target.value="";}});
    $(\`vLvl_${v.idx}\`).addEventListener("input",e=>{v.params.level=+e.target.value;syncFixedUI(v);refreshFixed();});
    $(\`vDet_${v.idx}\`).addEventListener("input",e=>{v.params.detune=+e.target.value;syncFixedUI(v);if(ac)v.osc.detune.setValueAtTime(v.params.detune+state.globalDetune,fixedNow());});
    $(\`vPan_${v.idx}\`).addEventListener("input",e=>{v.params.pan=+e.target.value;syncFixedUI(v);if(ac)v.panner.pan.setValueAtTime(v.params.pan,fixedNow());});
    $(\`vTrig_${v.idx}\`).addEventListener("click",()=>{v.params.on=true;syncFixedUI(v);if(!ac)return;applyFixedVoice(v);fixedEnvOn(v);refreshFixed();});
    $(\`vOff_${v.idx}\`).addEventListener("click",()=>{v.params.on=false;syncFixedUI(v);if(!ac)return;fixedEnvOff(v);refreshFixed();});

    syncFixedUI(v);
  });
}

function genNoteOpts(){
  let s="";
  for(let oct=2;oct<=8;oct++){
    for(let n=0;n<12;n++){
      const midi=(oct+1)*12+n;
      const freq=midiToFreq(midi);
      const name=NOTE_NAMES[n]+oct;
      s+=\`<option value="${freq.toFixed(3)}">${name} ‚Äî ${Math.round(freq)} Hz</option>\`;
    }
  }
  return s;
}

// ============================================================
// GLOBAL CONTROLS
// ============================================================
function setLabels(){
  aValEl.textContent=\`${(+atkEl.value).toFixed(3)} s\`;
  dValEl.textContent=\`${(+decEl.value).toFixed(3)} s\`;
  sValEl.textContent=(+susEl.value).toFixed(3);
  rValEl.textContent=\`${(+relEl.value).toFixed(3)} s\`;
  limValEl.textContent=\`${+limiterEl.value} dB\`;
  masterValEl.textContent=(+masterEl.value).toFixed(3);
  gDetValEl.textContent=\`${(+gDetEl.value)|0} ¬¢\`;
}

atkEl.addEventListener("input",()=>{state.adsr.a=+atkEl.value;setLabels();refreshFixed();});
decEl.addEventListener("input",()=>{state.adsr.d=+decEl.value;setLabels();refreshFixed();});
susEl.addEventListener("input",()=>{state.adsr.s=+susEl.value;setLabels();refreshFixed();});
relEl.addEventListener("input",()=>{state.adsr.r=+relEl.value;setLabels();});
masterEl.addEventListener("input",()=>{setLabels();if(masterGain)masterGain.gain.setValueAtTime(+masterEl.value,ac.currentTime);});
limiterEl.addEventListener("input",()=>{setLabels();if(compressor)compressor.threshold.setValueAtTime(+limiterEl.value,ac.currentTime);});
gDetEl.addEventListener("input",()=>{
  state.globalDetune=+gDetEl.value;setLabels();
  if(ac){
    fixedVoices.forEach(v=>v.osc.detune.setValueAtTime(v.params.detune+state.globalDetune,ac.currentTime));
    polyVoices.forEach(v=>v.osc.detune.setValueAtTime(state.globalDetune,ac.currentTime));
  }
});
kbdLevel.addEventListener("input",()=>{kbdLvlVal.textContent=(+kbdLevel.value).toFixed(2);updateMixInfo();});

// ============================================================
// TRANSPORT
// ============================================================
btnStart.addEventListener("click",async()=>{
  ensureAudio();
  if(ac.state==="suspended") await ac.resume();
  state.running=true;
  statusEl.textContent="RUN"; sdot.className="dot green";
  btnStart.disabled=true; btnStop.disabled=false;
  startScope();
});
btnStop.addEventListener("click",async()=>{
  if(!ac) return;
  allNotesOff();
  const t=ac.currentTime;
  masterGain.gain.cancelScheduledValues(t);
  masterGain.gain.setValueAtTime(masterGain.gain.value,t);
  masterGain.gain.linearRampToValueAtTime(0,t+0.06);
  fixedVoices.forEach(v=>fixedEnvOff(v));
  setTimeout(async()=>{
    try{await ac.suspend();}catch(e){}
    masterGain.gain.setValueAtTime(+masterEl.value,ac.currentTime);
    state.running=false; statusEl.textContent="STOP"; sdot.className="dot red";
    btnStart.disabled=false; btnStop.disabled=true;
  },80);
});
btnPanic.addEventListener("click",()=>{
  if(!ac) return;
  allNotesOff();
  const t=ac.currentTime;
  fixedVoices.forEach(v=>{
    v.params.on=false;v.params.mute=false;v.params.solo=false;
    v.gain.gain.cancelScheduledValues(t);
    v.gain.gain.setValueAtTime(0,t);
    syncFixedUI(v);
  });
  masterGain.gain.cancelScheduledValues(t);
  masterGain.gain.linearRampToValueAtTime(0,t+0.01);
  masterGain.gain.linearRampToValueAtTime(+masterEl.value,t+0.09);
  updateMixInfo();
});

// ============================================================
// PRESETS
// ============================================================
presetChord.addEventListener("click",()=>{
  ensureAudio();
  // C major chord spread over octaves
  const presets=[
    {f:261.63,w:"sawtooth",l:.18,d:-6,p:-.4},
    {f:329.63,w:"sawtooth",l:.16,d: 6,p:-.2},
    {f:392.00,w:"triangle",l:.16,d:-5,p: .2},
    {f:523.25,w:"sawtooth",l:.13,d: 5,p: .4},
    {f:659.25,w:"triangle",l:.10,d:-4,p:-.3},
    {f:783.99,w:"triangle",l:.09,d: 4,p: .3},
    {f:220.00,w:"sine",    l:.14,d: 0,p: 0 },
    {f:440.00,w:"sine",    l:.10,d: 0,p: 0 },
  ];
  fixedVoices.forEach((v,i)=>{
    const p=presets[i];
    v.params.waveform=p.w; v.params.freq=p.f; v.params.level=p.l;
    v.params.detune=p.d; v.params.pan=p.p; v.params.on=i<6;
    v.params.mute=false; v.params.solo=false;
    syncFixedUI(v); applyFixedVoice(v);
    if(v.params.on) fixedEnvOn(v); else fixedEnvOff(v);
  });
  refreshFixed();
});
presetHarm.addEventListener("click",()=>{
  ensureAudio();
  const base=110;
  fixedVoices.forEach((v,i)=>{
    const n=i+1;
    v.params.waveform=n<=2?"sine":n<=5?"triangle":"square";
    v.params.freq=base*n; v.params.level=0.22/n;
    v.params.detune=0; v.params.pan=(i%2===0)?-.25:.25;
    v.params.on=true; v.params.mute=false; v.params.solo=false;
    syncFixedUI(v); applyFixedVoice(v); fixedEnvOn(v);
  });
  refreshFixed();
});

// ============================================================
// OSCILLOSCOPE
// ============================================================
let raf=0, lastFpsT=0, frames=0;

function drawScope(){
  raf=requestAnimationFrame(drawScope);
  if(!analyser) return;
  const w=scopeCanvas.width, h=scopeCanvas.height;
  const data=new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(data);

  ctx.fillStyle="rgba(7,8,13,.86)";
  ctx.fillRect(0,0,w,h);

  // grid
  ctx.strokeStyle="rgba(255,255,255,.05)";
  ctx.lineWidth=1;
  ctx.beginPath();
  for(let i=1;i<7;i++){const y=h*i/7;ctx.moveTo(0,y);ctx.lineTo(w,y);}
  for(let i=1;i<13;i++){const x=w*i/13;ctx.moveTo(x,0);ctx.lineTo(x,h);}
  ctx.stroke();

  // center
  ctx.strokeStyle="rgba(78,161,255,.12)";
  ctx.beginPath();ctx.moveTo(0,h/2);ctx.lineTo(w,h/2);ctx.stroke();

  // glow
  ctx.strokeStyle="rgba(106,240,194,.15)";
  ctx.lineWidth=7;
  drawWave(data,w,h);

  ctx.strokeStyle="rgba(78,161,255,.9)";
  ctx.lineWidth=1.8;
  drawWave(data,w,h);

  // RMS
  let rms=0;
  for(let i=0;i<data.length;i++){const s=(data[i]-128)/128;rms+=s*s;}
  rms=Math.sqrt(rms/data.length);
  rmsValEl.textContent=rms.toFixed(3);

  frames++;
  const t=performance.now();
  if(t-lastFpsT>700){
    fpsEl.textContent=(frames*1000/(t-lastFpsT)).toFixed(0);
    lastFpsT=t;frames=0;
  }
}
function drawWave(data,w,h){
  ctx.beginPath();
  for(let i=0;i<data.length;i++){
    const x=(i/(data.length-1))*w;
    const y=h/2+((data[i]-128)/128)*(h*.40);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  }
  ctx.stroke();
}
function startScope(){
  if(raf) cancelAnimationFrame(raf);
  lastFpsT=performance.now();frames=0;
  drawScope();
}

// ============================================================
// INIT
// ============================================================
setLabels();
kbdLvlVal.textContent=(+kbdLevel.value).toFixed(2);

// Placeholder voices
(function placeholder(){
  voicesRoot.innerHTML="";
  for(let i=1;i<=MAX_FIXED;i++){
    const d=document.createElement("div");
    d.className="card voice"; d.id=\`vCard_${i}\`;
    const colors=['#4ea1ff','#6af0c2','#c07aff','#ffcc66','#ff5c7a','#4bf08a','#ff9f43','#54a0ff'];
    d.innerHTML=\`
      <div class="vhead">
        <div class="vleft">
          <div class="badge" style="color:${colors[(i-1)%8]};border-color:${colors[(i-1)%8]}30;">${i}</div>
          <div>
            <div class="vname">Voice ${i}</div>
            <div class="vinfo small">Premi ‚ñ∂ Start per attivare l'audio.</div>
          </div>
        </div>
        <div class="toggles"><span class="pill">‚Äî</span></div>
      </div>
    \`;
    voicesRoot.appendChild(d);
  }
})();

// Build keyboard (senza audio, solo visuale)
buildKeyboard();

})();
<\/script>
</body>
</html>`,
  SEQ: `<!DOCTYPE html>
<html lang="it">
<head>
<script>
/* MaxiHost bootstrap for section SEQ */
(function(){
  const SECTION_ID = 'SEQ';
  // ---- Shared audio routing via parent ----
  function getProxy(){
    const host = window.parent && window.parent.MaracaHost;
    if (!host) return null;
    return host.getAudioProxy(SECTION_ID);
  }
  const proxy = getProxy();
  if (proxy) {
    // Replace constructors used by apps
    window.AudioContext = function(){ return proxy; };
    window.webkitAudioContext = function(){ return proxy; };
  }

  // ---- Mic gating (single-owner) ----
  const md = navigator.mediaDevices;
  if (md && md.getUserMedia) {
    const orig = md.getUserMedia.bind(md);
    md.getUserMedia = function(constraints){
      const host = window.parent && window.parent.MaracaHost;
      if (!host) return orig(constraints);
      return host.requestMic(SECTION_ID, constraints);
    };
  }

  // ---- Resume helper (some apps call ctx.resume on user gesture) ----
  window.addEventListener('pointerdown', () => {
    try {
      const host = window.parent && window.parent.MaracaHost;
      if (host) host.resumeAudio();
    } catch(e){}
  }, {passive:true});
})();
<\/script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaracaPad ‚Ä¢ Drum Machine ‚Ä¢ 16x16 Sequencer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Inter',sans-serif;
            background:#0A0A0C;
            background-image:radial-gradient(circle at 20% 20%,rgba(0,255,200,0.04) 0%,transparent 40%),
                             radial-gradient(circle at 80% 80%,rgba(255,0,200,0.04) 0%,transparent 40%);
            min-height:100vh; color:#fff;
        }
        .studio-panel {
            background:rgba(10,10,15,0.97);
            backdrop-filter:blur(20px);
            border:1px solid rgba(0,255,136,0.15);
            border-radius:28px;
            box-shadow:0 30px 60px -20px #000;
        }
        /* Step Cells */
        .step-cell {
            aspect-ratio:1; background:#1a1a24; border:1.5px solid #2f2f3a;
            border-radius:5px; cursor:pointer; transition:all 0.08s ease;
            display:flex; align-items:center; justify-content:center;
            font-size:8px; font-weight:700; color:#444;
        }
        .step-cell:hover { border-color:#00ff88; background:#22222e; }
        .step-cell.active { background:#00ff88; border-color:#aaffcc; color:#000; box-shadow:0 0 14px #00ff8880; }
        .step-cell.playing { background:#ffaa00 !important; border-color:#fff !important; color:#000 !important; box-shadow:0 0 20px #ffaa0099 !important; transform:scale(1.1); z-index:5; }
        /* Beat lights */
        .beat-light {
            min-width:28px; height:28px; border-radius:8px; background:#14141c;
            border:1.5px solid #2d2d38; display:flex; align-items:center;
            justify-content:center; font-size:10px; font-weight:700; color:#444;
            transition:all 0.06s ease;
        }
        .beat-light.on { background:#00ff88; border-color:#fff; color:#000; box-shadow:0 0 20px #00ff8888; transform:scale(1.05); }
        /* Track row */
        .track-row {
            display:flex; align-items:center; gap:6px; padding:5px 8px;
            border-radius:12px; border:1px solid #1e1e28; transition:all 0.15s;
        }
        .track-row:hover { border-color:#333344; background:rgba(255,255,255,0.01); }
        .track-row.playing-row { border-color:#00ff8840; }
        /* Color bars per tipo */
        .t-drum  { border-left:3px solid #ff3366; }
        .t-synth { border-left:3px solid #00ccff; }
        .t-bass  { border-left:3px solid #ffaa00; }
        .t-ambient { border-left:3px solid #aa88ff; }
        .t-guitar { border-left:3px solid #00ffaa; }
        /* Mute btn */
        .mute-btn { font-size:9px; padding:3px 7px; border-radius:6px; border:1px solid #333; background:#1a1a24; color:#888; cursor:pointer; transition:all 0.1s; }
        .mute-btn.muted { background:#ff3366; color:#fff; border-color:#ff3366; }
        .solo-btn { font-size:9px; padding:3px 7px; border-radius:6px; border:1px solid #333; background:#1a1a24; color:#888; cursor:pointer; transition:all 0.1s; }
        .solo-btn.soloed { background:#ffaa00; color:#000; border-color:#ffaa00; }
        /* Division btns */
        .div-btn { padding:5px 12px; font-size:10px; font-weight:700; border-radius:20px; background:transparent; color:#666; border:none; cursor:pointer; transition:all 0.1s; }
        .div-btn.active { background:#00ff88; color:#000; }
        /* Scrollbar */
        ::-webkit-scrollbar { width:4px; height:4px; }
        ::-webkit-scrollbar-track { background:#0a0a0c; }
        ::-webkit-scrollbar-thumb { background:#333; border-radius:4px; }
        /* Transport buttons */
        .transport-btn {
            padding:12px 24px; border-radius:999px; font-weight:700; font-size:13px;
            border:1px solid #2f2f3a; background:#1a1a24; color:#aaa; cursor:pointer;
            transition:all 0.15s;
        }
        .transport-btn:hover { border-color:#00ff88; color:#fff; }
        .transport-btn.play-active { background:#00ff88; color:#000; border-color:#00ff88; }
        /* VU meter bar */
        .vu-bar { width:100%; height:3px; background:#1a1a24; border-radius:2px; overflow:hidden; margin-top:2px; }
        .vu-fill { height:100%; background:linear-gradient(90deg,#00ff88,#ffaa00); width:0%; transition:width 0.05s; border-radius:2px; }
        /* Tooltip note */
        .note-select { background:#111118; border:1px solid #2f2f3a; color:#00ff88; font-size:10px; padding:2px 4px; border-radius:6px; cursor:pointer; }
        .note-select:focus { outline:none; border-color:#00ff88; }
    </style>
</head>
<body class="p-4">

<div class="max-w-[1900px] mx-auto studio-panel p-6">

    <!-- HEADER -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-4xl font-black tracking-tight">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">MARACA</span>
                <span class="text-white">PAD</span>
                <span class="ml-2 text-xs px-2 py-1 bg-emerald-500/20 rounded-full text-emerald-400 align-middle">v2 ‚Ä¢ 16 TRACCE</span>
            </h1>
            <p class="text-zinc-600 text-xs mt-1">DRUM MACHINE + SYNTH SEQUENCER ‚Ä¢ WEB AUDIO API</p>
        </div>

        <!-- TRANSPORT -->
        <div class="flex items-center gap-3">
            <div class="text-center">
                <div class="text-xs text-zinc-600 mb-1">BPM</div>
                <div class="flex items-center gap-2">
                    <button onclick="changeBPM(-5)" class="text-zinc-400 hover:text-white w-6 h-6 bg-zinc-800 rounded-full text-sm">‚àí</button>
                    <input type="range" id="bpm-slider" min="40" max="240" value="120" class="w-28 accent-emerald-400" oninput="updateBPM()">
                    <span id="bpm-display" class="text-xl font-bold text-emerald-400 w-10">120</span>
                    <button onclick="changeBPM(5)" class="text-zinc-400 hover:text-white w-6 h-6 bg-zinc-800 rounded-full text-sm">+</button>
                </div>
            </div>
            <button id="play-btn" onclick="togglePlay()" class="transport-btn">‚ñ∂ START</button>
            <button onclick="stopAll()" class="transport-btn">‚óº STOP</button>
            <button onclick="randomPattern()" class="transport-btn text-sm">üé≤</button>
            <button onclick="clearAll()" class="transport-btn text-sm">üóëÔ∏è</button>
        </div>
    </div>

    <!-- DIVISION CONTROLS -->
    <div class="flex items-center gap-6 mb-5">
        <div>
            <div class="text-xs text-zinc-600 mb-1">STEPS PER TRACCIA</div>
            <div class="flex gap-1 bg-black/40 rounded-full p-1 border border-zinc-800">
                <button class="div-btn" id="div4" onclick="setSteps(4)">4</button>
                <button class="div-btn" id="div8" onclick="setSteps(8)">8</button>
                <button class="div-btn active" id="div16" onclick="setSteps(16)">16</button>
                <button class="div-btn" id="div32" onclick="setSteps(32)">32</button>
            </div>
        </div>
        <div>
            <div class="text-xs text-zinc-600 mb-1">SCALA NOTE SINTETIZZATORI</div>
            <select id="scale-select" class="note-select" onchange="applyScale()">
                <option value="major">Maggiore (Do)</option>
                <option value="minor">Minore (La)</option>
                <option value="pentatonic">Pentatonica</option>
                <option value="blues">Blues</option>
                <option value="chromatic">Cromatica</option>
            </select>
        </div>
        <div>
            <div class="text-xs text-zinc-600 mb-1">TONALIT√Ä</div>
            <select id="root-select" class="note-select" onchange="applyScale()">
                <option value="C">Do (C)</option>
                <option value="D">Re (D)</option>
                <option value="E">Mi (E)</option>
                <option value="F">Fa (F)</option>
                <option value="G">Sol (G)</option>
                <option value="A">La (A)</option>
                <option value="B">Si (B)</option>
            </select>
        </div>
        <div class="ml-auto flex items-center gap-3">
            <div class="text-xs text-zinc-600">MASTER VOL</div>
            <input type="range" min="0" max="100" value="80" class="w-24 accent-emerald-400" oninput="setMasterVol(this.value)">
        </div>
    </div>

    <!-- BEAT LIGHTS -->
    <div id="beat-lights" class="flex gap-1 mb-5 overflow-x-auto pb-1"></div>

    <!-- SEQUENCER TRACKS -->
    <div id="tracks-container" class="space-y-1.5"></div>

</div>

<script>
// ========== AUDIO ENGINE ==========
let audioCtx = null;
let masterGain;

function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.8;
    masterGain.connect(audioCtx.destination);
}

function resumeAudio() {
    if (!audioCtx) initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

// ========== SUONI REALISTICI ==========
function playKick() {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(masterGain);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(180, t);
    osc.frequency.exponentialRampToValueAtTime(40, t + 0.12);
    gain.gain.setValueAtTime(0.9, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.35);
    osc.start(t); osc.stop(t + 0.35);
}

function playSnare(vol=0.7) {
    resumeAudio();
    const t = audioCtx.currentTime;
    // Noise
    const bufSize = audioCtx.sampleRate * 0.15;
    const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<bufSize;i++) data[i] = (Math.random()*2-1);
    const noise = audioCtx.createBufferSource();
    noise.buffer = buf;
    const noiseGain = audioCtx.createGain();
    const hpf = audioCtx.createBiquadFilter();
    hpf.type = 'bandpass'; hpf.frequency.value = 2500; hpf.Q.value = 0.8;
    noise.connect(hpf); hpf.connect(noiseGain); noiseGain.connect(masterGain);
    noiseGain.gain.setValueAtTime(vol, t);
    noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
    noise.start(t); noise.stop(t + 0.18);
    // Body tone
    const osc = audioCtx.createOscillator();
    const oscGain = audioCtx.createGain();
    osc.connect(oscGain); oscGain.connect(masterGain);
    osc.type = 'triangle'; osc.frequency.value = 220;
    oscGain.gain.setValueAtTime(vol * 0.5, t);
    oscGain.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
    osc.start(t); osc.stop(t + 0.08);
}

function playHihat(open=false, vol=0.5) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const dur = open ? 0.35 : 0.06;
    const bufSize = Math.floor(audioCtx.sampleRate * dur);
    const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<bufSize;i++) data[i] = (Math.random()*2-1);
    const noise = audioCtx.createBufferSource();
    noise.buffer = buf;
    const hpf = audioCtx.createBiquadFilter();
    hpf.type = 'highpass'; hpf.frequency.value = 7000;
    const gain = audioCtx.createGain();
    noise.connect(hpf); hpf.connect(gain); gain.connect(masterGain);
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + dur);
    noise.start(t); noise.stop(t + dur);
}

function playClap(vol=0.6) {
    resumeAudio();
    const t = audioCtx.currentTime;
    [0, 0.01, 0.02].forEach(offset => {
        const bufSize = audioCtx.sampleRate * 0.12;
        const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
        const d = buf.getChannelData(0);
        for (let i=0;i<bufSize;i++) d[i] = (Math.random()*2-1);
        const noise = audioCtx.createBufferSource();
        noise.buffer = buf;
        const bpf = audioCtx.createBiquadFilter();
        bpf.type = 'bandpass'; bpf.frequency.value = 1200; bpf.Q.value = 0.8;
        const gain = audioCtx.createGain();
        noise.connect(bpf); bpf.connect(gain); gain.connect(masterGain);
        gain.gain.setValueAtTime(vol * 0.7, t + offset);
        gain.gain.exponentialRampToValueAtTime(0.001, t + offset + 0.14);
        noise.start(t + offset); noise.stop(t + offset + 0.14);
    });
}

function playTom(freq=120, vol=0.7) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(masterGain);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq * 1.5, t);
    osc.frequency.exponentialRampToValueAtTime(freq, t + 0.08);
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.35);
    osc.start(t); osc.stop(t + 0.35);
}

function playRim(vol=0.6) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const bpf = audioCtx.createBiquadFilter();
    bpf.type = 'bandpass'; bpf.frequency.value = 3000; bpf.Q.value = 3;
    osc.connect(bpf); bpf.connect(gain); gain.connect(masterGain);
    osc.type = 'triangle'; osc.frequency.value = 450;
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
    osc.start(t); osc.stop(t + 0.05);
}

function playPerc(freq=250, vol=0.55) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(masterGain);
    osc.type = 'square'; osc.frequency.setValueAtTime(freq, t);
    osc.frequency.exponentialRampToValueAtTime(freq * 0.5, t + 0.05);
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
    osc.start(t); osc.stop(t + 0.12);
}

function playShaker(vol=0.4) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const bufSize = audioCtx.sampleRate * 0.04;
    const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i=0;i<bufSize;i++) d[i] = (Math.random()*2-1);
    const noise = audioCtx.createBufferSource();
    noise.buffer = buf;
    const hpf = audioCtx.createBiquadFilter();
    hpf.type = 'highpass'; hpf.frequency.value = 8000;
    const gain = audioCtx.createGain();
    noise.connect(hpf); hpf.connect(gain); gain.connect(masterGain);
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.04);
    noise.start(t); noise.stop(t + 0.04);
}

// Synth note con frequenza specificata
function playNote(freq, wave='sawtooth', attack=0.01, decay=0.3, vol=0.5, filterFreq=1500) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass'; filter.frequency.value = filterFreq; filter.Q.value = 2;
    osc.connect(filter); filter.connect(gain); gain.connect(masterGain);
    osc.type = wave;
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(vol, t + attack);
    gain.gain.exponentialRampToValueAtTime(0.001, t + attack + decay);
    osc.start(t); osc.stop(t + attack + decay + 0.05);
}

function playBass(freq, vol=0.8) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const osc2 = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass'; filter.frequency.value = 300; filter.Q.value = 1;
    osc.connect(filter); osc2.connect(filter); filter.connect(gain); gain.connect(masterGain);
    osc.type = 'sawtooth'; osc.frequency.value = freq;
    osc2.type = 'sine'; osc2.frequency.value = freq;
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(vol, t + 0.005);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.35);
    osc.start(t); osc.stop(t + 0.4);
    osc2.start(t); osc2.stop(t + 0.4);
}

function playAmbient(freq, vol=0.35) {
    resumeAudio();
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const osc2 = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    const reverb = audioCtx.createConvolver();
    filter.type = 'lowpass'; filter.frequency.value = 800; filter.Q.value = 0.5;
    osc.connect(filter); osc2.connect(filter); filter.connect(gain); gain.connect(masterGain);
    osc.type = 'triangle'; osc.frequency.value = freq;
    osc2.type = 'triangle'; osc2.frequency.value = freq * 1.001; // slight detune
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(vol, t + 0.2);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
    osc.start(t); osc.stop(t + 1.6);
    osc2.start(t); osc2.stop(t + 1.6);
}

function playGuitar(freq, vol=0.55) {
    // Karplus-Strong approximation
    resumeAudio();
    const t = audioCtx.currentTime;
    const bufSize = Math.floor(audioCtx.sampleRate / freq);
    const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i=0;i<bufSize;i++) d[i] = Math.random()*2-1;
    const noise = audioCtx.createBufferSource();
    noise.buffer = buf; noise.loop = true;
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass'; filter.frequency.value = 2000;
    noise.connect(filter); filter.connect(gain); gain.connect(masterGain);
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
    noise.start(t); noise.stop(t + 0.65);
}

// ========== SCALE ==========
const NOTES_FREQ = {
    C: 261.63, D: 293.66, E: 329.63, F: 349.23,
    G: 392.00, A: 440.00, B: 493.88
};
const SCALES = {
    major:      [0, 2, 4, 5, 7, 9, 11],
    minor:      [0, 2, 3, 5, 7, 8, 10],
    pentatonic: [0, 2, 4, 7, 9],
    blues:      [0, 3, 5, 6, 7, 10],
    chromatic:  [0,1,2,3,4,5,6,7,8,9,10,11]
};

function getScaleFreqs() {
    const rootName = document.getElementById('root-select').value;
    const scaleName = document.getElementById('scale-select').value;
    const rootFreq = NOTES_FREQ[rootName];
    const intervals = SCALES[scaleName];
    const freqs = [];
    [-1,0,1,2].forEach(oct => {
        intervals.forEach(semi => {
            freqs.push(rootFreq * Math.pow(2, oct + semi/12));
        });
    });
    return freqs.filter(f => f >= 50 && f <= 2000).sort((a,b)=>a-b);
}

// ========== STATE ==========
const NUM_TRACKS = 16;
let numSteps = 16;
let bpm = 120;
let isPlaying = false;
let currentStep = 0;
let intervalId = null;

// Ogni traccia: { name, type, color, muted, soloed, stepNotes[], active[] }
let tracks = [];
let beatLights = [];

// Funzione audio per ogni traccia
const TRACK_DEFS = [
    { name:'KICK',     type:'drum',   color:'#ff3366', fn: (freq,vol)=>playKick() },
    { name:'SNARE',    type:'drum',   color:'#ff3366', fn: (freq,vol)=>playSnare(vol) },
    { name:'HI-HAT',   type:'drum',   color:'#ff3366', fn: (freq,vol)=>playHihat(false,vol) },
    { name:'OPEN HAT', type:'drum',   color:'#ff5588', fn: (freq,vol)=>playHihat(true,vol) },
    { name:'CLAP',     type:'drum',   color:'#ff3366', fn: (freq,vol)=>playClap(vol) },
    { name:'TOM HI',   type:'drum',   color:'#ff5566', fn: (freq,vol)=>playTom(180,vol) },
    { name:'TOM LO',   type:'drum',   color:'#ff4455', fn: (freq,vol)=>playTom(90,vol) },
    { name:'SHAKER',   type:'drum',   color:'#ff6677', fn: (freq,vol)=>playShaker(vol) },
    { name:'BASS',     type:'bass',   color:'#ffaa00', fn: (freq,vol)=>playBass(freq,vol) },
    { name:'SUB BASS', type:'bass',   color:'#ff8800', fn: (freq,vol)=>playBass(freq*0.5,vol) },
    { name:'SYNTH LD', type:'synth',  color:'#00ccff', fn: (freq,vol)=>playNote(freq,'sawtooth',0.01,0.3,vol,2000) },
    { name:'SYNTH PAD',type:'synth',  color:'#0088ff', fn: (freq,vol)=>playNote(freq,'triangle',0.1,1.0,vol*0.7,600) },
    { name:'ARPEGGIO', type:'synth',  color:'#00aaff', fn: (freq,vol)=>playNote(freq,'square',0.005,0.12,vol,3000) },
    { name:'AMBIENT',  type:'ambient',color:'#aa88ff', fn: (freq,vol)=>playAmbient(freq,vol) },
    { name:'GUITAR',   type:'guitar', color:'#00ffaa', fn: (freq,vol)=>playGuitar(freq,vol) },
    { name:'RIM',      type:'drum',   color:'#ff7799', fn: (freq,vol)=>playRim(vol) },
];

function typeClass(type) {
    return {drum:'t-drum',bass:'t-bass',synth:'t-synth',ambient:'t-ambient',guitar:'t-guitar'}[type] || 't-drum';
}

// ========== BUILD UI ==========
function buildAll() {
    // Calcola scale freqs
    const scaleFreqs = getScaleFreqs();
    
    tracks = TRACK_DEFS.map((def, i) => {
        const isDrum = def.type === 'drum';
        // Assegna frequenze di default per note
        const defaultFreqs = isDrum 
            ? Array(numSteps).fill(220)
            : Array(numSteps).fill(null).map((_,s) => scaleFreqs[s % scaleFreqs.length]);
        return {
            ...def,
            muted: false,
            soloed: false,
            active: Array(numSteps).fill(false),
            stepFreqs: defaultFreqs,
            vol: def.type === 'bass' ? 0.8 : def.type === 'drum' ? 0.7 : 0.5
        };
    });

    buildBeatLights();
    buildTracks();
}

function buildBeatLights() {
    const c = document.getElementById('beat-lights');
    c.innerHTML = '';
    beatLights = [];
    for (let i=0; i<numSteps; i++) {
        const el = document.createElement('div');
        el.className = 'beat-light';
        el.textContent = i+1;
        // Color groups of 4
        if (i % 4 === 0) el.style.borderColor = '#3a3a50';
        c.appendChild(el);
        beatLights.push(el);
    }
}

function buildTracks() {
    const c = document.getElementById('tracks-container');
    c.innerHTML = '';
    const scaleFreqs = getScaleFreqs();

    tracks.forEach((track, ti) => {
        const row = document.createElement('div');
        row.className = \`track-row ${typeClass(track.type)}\`;
        row.id = \`track-${ti}\`;

        // Name label
        const nameEl = document.createElement('div');
        nameEl.className = 'flex flex-col min-w-[72px]';
        nameEl.innerHTML = \`
            <span class="text-[10px] font-bold" style="color:${track.color}">${track.name}</span>
            <span class="text-[8px] text-zinc-600">${track.type.toUpperCase()}</span>
        \`;

        // Mute/Solo
        const muteBtn = document.createElement('button');
        muteBtn.className = 'mute-btn'; muteBtn.textContent = 'M';
        muteBtn.onclick = () => toggleMute(ti, muteBtn);

        const soloBtn = document.createElement('button');
        soloBtn.className = 'solo-btn'; soloBtn.textContent = 'S';
        soloBtn.onclick = () => toggleSolo(ti, soloBtn);

        // VU meter (solo per show)
        const vu = document.createElement('div');
        vu.className = 'vu-bar'; vu.style.width='24px';
        const vuFill = document.createElement('div');
        vuFill.className = 'vu-fill'; vuFill.id = \`vu-${ti}\`;
        vu.appendChild(vuFill);

        // Step cells
        const stepsDiv = document.createElement('div');
        stepsDiv.className = 'flex gap-1 flex-1';
        stepsDiv.id = \`steps-${ti}\`;

        for (let s=0; s<numSteps; s++) {
            const cell = document.createElement('div');
            cell.className = 'step-cell flex-1';
            cell.dataset.track = ti;
            cell.dataset.step = s;
            cell.textContent = (s % 4) + 1;
            // Group color
            if (s % 4 === 0) cell.style.borderLeftColor = '#4a4a5a';
            
            cell.onclick = () => {
                track.active[s] = !track.active[s];
                cell.classList.toggle('active', track.active[s]);
                if (track.active[s]) {
                    // Play preview
                    playTrack(ti, s);
                }
            };
            stepsDiv.appendChild(cell);
        }

        row.appendChild(nameEl);
        row.appendChild(muteBtn);
        row.appendChild(soloBtn);
        row.appendChild(stepsDiv);
        c.appendChild(row);
    });
}

function applyScale() {
    const scaleFreqs = getScaleFreqs();
    tracks.forEach((track, ti) => {
        if (track.type !== 'drum') {
            track.stepFreqs = Array(numSteps).fill(null).map((_,s) => scaleFreqs[s % scaleFreqs.length]);
        }
    });
}

// ========== MUTE / SOLO ==========
function toggleMute(ti, btn) {
    tracks[ti].muted = !tracks[ti].muted;
    btn.classList.toggle('muted', tracks[ti].muted);
}

function toggleSolo(ti, btn) {
    tracks[ti].soloed = !tracks[ti].soloed;
    btn.classList.toggle('soloed', tracks[ti].soloed);
}

function isTrackAudible(ti) {
    const anySolo = tracks.some(t => t.soloed);
    if (anySolo) return tracks[ti].soloed;
    return !tracks[ti].muted;
}

// ========== PLAY ==========
function playTrack(ti, step) {
    const track = tracks[ti];
    if (!track) return;
    const freq = track.stepFreqs ? track.stepFreqs[step] : 220;
    const vol = track.vol || 0.6;
    track.fn(freq, vol);
    // VU flash
    const vuEl = document.getElementById(\`vu-${ti}\`);
    if (vuEl) {
        vuEl.style.width = '100%';
        setTimeout(() => vuEl.style.width = '0%', 80);
    }
    // Pad flash
    const row = document.getElementById(\`track-${ti}\`);
    if (row) {
        row.classList.add('playing-row');
        setTimeout(() => row.classList.remove('playing-row'), 100);
    }
}

function tick() {
    // Update beat lights
    beatLights.forEach((l, i) => {
        l.classList.toggle('on', i === currentStep);
    });

    // Update step cells highlight
    document.querySelectorAll('.step-cell').forEach(c => {
        c.classList.remove('playing');
        if (parseInt(c.dataset.step) === currentStep) c.classList.add('playing');
    });

    // Play active steps
    tracks.forEach((track, ti) => {
        if (track.active[currentStep] && isTrackAudible(ti)) {
            playTrack(ti, currentStep);
        }
    });

    currentStep = (currentStep + 1) % numSteps;
}

function togglePlay() {
    resumeAudio();
    if (isPlaying) {
        stopAll(false);
    } else {
        isPlaying = true;
        currentStep = 0;
        document.getElementById('play-btn').textContent = '‚óº STOP';
        document.getElementById('play-btn').classList.add('play-active');
        const ms = (60000 / bpm) / 4; // 16th notes
        tick();
        intervalId = setInterval(tick, ms);
    }
}

function stopAll(resetStep=true) {
    if (intervalId) { clearInterval(intervalId); intervalId = null; }
    isPlaying = false;
    document.getElementById('play-btn').textContent = '‚ñ∂ START';
    document.getElementById('play-btn').classList.remove('play-active');
    beatLights.forEach(l => l.classList.remove('on'));
    document.querySelectorAll('.step-cell').forEach(c => c.classList.remove('playing'));
    if (resetStep) currentStep = 0;
}

function updateBPM() {
    bpm = parseInt(document.getElementById('bpm-slider').value);
    document.getElementById('bpm-display').textContent = bpm;
    if (isPlaying) {
        stopAll(false);
        const ms = (60000 / bpm) / 4;
        intervalId = setInterval(tick, ms);
        isPlaying = true;
    }
}

function changeBPM(delta) {
    const slider = document.getElementById('bpm-slider');
    slider.value = Math.min(240, Math.max(40, parseInt(slider.value) + delta));
    updateBPM();
}

function setMasterVol(val) {
    if (masterGain) masterGain.gain.value = val / 100;
    else if (audioCtx) masterGain.gain.value = val/100;
}

function setSteps(n) {
    numSteps = n;
    document.querySelectorAll('.div-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(\`div${n}\`).classList.add('active');
    tracks.forEach(t => {
        if (t.active.length < n) {
            t.active = [...t.active, ...Array(n - t.active.length).fill(false)];
            t.stepFreqs = [...t.stepFreqs, ...Array(n - t.stepFreqs.length).fill(t.stepFreqs[0] || 220)];
        } else {
            t.active = t.active.slice(0, n);
            t.stepFreqs = t.stepFreqs.slice(0, n);
        }
    });
    if (currentStep >= n) currentStep = 0;
    buildBeatLights();
    rebuildStepCells();
}

function rebuildStepCells() {
    tracks.forEach((track, ti) => {
        const stepsDiv = document.getElementById(\`steps-${ti}\`);
        if (!stepsDiv) return;
        stepsDiv.innerHTML = '';
        for (let s=0; s<numSteps; s++) {
            const cell = document.createElement('div');
            cell.className = \`step-cell flex-1 ${track.active[s] ? 'active' : ''}\`;
            cell.dataset.track = ti;
            cell.dataset.step = s;
            cell.textContent = (s % 4) + 1;
            if (s % 4 === 0) cell.style.borderLeftColor = '#4a4a5a';
            cell.onclick = () => {
                track.active[s] = !track.active[s];
                cell.classList.toggle('active', track.active[s]);
                if (track.active[s]) playTrack(ti, s);
            };
            stepsDiv.appendChild(cell);
        }
    });
}

function randomPattern() {
    resumeAudio();
    tracks.forEach((track, ti) => {
        const density = track.type === 'drum' ? 0.25 : 0.15;
        track.active = track.active.map(() => Math.random() < density);
    });
    // Assicura kick sempre su 1
    if (tracks[0]) { tracks[0].active[0] = true; tracks[0].active[8] = Math.random() > 0.5; }
    rebuildStepCells();
}

function clearAll() {
    tracks.forEach(t => t.active = Array(numSteps).fill(false));
    rebuildStepCells();
}

// ========== INIT ==========
window.addEventListener('load', () => {
    buildAll();
    // Default funky pattern dimostrativo
    setTimeout(() => {
        const demo = [
            [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0], // KICK
            [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,1], // SNARE
            [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0], // HIHAT
            [0,0,0,0, 0,0,0,1, 0,0,0,0, 0,0,0,0], // OPEN HAT
            [0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,0,0], // CLAP
            [0,0,0,1, 0,0,0,0, 0,0,1,0, 0,0,0,0], // TOM HI
            [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,1,0], // TOM LO
            [0,1,0,0, 0,1,0,0, 0,1,0,0, 0,1,0,0], // SHAKER
            [1,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,0,0], // BASS
            [0,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0], // SUB
            [0,0,1,0, 0,0,0,0, 0,1,0,0, 0,0,0,0], // SYNTH LD
            [1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0], // SYNTH PAD
            [0,1,0,1, 0,1,0,0, 0,0,0,1, 0,1,0,0], // ARPEGGIO
            [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0], // AMBIENT
            [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0], // GUITAR
            [0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0], // RIM
        ];
        demo.forEach((pat, ti) => {
            if (tracks[ti]) tracks[ti].active = pat.map(v => v===1);
        });
        rebuildStepCells();
    }, 100);
});
<\/script>
</body>
</html>`,
};

window.MaracaHost = (() => {
  const titles = {
    ACC: "01 ‚Ä¢ Accordatore (ACC1)",
    LOOP: "02 ‚Ä¢ Loop (LOOP1)",
    DJ: "03 ‚Ä¢ DJ (DJ1)",
    SYNTH: "04 ‚Ä¢ Synth (SYNTH1)",
    SEQ: "05 ‚Ä¢ Sequencer (SEQ1)",
  };
  const priority = { ACC: 2, LOOP: 1, DJ: 0, SYNTH: 0, SEQ: 0 };

  let ctx = null;
  let masterGain = null;
  const sectionGain = new Map();
  let activeId = null;

  let micOwner = null;
  let micStream = null;

  const modal = document.getElementById('modal');
  const frame = document.getElementById('appFrame');
  const modalTitle = document.getElementById('modalTitle');
  const modalHint = document.getElementById('modalHint');
  const audDot = document.getElementById('audDot');
  const audState = document.getElementById('audState');
  const micDot = document.getElementById('micDot');
  const micState = document.getElementById('micState');
  const toast = document.getElementById('toast');
  const toastT = document.getElementById('toastT');
  const toastM = document.getElementById('toastM');

  function toastMsg(title, msg) {
    toastT.textContent = title;
    toastM.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toast.classList.remove('show'), 5200);
  }

  function ensureAudio() {
    if (ctx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    ctx = new AC();
    masterGain = ctx.createGain();
    masterGain.gain.value = 0.80;
    masterGain.connect(ctx.destination);

    ["ACC","LOOP","DJ","SYNTH","SEQ"].forEach(id => {
      const g = ctx.createGain();
      g.gain.value = 1.0;
      g.connect(masterGain);
      sectionGain.set(id, g);
    });
    updateAudioUI();
  }

  function updateAudioUI() {
    const isOn = !!ctx && ctx.state !== 'closed';
    audDot.classList.toggle('on', isOn && ctx.state === 'running');
    audState.textContent = !ctx ? "OFF" : ctx.state.toUpperCase();
    micDot.classList.toggle('on', !!micStream);
    micState.textContent = micOwner ? ("IN USO: " + micOwner) : "LIBERO";
  }

  async function resumeAudio() {
    try {
      ensureAudio();
      if (ctx.state === 'suspended') await ctx.resume();
      updateAudioUI();
      toastMsg("Audio", "Audio attivato con successo!");
    } catch(e) {
      toastMsg("Audio", "Impossibile avviare l'audio: " + (e?.message || e));
    }
  }

  function setMaster(v) {
    ensureAudio();
    const x = Math.max(0, Math.min(100, Number(v))) / 100;
    masterGain.gain.value = x;
    document.getElementById('masterVal').textContent = Math.round(x*100) + "%";
  }

  function setSectionGain(id, v) {
    ensureAudio();
    const g = sectionGain.get(id);
    if (!g) return;
    const x = Math.max(0, Math.min(100, Number(v))) / 100;
    g.gain.value = x;
    const el = document.getElementById('g' + id + 'Val');
    if (el) el.textContent = Math.round(x*100) + "%";
  }

  function getAudioProxy(id) {
    ensureAudio();
    const g = sectionGain.get(id) || masterGain;
    const proxy = new Proxy(ctx, {
      get(target, prop) {
        if (prop === 'destination') return g;
        const v = target[prop];
        return (typeof v === 'function') ? v.bind(target) : v;
      }
    });
    return proxy;
  }

  async function requestMic(id, constraints) {
    await resumeAudio();
    const md = navigator.mediaDevices;
    if (!md || !md.getUserMedia) throw new Error("getUserMedia non supportato");

    if (micOwner && micOwner !== id) {
      const prNew = priority[id] ?? 0;
      const prCur = priority[micOwner] ?? 0;
      if (prNew > prCur) {
        await releaseMic(true);
      } else {
        toastMsg("Microfono occupato", `Il microfono √® gi√† in uso da ${micOwner}. Chiudi quella sezione o premi ‚ÄúRILASCIA MIC‚Äù.`);
        throw new Error("Microfono occupato da " + micOwner);
      }
    }

    if (!micStream) {
      micStream = await md.getUserMedia(constraints || { audio:true });
    }
    micOwner = id;
    updateAudioUI();
    return micStream;
  }

  async function releaseMic(silent=false) {
    try {
      if (micStream) micStream.getTracks().forEach(t => t.stop());
    } catch(e) {}
    micStream = null;
    micOwner = null;
    updateAudioUI();
    if (!silent) toastMsg("Microfono", "Microfono rilasciato.");
  }

  function open(id) {
    ensureAudio(); // Assicura che l'audio sia inizializzato all'apertura
    activeId = id;
    modalTitle.textContent = titles[id] || id;
    modalHint.textContent = "Popup ‚Ä¢ Chiudi per tornare al mixer";
    modal.classList.add('show');

    if (frame.dataset.active !== id) {
      frame.dataset.active = id;
      frame.srcdoc = __SECTION_HTML__[id];
    }
  }

  function close() {
    modal.classList.remove('show');
  }

  function reloadActive() {
    if (!activeId) return;
    frame.srcdoc = __SECTION_HTML__[activeId];
    toastMsg("Sezione riavviata", (titles[activeId] || activeId) + " √® stata ricaricata.");
  }

  // Inizializza l'audio immediatamente
  ensureAudio();
  
  // Aggiorna UI periodicamente
  setInterval(updateAudioUI, 500);

  return {
    open, close, reloadActive,
    resumeAudio,
    setMaster,
    setSectionGain,
    requestMic,
    releaseMic,
    getAudioProxy,
  };
})();

// Avvia l'audio automaticamente al primo click sull'iframe
document.addEventListener('DOMContentLoaded', () => {
  // Inizializza audio al caricamento della pagina
  MaracaHost.resumeAudio();
  
  // Aggiungi listener per gestire il click sul documento per sbloccare l'audio
  document.addEventListener('click', () => {
    MaracaHost.resumeAudio();
  }, { once: true });
  
  // Gestisce il primo tocco su mobile
  document.addEventListener('touchstart', () => {
    MaracaHost.resumeAudio();
  }, { once: true });
  
  // Aggiorna i valori degli slider
  const sliders = document.querySelectorAll('input[type="range"]');
  sliders.forEach(slider => {
    slider.addEventListener('input', function() {
      const label = this.nextElementSibling;
      if (label && label.tagName === 'SPAN') {
        label.textContent = this.value + '%';
      }
    });
  });
});

// Gestisce lo stato dell'audio quando la pagina diventa visibile
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    MaracaHost.resumeAudio();
  }
});
</script>
</body>
</html>
